[
    {
        "id": "c13c59039e2f8fa1",
        "type": "tab",
        "label": "Strategy Sell v4.5.0",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "df603feb9a271454",
        "type": "group",
        "z": "c13c59039e2f8fa1",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "243df0e744767d7f",
            "d65f8a320bb07ec9",
            "d83c21b040282923"
        ],
        "x": 34,
        "y": 99,
        "w": 192,
        "h": 162
    },
    {
        "id": "198fe8fcdfc0a131",
        "type": "group",
        "z": "c13c59039e2f8fa1",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "ac36262a3378da77",
            "39c4524354c7ee78",
            "0f5608cf091428c5"
        ],
        "x": 34,
        "y": 479,
        "w": 192,
        "h": 142
    },
    {
        "id": "d6839bc356662bff",
        "type": "group",
        "z": "c13c59039e2f8fa1",
        "name": "Export routine",
        "style": {
            "fill-opacity": "0.5",
            "label": true,
            "color": "#cccccc"
        },
        "nodes": [
            "237f3c803b8a6018",
            "7a8438245db0608e",
            "24b32420f46eff8f",
            "b5c484660bab6a02",
            "f1841ed7e129ba54",
            "d6cbf4eb3b2b254c",
            "1c7e3a2eef3351f6",
            "92c92c615f79307c"
        ],
        "x": 254,
        "y": 319,
        "w": 832,
        "h": 182
    },
    {
        "id": "c362adfa854cd5a6",
        "type": "group",
        "z": "c13c59039e2f8fa1",
        "name": "Decide export or stop",
        "style": {
            "label": true
        },
        "nodes": [
            "9c40b2abb695d6e0",
            "dfe96d1588e67b8b",
            "26cdddafaed8d5f9",
            "87257608f2ee3b0a",
            "72aef1eb7be3adc3",
            "706b520555896d5c",
            "f6abbba2292a3d8d",
            "7e3407a3531313fb",
            "c99ef1caace84785",
            "b0af910ab27d1de0",
            "4412646970888c4c",
            "696aab62ab5dee43",
            "85329930aa6460b5",
            "e1ad94583905cc65",
            "075ea83e691f5361",
            "c66c1146cef0e3a2",
            "aa61354a8369630c",
            "978b3a5e19712487",
            "1ee34a8ef5df6cd5"
        ],
        "x": 254,
        "y": 79,
        "w": 1838,
        "h": 207
    },
    {
        "id": "782cedbf725dba15",
        "type": "group",
        "z": "c13c59039e2f8fa1",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "817f47b51aa46769",
            "ca7b28e62b9e2503",
            "ecfecf79c5234dfd"
        ],
        "x": 34,
        "y": 379,
        "w": 182,
        "h": 82
    },
    {
        "id": "1ee34a8ef5df6cd5",
        "type": "group",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "UI helper | set bounds for charge levels",
        "style": {
            "label": true,
            "stroke": "#3f93cf"
        },
        "nodes": [
            "dac49a4d73a51382",
            "7664e7ccba4f98f1",
            "984f63410ebf7021"
        ],
        "x": 1394,
        "y": 159,
        "w": 672,
        "h": 82
    },
    {
        "id": "978b3a5e19712487",
        "type": "junction",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "x": 1440,
        "y": 260,
        "wires": [
            [
                "24b32420f46eff8f"
            ]
        ]
    },
    {
        "id": "2842e5d5f6887949",
        "type": "comment",
        "z": "c13c59039e2f8fa1",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 140,
        "y": 60,
        "wires": []
    },
    {
        "id": "243df0e744767d7f",
        "type": "link in",
        "z": "c13c59039e2f8fa1",
        "g": "df603feb9a271454",
        "name": "Sell",
        "links": [],
        "x": 110,
        "y": 220,
        "wires": [
            [
                "d83c21b040282923"
            ]
        ],
        "l": true
    },
    {
        "id": "d65f8a320bb07ec9",
        "type": "comment",
        "z": "c13c59039e2f8fa1",
        "g": "df603feb9a271454",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 130,
        "y": 140,
        "wires": []
    },
    {
        "id": "d83c21b040282923",
        "type": "change",
        "z": "c13c59039e2f8fa1",
        "g": "df603feb9a271454",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 180,
        "wires": [
            [
                "aa61354a8369630c"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "ac36262a3378da77",
        "type": "link out",
        "z": "c13c59039e2f8fa1",
        "g": "198fe8fcdfc0a131",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 185,
        "y": 580,
        "wires": []
    },
    {
        "id": "39c4524354c7ee78",
        "type": "comment",
        "z": "c13c59039e2f8fa1",
        "g": "198fe8fcdfc0a131",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 130,
        "y": 520,
        "wires": []
    },
    {
        "id": "237f3c803b8a6018",
        "type": "function",
        "z": "c13c59039e2f8fa1",
        "g": "d6839bc356662bff",
        "name": "Max power solution",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\nlog(this, \"Discharge at **max. power**\");\n\n// INPUT\nlet batteries = msg.batteries;\nlet solution_array = [];\n\n// build solution\nmsg.batteries.forEach(battery => {\n    const calculatedPower = Number(battery.discharging_max);\n\n    solution_array.push({\n        id: battery.id,\n        mode: \"discharge\",\n        power: calculatedPower\n    });\n\n});\n\n// return solution\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 360,
        "wires": [
            [
                "1c7e3a2eef3351f6"
            ]
        ]
    },
    {
        "id": "7a8438245db0608e",
        "type": "link call",
        "z": "c13c59039e2f8fa1",
        "g": "d6839bc356662bff",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 780,
        "y": 400,
        "wires": [
            [
                "b5c484660bab6a02",
                "92c92c615f79307c"
            ]
        ]
    },
    {
        "id": "24b32420f46eff8f",
        "type": "switch",
        "z": "c13c59039e2f8fa1",
        "g": "d6839bc356662bff",
        "name": "Export at max power",
        "property": "grid_power_has_limit_export",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 380,
        "y": 380,
        "wires": [
            [
                "237f3c803b8a6018"
            ],
            [
                "d6cbf4eb3b2b254c"
            ]
        ]
    },
    {
        "id": "b5c484660bab6a02",
        "type": "debug",
        "z": "c13c59039e2f8fa1",
        "g": "d6839bc356662bff",
        "name": "Regulated",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 970,
        "y": 400,
        "wires": []
    },
    {
        "id": "f1841ed7e129ba54",
        "type": "debug",
        "z": "c13c59039e2f8fa1",
        "g": "d6839bc356662bff",
        "name": "Maximum",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 960,
        "y": 360,
        "wires": []
    },
    {
        "id": "d6cbf4eb3b2b254c",
        "type": "function",
        "z": "c13c59039e2f8fa1",
        "g": "d6839bc356662bff",
        "name": "Regulated power",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// Which sub-strategy to use\nmsg.target = \"Self-consumption\";\n\n// Grid power limit\nconst targetGridPower = parseInt(msg.grid_power_limit_export);\n\n// Set target grid consumption for the PID controller\nmsg.house_target_grid_consumption_in_w = -targetGridPower; // negative, we are exporting to grid.\n// tell PID to avoid charge solutions during Selling.\nRED.util.setMessageProperty(msg,\"advanced_settings.charge_disabled\",true,true);\n\n// Finally\nlog(this, `**Regulated** discharging. Target grid power: ${Math.floor(targetGridPower)} W`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 400,
        "wires": [
            [
                "7a8438245db0608e"
            ]
        ]
    },
    {
        "id": "1c7e3a2eef3351f6",
        "type": "change",
        "z": "c13c59039e2f8fa1",
        "g": "d6839bc356662bff",
        "name": "Continue",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Charge",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 360,
        "wires": [
            [
                "f1841ed7e129ba54",
                "92c92c615f79307c"
            ]
        ]
    },
    {
        "id": "dac49a4d73a51382",
        "type": "function",
        "z": "c13c59039e2f8fa1",
        "g": "1ee34a8ef5df6cd5",
        "name": "Min/max",
        "func": "\n// Lower bound\nlet output = msg.sell.threshold_energy | 0; // kWh\noutput = Math.max(output, 0);\n\n// Upper bound\nlet max_reserve = 0; // kWh\nmsg.batteries.forEach(battery => {\n    max_reserve += (Number(battery.energy_max*battery.soc_max) - Number(battery.energy_max*battery.soc_min))/100; // kWh\n});\noutput = Math.min(output, max_reserve);\n\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\n\n// Output\nmsg.payload = output;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1720,
        "y": 200,
        "wires": [
            [
                "7664e7ccba4f98f1"
            ]
        ]
    },
    {
        "id": "7664e7ccba4f98f1",
        "type": "api-call-service",
        "z": "c13c59039e2f8fa1",
        "g": "1ee34a8ef5df6cd5",
        "name": "Set desired energy reserve",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_sell_target_energy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.payload}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1920,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "984f63410ebf7021",
        "type": "rbe",
        "z": "c13c59039e2f8fa1",
        "g": "1ee34a8ef5df6cd5",
        "name": "Desired energy changed",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 1530,
        "y": 200,
        "wires": [
            [
                "dac49a4d73a51382"
            ]
        ]
    },
    {
        "id": "c66c1146cef0e3a2",
        "type": "api-current-state",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Goal",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_sell_goal",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.goal",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 180,
        "wires": [
            [
                "075ea83e691f5361"
            ]
        ]
    },
    {
        "id": "075ea83e691f5361",
        "type": "switch",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Sell until",
        "property": "sell.goal",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "batteries are empty",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "state of charge",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "energy reserve",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 4,
        "x": 580,
        "y": 180,
        "wires": [
            [
                "7e3407a3531313fb"
            ],
            [
                "72aef1eb7be3adc3"
            ],
            [
                "26cdddafaed8d5f9"
            ],
            [
                "9c40b2abb695d6e0"
            ]
        ]
    },
    {
        "id": "9c40b2abb695d6e0",
        "type": "function",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Unknown -> Full stop",
        "func": "const log = global.get(\"logger\");\n\n// Unkown export goal\nlog(this, `**${msg.sell.goal}**; Sell goal not recognized. Fallback to **Full Stop**`,\"warn\");\n\n// Full stop\nmsg.target = \"Full stop\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 240,
        "wires": [
            [
                "dfe96d1588e67b8b"
            ]
        ]
    },
    {
        "id": "aa61354a8369630c",
        "type": "function",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Init",
        "func": "msg.sell = {};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "c66c1146cef0e3a2"
            ]
        ]
    },
    {
        "id": "dfe96d1588e67b8b",
        "type": "link call",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 940,
        "y": 240,
        "wires": [
            [
                "87257608f2ee3b0a"
            ]
        ]
    },
    {
        "id": "26cdddafaed8d5f9",
        "type": "api-current-state",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Energy reserve low",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_sell_target_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.threshold_energy",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 750,
        "y": 200,
        "wires": [
            [
                "706b520555896d5c"
            ]
        ]
    },
    {
        "id": "0f5608cf091428c5",
        "type": "link in",
        "z": "c13c59039e2f8fa1",
        "g": "198fe8fcdfc0a131",
        "name": "link to End",
        "links": [
            "87257608f2ee3b0a",
            "85329930aa6460b5",
            "92c92c615f79307c"
        ],
        "x": 75,
        "y": 580,
        "wires": [
            [
                "ac36262a3378da77"
            ]
        ]
    },
    {
        "id": "87257608f2ee3b0a",
        "type": "link out",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "go to End",
        "mode": "link",
        "links": [
            "0f5608cf091428c5"
        ],
        "x": 1140,
        "y": 240,
        "wires": [],
        "l": true
    },
    {
        "id": "72aef1eb7be3adc3",
        "type": "api-current-state",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "SoC low",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_sell_target_soc",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.threshold_soc",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 720,
        "y": 160,
        "wires": [
            [
                "f6abbba2292a3d8d"
            ]
        ]
    },
    {
        "id": "706b520555896d5c",
        "type": "function",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Check if low",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Sell until: ${msg.sell.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nvar energy_threshold = Number(RED.util.getMessageProperty(msg,\"sell.threshold_energy\"));\nif (energy_threshold === undefined || energy_threshold < 0){\n    log(this,`Desired energy reserve not set correctly '${energy_threshold}' kWh`,\"warn\");\n    energy_threshold = 0;\n}\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining <= energy_threshold) {\n    msg.sell.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.sell.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.sell.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 200,
        "wires": [
            [
                "e1ad94583905cc65",
                "984f63410ebf7021"
            ]
        ]
    },
    {
        "id": "f6abbba2292a3d8d",
        "type": "function",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Check if low",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this, `Sell until: ${msg.sell.goal}`);\n\n// 2. Extract average SoC and desired SoC level\nlet batteries = msg.batteries;\nlet soc_avg = 0;\nlet count = 0; // could use msg.battery_count\nbatteries.forEach(battery => {\n    soc_avg += battery.soc;\n    count++;\n});\n// 2a.  Current avg. SoC\nsoc_avg = Math.round(soc_avg / count * 100) / 100;\n// 2b.  Sell until SoC (12% as fallback)\nvar soc_threshold = Number(RED.util.getMessageProperty(msg,\"sell.threshold_soc\"));\nif (soc_threshold === undefined || soc_threshold < 12){\n    log(this, `Desired SoC not set correctly '${soc_threshold}' %. I've set it to 12%.`,\"warn\");\n    soc_threshold = 12;\n}\n\n// 3. Logic: Determine if SoC level is at or below desired level\nif (soc_avg <= msg.payload) {\n    msg.sell.threshold_reached = true;\n\n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n\n    // User friendly feedback via the custom logger\n    log(this, `[OK] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({\n    fill: msg.sell.threshold_reached ? \"red\" : \"green\",\n    shape: \"dot\",\n    text: `Threshold reached: ${msg.sell.threshold_reached}`\n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 160,
        "wires": [
            [
                "e1ad94583905cc65"
            ]
        ]
    },
    {
        "id": "7e3407a3531313fb",
        "type": "change",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Batteries are empty",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 120,
        "wires": [
            [
                "c99ef1caace84785"
            ]
        ]
    },
    {
        "id": "c99ef1caace84785",
        "type": "function",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Check if empty",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Sell until: ${msg.sell.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining <= 0) {\n    msg.sell.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] All batteries are empty or at SoC_min_ (${energy_remaining} kWh).`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Battery level ${energy_remaining.toFixed(2)} kWh above 0 kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.sell.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.sell.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 960,
        "y": 120,
        "wires": [
            [
                "e1ad94583905cc65"
            ]
        ]
    },
    {
        "id": "b0af910ab27d1de0",
        "type": "switch",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Until reached",
        "property": "sell.threshold_reached",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1290,
        "y": 160,
        "wires": [
            [
                "4412646970888c4c"
            ],
            [
                "978b3a5e19712487"
            ]
        ]
    },
    {
        "id": "4412646970888c4c",
        "type": "function",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Yes -> Full stop",
        "func": "\nmsg.target = \"Full stop\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1520,
        "y": 120,
        "wires": [
            [
                "696aab62ab5dee43"
            ]
        ]
    },
    {
        "id": "696aab62ab5dee43",
        "type": "link call",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 1680,
        "y": 120,
        "wires": [
            [
                "85329930aa6460b5"
            ]
        ]
    },
    {
        "id": "85329930aa6460b5",
        "type": "link out",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "go to End",
        "mode": "link",
        "links": [
            "0f5608cf091428c5"
        ],
        "x": 1820,
        "y": 120,
        "wires": [],
        "l": true
    },
    {
        "id": "e1ad94583905cc65",
        "type": "function",
        "z": "c13c59039e2f8fa1",
        "g": "c362adfa854cd5a6",
        "name": "Decided",
        "func": "const log = global.get(\"logger\");\n\nif(msg.sell.threshold_reached){\n    log(this,`Stop discharging, Sell until ${msg.sell.goal} reached.`);\n} else {\n    log(this,`Continue discharging.`);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1140,
        "y": 160,
        "wires": [
            [
                "b0af910ab27d1de0"
            ]
        ]
    },
    {
        "id": "92c92c615f79307c",
        "type": "link out",
        "z": "c13c59039e2f8fa1",
        "g": "d6839bc356662bff",
        "name": "go to End",
        "mode": "link",
        "links": [
            "0f5608cf091428c5"
        ],
        "x": 960,
        "y": 460,
        "wires": [],
        "l": true
    },
    {
        "id": "817f47b51aa46769",
        "type": "catch",
        "z": "c13c59039e2f8fa1",
        "g": "782cedbf725dba15",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 75,
        "y": 420,
        "wires": [
            [
                "ca7b28e62b9e2503"
            ]
        ],
        "l": false
    },
    {
        "id": "ca7b28e62b9e2503",
        "type": "function",
        "z": "c13c59039e2f8fa1",
        "g": "782cedbf725dba15",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 125,
        "y": 420,
        "wires": [
            [
                "ecfecf79c5234dfd"
            ]
        ],
        "l": false
    },
    {
        "id": "ecfecf79c5234dfd",
        "type": "link out",
        "z": "c13c59039e2f8fa1",
        "g": "782cedbf725dba15",
        "name": "link out 2",
        "mode": "return",
        "links": [],
        "x": 175,
        "y": 420,
        "wires": []
    },
    {
        "id": "176d29a.6f648d6",
        "type": "server",
        "name": "Home Assistant",
        "addon": true,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": "",
        "connectionDelay": false,
        "cacheJson": false,
        "heartbeat": false,
        "heartbeatInterval": "",
        "statusSeparator": "",
        "enableGlobalContextStore": false
    },
    {
        "id": "b9f2077ec123bbbe",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.80.3"
        }
    }
]