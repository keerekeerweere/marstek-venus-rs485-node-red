[
    {
        "id": "6d6573264ad03a3a",
        "type": "tab",
        "label": "Home Battery Start v4.5.0",
        "disabled": false,
        "info": "# Home battery control\r\nConsists of three flows:\r\n 1.  Start flow\r\n 1.  Control flow\r\n 1.  Master switch flow\r\n\r\n## Start flow\r\nThis is the starting point of your home battery control.\r\n\r\nIt starts with P1 measurement as a trigger.\r\nIt allows you to connect your battery sensors to the flow.\r\nIt ends with a function node, mapping your batteries to a battery_array\r\n\r\nThe battery_array is passed on to the control flow.\r\n\r\nWhen the control flow has calculated the desired corrections,\r\nit is passed back to this flow and applied to your batteries.",
        "env": []
    },
    {
        "id": "60b5d8044cd240a3",
        "type": "tab",
        "label": "Home Battery Master Switch",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "f13f7130a1bda6e5",
        "type": "tab",
        "label": "Home Battery PID presets",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "f83cd63ed7d0d814",
        "type": "tab",
        "label": "Strategy Charge PV v4.5.0",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "7a1a1938a7272ee4",
        "type": "tab",
        "label": "Strategy Charge v4.5.0",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "40f4cc790d5ae165",
        "type": "tab",
        "label": "Strategy Dynamic v4.5.0",
        "disabled": false,
        "info": "Dynamic contract automated management",
        "env": []
    },
    {
        "id": "e2e92ce99c1547de",
        "type": "tab",
        "label": "Strategy Full stop v4.5.0",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "5d26e71db8139b01",
        "type": "tab",
        "label": "Strategy Self-consumption v4.5.0",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "e5380aeea0a0d937",
        "type": "tab",
        "label": "Strategy Sell v4.5.0",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "d94f748bb075b041",
        "type": "tab",
        "label": "Strategy Timed v4.5.0",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "d608a4a32e0df080",
        "type": "group",
        "z": "60b5d8044cd240a3",
        "name": "Marstek master control switch",
        "style": {
            "label": true
        },
        "nodes": [
            "b49db4d0a798f164",
            "5321fe5ab7f757a6",
            "3cc99e704b42536a",
            "052a65658a9d42a7",
            "880b4bd707f6cd0b"
        ],
        "x": 34,
        "y": 19,
        "w": 898,
        "h": 382
    },
    {
        "id": "7079a558e93bec2b",
        "type": "group",
        "z": "f13f7130a1bda6e5",
        "name": "PID presets",
        "style": {
            "label": true
        },
        "nodes": [
            "81f3b4928caf43d3",
            "5c4059cc4c601488",
            "e8f07307252629ab",
            "8b2d473346c90dd3",
            "995a5b9d3081cc07",
            "212a37e25ff47b65",
            "e7afca1d4d663337"
        ],
        "x": 34,
        "y": 19,
        "w": 632,
        "h": 242
    },
    {
        "id": "b233a9c4848f7142",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Start",
        "style": {
            "label": true,
            "stroke": "#009ac7"
        },
        "nodes": [
            "c5a560e8805a3490",
            "60b289e22e2faeac",
            "abda411cd23fa61e"
        ],
        "x": 34,
        "y": 19,
        "w": 652,
        "h": 82
    },
    {
        "id": "a97e9944723199fb",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Strategy selection",
        "style": {
            "label": true
        },
        "nodes": [
            "e90efd5896b1c62e",
            "809ba00b022b204d",
            "1ffd9eb1ed9e17db",
            "54c0823786fcf69e",
            "ec0fe5c5b9f481ec",
            "8eda290fc8979d34",
            "81af9004a8886111",
            "1ee5caeed0824366"
        ],
        "x": 34,
        "y": 939,
        "w": 852,
        "h": 162
    },
    {
        "id": "2543e6b29ae7693e",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Get batteries information",
        "style": {
            "label": true
        },
        "nodes": [
            "dc01bc5909a705c8",
            "d7dea4b181dc94d5",
            "1f8bb926afaf2fcd",
            "b1815487134bfc84",
            "95256b97b46131d4",
            "d749eb0fd520baf4",
            "27d26635ccde69cf",
            "52de7f4fd5117e6e"
        ],
        "x": 34,
        "y": 379,
        "w": 1678,
        "h": 242
    },
    {
        "id": "8267344b22de78fa",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "On deploy and global logger",
        "style": {
            "label": true,
            "stroke": "#92d04f"
        },
        "nodes": [
            "0d5e5f7418e6d09a",
            "383f47d55f5f03c7",
            "dfd59246e01132df"
        ],
        "x": 1294,
        "y": 19,
        "w": 592,
        "h": 82
    },
    {
        "id": "0964eecbbf0f7e7a",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Set Batteries",
        "style": {
            "label": true
        },
        "nodes": [
            "d0d1c004d897b2c2",
            "fd8d01afd97db3f1",
            "5201e7a62283c39e",
            "1a882b0a8dc7eb70",
            "964a53680eb4e096",
            "3b3ce39b596bb8aa",
            "890fc9c1620e7264"
        ],
        "x": 34,
        "y": 1119,
        "w": 858,
        "h": 342
    },
    {
        "id": "d0377d9db7f88ba2",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Battery priority",
        "style": {
            "label": true
        },
        "nodes": [
            "5630d7df55c386bb",
            "494ac73459afb551",
            "19095a51a37549b6",
            "abc780d1e6ca22b1",
            "3924bee9d981832b",
            "36501aa6b920ad81",
            "36d7e0f54b414907",
            "d35dfc4414bdb947",
            "ceb9a9a8de8079f3"
        ],
        "x": 34,
        "y": 739,
        "w": 1852,
        "h": 82
    },
    {
        "id": "b6ffa420a5b0ad36",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Calculate totals",
        "style": {
            "label": true
        },
        "nodes": [
            "f24873861a68e30e"
        ],
        "x": 34,
        "y": 639,
        "w": 212,
        "h": 82
    },
    {
        "id": "88fcf7fce2bcee4a",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Rate limiter",
        "style": {
            "label": true
        },
        "nodes": [
            "fba8ee89ee4b48fc",
            "62462fbde509f093",
            "68784b26a71554df",
            "6a8a3772d3097e4f",
            "bad0d99aae2e98d9",
            "fec3163cf6e896b0",
            "24d61d6a6d2cd81c",
            "324924b135aee546",
            "086ab78b88da7870",
            "ab8c8ba194b61d31"
        ],
        "x": 34,
        "y": 219,
        "w": 1402,
        "h": 122
    },
    {
        "id": "9ee535cb3eb4e7de",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Update UI: debug dashboard",
        "style": {
            "label": true,
            "stroke": "#3f5787"
        },
        "nodes": [
            "a0d759138bea0dff",
            "6eb943fb97982e10",
            "c13af3530f6f620f",
            "ea1ec88bd07ed287",
            "11c3f338273ae27c",
            "bd98c464479e7091"
        ],
        "x": 1234,
        "y": 1319,
        "w": 632,
        "h": 202
    },
    {
        "id": "049c8c835e1ec5bd",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Update UI: usable energy",
        "style": {
            "label": true,
            "stroke": "#3f5787"
        },
        "nodes": [
            "e29a618451ef3414",
            "aa85c75b8774df54"
        ],
        "x": 1474,
        "y": 639,
        "w": 412,
        "h": 82
    },
    {
        "id": "e665b7fd4de79095",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Update UI: active sub-strategy",
        "style": {
            "label": true,
            "stroke": "#3f5787"
        },
        "nodes": [
            "dc9da6c1bd3fc1aa",
            "56abef824695d21f",
            "44fd249c78ab67bd"
        ],
        "x": 1254,
        "y": 1019,
        "w": 632,
        "h": 82
    },
    {
        "id": "5ec74f315607b21a",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Insight",
        "style": {
            "label": true
        },
        "nodes": [
            "4bc60310535b5527",
            "87d556b9aa8e2018",
            "a223b27d5a82c21f",
            "32b488cab4768a25",
            "7e21d1cc2f826d01",
            "aba9ea9f8ab8f722"
        ],
        "x": 34,
        "y": 119,
        "w": 892,
        "h": 82
    },
    {
        "id": "898b7b1dab809dca",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Log and Error handling",
        "style": {
            "stroke": "#ff3f3f",
            "label": true
        },
        "nodes": [
            "7ed978df24edaebe",
            "c6d63f7293decd42"
        ],
        "x": 1634,
        "y": 119,
        "w": 252,
        "h": 142
    },
    {
        "id": "4dc546f97d680fb2",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "750202927e4513df",
            "25a27f5620d0354b",
            "bfde4771b0ea78bf"
        ],
        "x": 1704,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "3ebe5e0624e2e1bf",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "name": "Peak shave settings",
        "style": {
            "label": true
        },
        "nodes": [
            "7663aa8bf97d6dff",
            "4e88791ddce0c6b1",
            "20b518c724e8297f",
            "c24efbb623d003f5"
        ],
        "x": 34,
        "y": 839,
        "w": 752,
        "h": 82
    },
    {
        "id": "73f736190ffadcc1",
        "type": "group",
        "z": "f83cd63ed7d0d814",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "18d05bd09ef21e2e",
            "57e5da87485c45f0"
        ],
        "x": 1184,
        "y": 59,
        "w": 192,
        "h": 142
    },
    {
        "id": "cb177c6ca1393bd2",
        "type": "group",
        "z": "f83cd63ed7d0d814",
        "name": "Start",
        "style": {
            "label": true
        },
        "nodes": [
            "89f0171af7bed142",
            "92f6e88e554e16a2",
            "ad62321a4add6f68"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "019e3238abe7b610",
        "type": "group",
        "z": "f83cd63ed7d0d814",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "00f441452996487b",
            "c469b3340295cf43",
            "87fbf5acfad8259f"
        ],
        "x": 14,
        "y": 259,
        "w": 182,
        "h": 82
    },
    {
        "id": "e414eaa3b7355fb0",
        "type": "group",
        "z": "f83cd63ed7d0d814",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "3758738fbf3722bb",
            "1239f4f256efec3b"
        ],
        "x": 594,
        "y": 119,
        "w": 412,
        "h": 82
    },
    {
        "id": "19f34bd52acbc97f",
        "type": "group",
        "z": "f83cd63ed7d0d814",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "717bc3ddc3258751",
            "583ad663ebdd9403",
            "2d6c590194d3f46f"
        ],
        "x": 594,
        "y": 219,
        "w": 572,
        "h": 82
    },
    {
        "id": "1d41f1b8c8125a48",
        "type": "group",
        "z": "7a1a1938a7272ee4",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "cff34d487e9fe782",
            "9240d35b22fb4933",
            "a5dee27111f62715"
        ],
        "x": 34,
        "y": 99,
        "w": 192,
        "h": 162
    },
    {
        "id": "f493540a3e01ab6b",
        "type": "group",
        "z": "7a1a1938a7272ee4",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "bd82e6cbe8602c38",
            "a33a57ca66bac30a",
            "4bee0f0d753af223"
        ],
        "x": 34,
        "y": 479,
        "w": 192,
        "h": 142
    },
    {
        "id": "dbdcc7dd00fb5b22",
        "type": "group",
        "z": "7a1a1938a7272ee4",
        "name": "Import routine",
        "style": {
            "label": true
        },
        "nodes": [
            "7802fd2202143586",
            "4a15266d687b705c",
            "3c50358caec19d73",
            "f10d3cde242833ec",
            "0ee464983f081a56",
            "626d2b37e3672aa1",
            "8762eb0650b270a1",
            "dd86938ff41d8270"
        ],
        "x": 254,
        "y": 319,
        "w": 832,
        "h": 182
    },
    {
        "id": "b8a0115a6143b072",
        "type": "group",
        "z": "7a1a1938a7272ee4",
        "name": "Decide import or stop",
        "style": {
            "label": true
        },
        "nodes": [
            "15d075941a211f78",
            "d56e485414a28c20",
            "11da4c9a45e56e71",
            "f2d466a35d3b0542",
            "2a0e4af7f408d366",
            "8748983352f25f36",
            "0c485a3ad5b63526",
            "065433f8c426cee7",
            "263c49ecfd998d03",
            "383346a2cd4746cf",
            "56c2809e608d67be",
            "d6ae22820618f34d",
            "cd63bec7f67e6596",
            "2534c18873a94a6d",
            "015df65690f6fc00",
            "419fb91ada6f71ae",
            "257eda8177fdb918",
            "54e6c2e0a319dc80",
            "8e6b34661efd9262",
            "336f4ce0f4038ece"
        ],
        "x": 254,
        "y": 79,
        "w": 1928,
        "h": 207
    },
    {
        "id": "c62c6cd273376d12",
        "type": "group",
        "z": "7a1a1938a7272ee4",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "41be0cb53e32b85a",
            "f9f77fb0a958dc29",
            "27d49c54a65ffb3b"
        ],
        "x": 34,
        "y": 379,
        "w": 182,
        "h": 82
    },
    {
        "id": "739e0a83cc033ca6",
        "type": "group",
        "z": "40f4cc790d5ae165",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "8734284dcaec3633",
            "ba46a7ddf5e010eb"
        ],
        "x": 934,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "f648ac13a12aa8bd",
        "type": "group",
        "z": "40f4cc790d5ae165",
        "name": "Home battery start",
        "style": {
            "label": true
        },
        "nodes": [
            "0e1a4159f8a2aaf5",
            "7e9d5a59d3bf3a6c",
            "a589ffa67188c0f1"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "555eaac7da85a4b8",
        "type": "group",
        "z": "40f4cc790d5ae165",
        "name": "Plan",
        "style": {
            "label": true
        },
        "nodes": [
            "8f691c288c1f6836",
            "af33e085b70123b0",
            "e311cd0b8d00f0e1",
            "183ac8d8ebb68977",
            "b80e9ec722e5a813",
            "0d613ca6f7bf63bc",
            "23707522e38a45cc"
        ],
        "x": 228,
        "y": 273,
        "w": 1244,
        "h": 1054
    },
    {
        "id": "8d3318685130ea4b",
        "type": "group",
        "z": "40f4cc790d5ae165",
        "name": "Execute",
        "style": {
            "label": true
        },
        "nodes": [
            "bf198d59abd385ce",
            "49eaed08c9842d11",
            "427268516dda1dd2",
            "27e90d87802b4a2d",
            "4ffef8c0736f74bd"
        ],
        "x": 234,
        "y": 119,
        "w": 672,
        "h": 122
    },
    {
        "id": "3bfb42c4fef6d9da",
        "type": "group",
        "z": "40f4cc790d5ae165",
        "name": "Test area",
        "style": {
            "label": true
        },
        "nodes": [
            "512bc0fd76ca819c",
            "dc4b49abd35451ec",
            "637d239be07c14c3",
            "1df9f930fe738309",
            "5668e664243f9263",
            "8e8cbd768fc9765a",
            "4e229d17ba2aa9e7",
            "01e08006ea396623"
        ],
        "x": 234,
        "y": 1479,
        "w": 912,
        "h": 162
    },
    {
        "id": "79b4bc9416fb8873",
        "type": "group",
        "z": "40f4cc790d5ae165",
        "name": "All data",
        "style": {
            "label": true
        },
        "nodes": [
            "5344a99cd2c3c98a",
            "99be3b3592acf608",
            "32a117c1c1fc2ddc",
            "fc688a7459f13678",
            "a37c7456045aa7c0"
        ],
        "x": 234,
        "y": 1659,
        "w": 672,
        "h": 142
    },
    {
        "id": "be988495d64a84e2",
        "type": "group",
        "z": "40f4cc790d5ae165",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "77c43ddf65716772",
            "94c7d29e92a783b7",
            "efc797fa187ebb2f"
        ],
        "x": 24,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "e7df81a552114eba",
        "type": "group",
        "z": "e2e92ce99c1547de",
        "name": "Strategy start",
        "style": {
            "label": true
        },
        "nodes": [
            "bfc5eb5acb828da0",
            "ec993d308faca38a",
            "6053cb616c1a5967"
        ],
        "x": 14,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "220a89fef0bc8865",
        "type": "group",
        "z": "e2e92ce99c1547de",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "881141dc555d41fa",
            "e4636b01bb8ea48d"
        ],
        "x": 464,
        "y": 79,
        "w": 192,
        "h": 142
    },
    {
        "id": "83f7374753c3a642",
        "type": "group",
        "z": "e2e92ce99c1547de",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "fa5ab492d64cf943",
            "b130e82d23b45b07",
            "f387e1edf070fd19"
        ],
        "x": 14,
        "y": 259,
        "w": 182,
        "h": 82
    },
    {
        "id": "86b007234209c00c",
        "type": "group",
        "z": "5d26e71db8139b01",
        "name": "Strategy start",
        "style": {
            "fill": "#ffffff",
            "label": true
        },
        "nodes": [
            "c1fafc90dc699683",
            "3a4abdb0e5be3969",
            "30a8958fddde3d77"
        ],
        "x": 54,
        "y": 79,
        "w": 212,
        "h": 162
    },
    {
        "id": "2a057006f3362b94",
        "type": "group",
        "z": "5d26e71db8139b01",
        "name": "Battery solutions",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "da3b239e0d4bfc8f",
            "a93e023935baa08d",
            "8cf107fd9cca6b89"
        ],
        "x": 64,
        "y": 1139,
        "w": 202,
        "h": 142
    },
    {
        "id": "e8bce85a58c2493e",
        "type": "group",
        "z": "5d26e71db8139b01",
        "name": "Bumpless operation",
        "style": {
            "label": true,
            "stroke": "#bfdbef"
        },
        "nodes": [
            "b58fdf55cd321cce",
            "ab0edccc6a19e6d7",
            "3b0b82530c8e63c6",
            "7f4c717b834a73ca"
        ],
        "x": 1614,
        "y": 19,
        "w": 252,
        "h": 242
    },
    {
        "id": "b49341a060f7470b",
        "type": "group",
        "z": "5d26e71db8139b01",
        "name": "Bumpless operation - switching control modes",
        "style": {
            "stroke": "#bfdbef",
            "label": true
        },
        "nodes": [
            "da7b577393230824",
            "a7bef83d0b4bcd56",
            "ad2c2c6dce0b2274",
            "0a2d9604e40d0511",
            "81df299566ce4e2d",
            "c438ab1cd716fe37",
            "1d6218eb7a12e548",
            "5479e9729e5da5ec",
            "4baac7fe4baf93d5",
            "101a40e78281e075",
            "6c1122de5311c32c",
            "87ce11a06e1c3f1d"
        ],
        "x": 1614,
        "y": 279,
        "w": 592,
        "h": 289.5
    },
    {
        "id": "84cae9c5c4d22c4b",
        "type": "group",
        "z": "5d26e71db8139b01",
        "name": "Inputs",
        "style": {
            "fill": "#7fb7df",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "5ce1864b98cfe6dc",
            "4f7844f9b0aa3e88"
        ],
        "x": 288,
        "y": 13,
        "w": 904,
        "h": 234
    },
    {
        "id": "d04a3c31ca5e4081",
        "type": "group",
        "z": "5d26e71db8139b01",
        "name": "Pre processing",
        "style": {
            "fill": "#bfdbef",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "a9eba6e7787f98b8",
            "fb15e6655c6ae90a",
            "38233dae86fec512"
        ],
        "x": 288,
        "y": 273,
        "w": 1104,
        "h": 294
    },
    {
        "id": "0d8169eafd0b0eae",
        "type": "group",
        "z": "5d26e71db8139b01",
        "name": "Control",
        "style": {
            "fill": "#7fb7df",
            "label": true,
            "color": "#ffffff"
        },
        "nodes": [
            "b6c3fe784b71241d",
            "d9a650b4cb418aa3"
        ],
        "x": 288,
        "y": 593,
        "w": 924,
        "h": 634
    },
    {
        "id": "f3948f4466eb4cd9",
        "type": "group",
        "z": "5d26e71db8139b01",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "992c8cb568677839",
            "8f8521a708095a1a",
            "f27f65127cbed990"
        ],
        "x": 54,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "80c62629077e8227",
        "type": "group",
        "z": "e5380aeea0a0d937",
        "name": "Configuration",
        "style": {
            "label": true
        },
        "nodes": [
            "7ac81cf5ed1478f2",
            "055c7cf6df183b65",
            "ea29ed7e7647dbce"
        ],
        "x": 34,
        "y": 99,
        "w": 192,
        "h": 162
    },
    {
        "id": "71d7999d1271aed6",
        "type": "group",
        "z": "e5380aeea0a0d937",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "3465a104edeb1dde",
            "82f373b063985b1c",
            "f9332cd8e7997db2"
        ],
        "x": 34,
        "y": 479,
        "w": 192,
        "h": 142
    },
    {
        "id": "03d081761135f651",
        "type": "group",
        "z": "e5380aeea0a0d937",
        "name": "Export routine",
        "style": {
            "fill-opacity": "0.5",
            "label": true,
            "color": "#cccccc"
        },
        "nodes": [
            "b46223a8344215c5",
            "295ec0e46565356b",
            "1ce1df4e1efae19d",
            "28077011a9989235",
            "eb2bd89f4a0af9e5",
            "7d834ce42b48c821",
            "e67c0ca1b08116d3",
            "feaf5768f8fc3881"
        ],
        "x": 254,
        "y": 319,
        "w": 832,
        "h": 182
    },
    {
        "id": "531793f4dcaddf17",
        "type": "group",
        "z": "e5380aeea0a0d937",
        "name": "Decide export or stop",
        "style": {
            "label": true
        },
        "nodes": [
            "d3993759de73087e",
            "7ac5101d1f08c0bf",
            "157d31fc5d9b8485",
            "63eead100ac6b957",
            "38613f697830ae83",
            "22a0997a9304ddc3",
            "e41b1cf3112176f5",
            "d36627e6d401df9a",
            "7092b2fee88ebec3",
            "e5a58bff36b2f6d8",
            "ded98aaf1bf3beda",
            "92f7379770e40bfb",
            "f94ec7b8fe111d97",
            "d6c4d8239497df03",
            "0ddf4686091e3749",
            "b58909b73eabd1cc",
            "f5c8c5d20289dddf",
            "d2878b099f97ea9e",
            "51f32d29cf4a4ed9"
        ],
        "x": 254,
        "y": 79,
        "w": 1838,
        "h": 207
    },
    {
        "id": "65dbab7712bef253",
        "type": "group",
        "z": "e5380aeea0a0d937",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "b3b54f6f1de3ab2e",
            "a00fddd7f71bdb15",
            "232b6b08cc01ceb2"
        ],
        "x": 34,
        "y": 379,
        "w": 182,
        "h": 82
    },
    {
        "id": "3e9791fa009db08f",
        "type": "group",
        "z": "d94f748bb075b041",
        "name": "Battery solutions",
        "style": {
            "label": true
        },
        "nodes": [
            "47f2868bc66c2ca5",
            "f2a3d144ebe49b18"
        ],
        "x": 1214,
        "y": 419,
        "w": 192,
        "h": 142
    },
    {
        "id": "e1e54f5e31dcc6a0",
        "type": "group",
        "z": "d94f748bb075b041",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "eb45f65894eca2cd",
            "fb71e68f41f12029",
            "0f4fd6a61567204a"
        ],
        "x": 24,
        "y": 79,
        "w": 192,
        "h": 162
    },
    {
        "id": "d5206a471af75f06",
        "type": "group",
        "z": "d94f748bb075b041",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "1151fbed0c1b4a18",
            "3be5df1741acee6e",
            "043e37f75a11c538"
        ],
        "x": 454,
        "y": 79,
        "w": 532,
        "h": 82
    },
    {
        "id": "50f2d09f93efb481",
        "type": "group",
        "z": "d94f748bb075b041",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "68889289c7f6bca0",
            "ed312f1501d12e44",
            "b01b94bf13b13ccc",
            "0bf92830e23e120a"
        ],
        "x": 254,
        "y": 179,
        "w": 732,
        "h": 82
    },
    {
        "id": "a854c2216628bdbd",
        "type": "group",
        "z": "d94f748bb075b041",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "5ac70433035d79c5"
        ],
        "x": 254,
        "y": 79,
        "w": 192,
        "h": 82
    },
    {
        "id": "c54b7183164e398c",
        "type": "group",
        "z": "d94f748bb075b041",
        "name": "Determine sub-strategy based on time period",
        "style": {
            "label": true
        },
        "nodes": [
            "7737135fcee1079f",
            "33d96c71d5f20cb6",
            "afcbfee8e8338976",
            "8a6e9561e07c446e",
            "43ea5d3254d9a9c4",
            "ef468a6fea14c528",
            "a2b7fd1edeeca9cd",
            "9aae173aa6fe1242",
            "6f0286446a3c1bba",
            "6b2947a47fb3c725",
            "5b72472c33388326",
            "3b094766967dbf76",
            "9926059727130518",
            "224613699d210d88",
            "f5dfd33cc0612c08",
            "0a80c240776e0186",
            "874326be07679319",
            "465595e1b1f57fd1",
            "759d2b775f999de6",
            "1d38b023309c3923",
            "90fc2601f13048f5"
        ],
        "x": 254,
        "y": 379,
        "w": 692,
        "h": 402
    },
    {
        "id": "8dbc9a0b315e59e0",
        "type": "group",
        "z": "d94f748bb075b041",
        "name": "Execute sub-strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "1ee83eb51f7ce1d7",
            "a33a6e5a86948e26"
        ],
        "x": 984,
        "y": 419,
        "w": 192,
        "h": 142
    },
    {
        "id": "842a5287fb86754d",
        "type": "group",
        "z": "d94f748bb075b041",
        "style": {
            "stroke": "#565656",
            "stroke-opacity": "1",
            "fill": "#3a3a3a",
            "fill-opacity": "0.5",
            "label": true,
            "label-position": "nw",
            "color": "#cccccc"
        },
        "nodes": [
            "cf9d75fee58f577b",
            "8614d1f09fb7bf59",
            "5480f0eac3bd0af4",
            "057c08a4c016d542"
        ],
        "x": 254,
        "y": 279,
        "w": 732,
        "h": 82
    },
    {
        "id": "28bfa5e6aeaacd4f",
        "type": "group",
        "z": "d94f748bb075b041",
        "name": "Unhandled exceptions",
        "style": {
            "label": true,
            "stroke": "#d88a8a",
            "color": "#d88a8a"
        },
        "nodes": [
            "a5574df615b77760",
            "7e682df4ecbf618c",
            "fc2e7d2633fd4085"
        ],
        "x": 24,
        "y": 279,
        "w": 182,
        "h": 82
    },
    {
        "id": "880b4bd707f6cd0b",
        "type": "group",
        "z": "60b5d8044cd240a3",
        "g": "d608a4a32e0df080",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "1457af64557f3041",
            "b3a11a0e32755bcc",
            "0d5735b73237bcd7",
            "dacfd8968c7ae3a0",
            "bc51a1a250c21426",
            "9d1fca88cd539df4"
        ],
        "x": 414,
        "y": 99,
        "w": 492,
        "h": 222
    },
    {
        "id": "95256b97b46131d4",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "g": "2543e6b29ae7693e",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "c841bdf7967248d5",
            "9f2998f43b70d1e6",
            "ebfa02d4702cd66f",
            "b4ece3bf218bc36e",
            "5bb58ee9dd1199a5",
            "b39b56835b6c0dc8",
            "0e7e591778b146a3",
            "0c37b1cbd78133c3",
            "013199a4b3ebae10",
            "9e355ab881d25d6a"
        ],
        "x": 74,
        "y": 459,
        "w": 1612,
        "h": 82
    },
    {
        "id": "1a882b0a8dc7eb70",
        "type": "group",
        "z": "6d6573264ad03a3a",
        "g": "0964eecbbf0f7e7a",
        "name": "Loop",
        "style": {
            "label": true
        },
        "nodes": [
            "f4a8e8f452490855",
            "aff5f058787e14a5",
            "92a7d5022e9597f0",
            "fe23a7212d28ca93",
            "eabee0cfcdd08b96",
            "081d66643370cbf4",
            "a0ebbc6a0196f8e6"
        ],
        "x": 314,
        "y": 1159,
        "w": 552,
        "h": 222
    },
    {
        "id": "8e6b34661efd9262",
        "type": "group",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "UI helper | set bounds for charge levels",
        "style": {
            "label": true,
            "stroke": "#3f93cf"
        },
        "nodes": [
            "da930475c54f2689",
            "9ed3f45980814d94",
            "f332754c8d4af20f"
        ],
        "x": 1464,
        "y": 159,
        "w": 692,
        "h": 82
    },
    {
        "id": "b80e9ec722e5a813",
        "type": "group",
        "z": "40f4cc790d5ae165",
        "g": "555eaac7da85a4b8",
        "name": "API call to Data Source",
        "style": {
            "label": true
        },
        "nodes": [
            "b877a0ae39a17081",
            "bed3f816b5ce55dc",
            "699cf4c940801a57",
            "10e5a81ab5d03b54",
            "ba1be87033cd7c29",
            "1efdacf06d27b333",
            "4f31c1b602330ed1",
            "c665afbc6917c954",
            "5b9b60d1bb446ee0",
            "6657914b1330a469",
            "108337c587e041ce",
            "d0eff859ae1a59b4",
            "5a9e5d47a95a595a",
            "33aaf9c2fd99f53c",
            "f4d67481aae08a87",
            "50bc48fab854b122",
            "bf14bb1756b9f976",
            "52a67c0485d66ecd",
            "8472683db498d930",
            "429b03e356acd25d"
        ],
        "x": 254,
        "y": 519,
        "w": 752,
        "h": 362
    },
    {
        "id": "0d613ca6f7bf63bc",
        "type": "group",
        "z": "40f4cc790d5ae165",
        "g": "555eaac7da85a4b8",
        "name": "Update when",
        "style": {
            "label": true
        },
        "nodes": [
            "0e6f0b3dacd99164",
            "c7fa8e716372bd1b",
            "d1c0a3c464ae07a3",
            "c384a00e15da77d8",
            "4a26dc4637a2afce",
            "afb3be193833d31b",
            "2c984fa1a7fb0bba",
            "49d760d9605827ea",
            "99fca0348d07440d",
            "4b9fa5c22399b1eb",
            "7c8454fb0e840d17",
            "461b419ed807cb64",
            "c57f9f835deb8fe5",
            "c85b67169cd76834",
            "d3283f3f93d6e646",
            "e23ef0f572f54a81",
            "dd4400b8aaca8fa8",
            "584ea9bf3c938a9e"
        ],
        "x": 254,
        "y": 299,
        "w": 1192,
        "h": 202
    },
    {
        "id": "23707522e38a45cc",
        "type": "group",
        "z": "40f4cc790d5ae165",
        "g": "555eaac7da85a4b8",
        "name": "Determine strategy",
        "style": {
            "label": true
        },
        "nodes": [
            "efb7738725196719",
            "ba869747549461c4",
            "85a84c7778e69325",
            "fbd8b3ab08efebf1",
            "64b9050a85cb2ccd",
            "56fd0270a5d412a6",
            "a844f8be8731d922",
            "1de512f7648062ef",
            "c5d8e356117897a6",
            "7d222d5ea7466dff",
            "37b7ae3890e11351",
            "2e4d31794ebd5213",
            "2b60fa521307b416",
            "66e7be796fa21223",
            "3e7827f753fa44b9",
            "face4b997b2e16fb"
        ],
        "x": 254,
        "y": 899,
        "w": 872,
        "h": 402
    },
    {
        "id": "5ce1864b98cfe6dc",
        "type": "group",
        "z": "5d26e71db8139b01",
        "g": "84cae9c5c4d22c4b",
        "name": "PID control inputs",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "c4f9e2721bd6b163",
            "d752b766b50c1b46",
            "95c361bf2bad8003",
            "4d3a60e5f7c7da9b",
            "d48e4488790c1bf8",
            "d66ec737d5123e73",
            "9eb92733afdf60da",
            "3ca23b7ec5964d4b",
            "ea5f3de3df33cd48"
        ],
        "x": 314,
        "y": 59,
        "w": 572,
        "h": 162
    },
    {
        "id": "4f7844f9b0aa3e88",
        "type": "group",
        "z": "5d26e71db8139b01",
        "g": "84cae9c5c4d22c4b",
        "name": "Advanced features",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "15d4b1ea3664f212",
            "a11b6efa02f965ac",
            "7d1362107ebc0e95"
        ],
        "x": 914,
        "y": 39,
        "w": 252,
        "h": 182
    },
    {
        "id": "a9eba6e7787f98b8",
        "type": "group",
        "z": "5d26e71db8139b01",
        "g": "d04a3c31ca5e4081",
        "name": "",
        "style": {
            "fill": "#ffffff",
            "label": true
        },
        "nodes": [
            "86fc2555e948e84b",
            "63c323ec62ca6ab6",
            "c22226e49ce62190",
            "a20d6518251c39b9"
        ],
        "x": 314,
        "y": 299,
        "w": 292,
        "h": 202
    },
    {
        "id": "fb15e6655c6ae90a",
        "type": "group",
        "z": "5d26e71db8139b01",
        "g": "d04a3c31ca5e4081",
        "name": "Derivative - incl. bumpless operation",
        "style": {
            "label": true,
            "stroke": "#a4a4a4",
            "fill": "#ffffff"
        },
        "nodes": [
            "389047b3ce51eaa2",
            "584921887c4d5257",
            "63c64fdd1ceb4bf9",
            "0f4874b4b801709c",
            "0210d8049439506c"
        ],
        "x": 614,
        "y": 399,
        "w": 752,
        "h": 142
    },
    {
        "id": "38233dae86fec512",
        "type": "group",
        "z": "5d26e71db8139b01",
        "g": "d04a3c31ca5e4081",
        "name": "Processing required? ",
        "style": {
            "label": true,
            "fill": "#ffffff"
        },
        "nodes": [
            "eebb56edb9223224",
            "7a33eb931047b075",
            "a31368cd3b0883ac"
        ],
        "x": 614,
        "y": 299,
        "w": 562,
        "h": 82
    },
    {
        "id": "b6c3fe784b71241d",
        "type": "group",
        "z": "5d26e71db8139b01",
        "g": "0d8169eafd0b0eae",
        "name": "PID controller",
        "style": {
            "label": true,
            "fill": "#ffffff",
            "color": "#3f3f3f"
        },
        "nodes": [
            "448c9f2401339fb2",
            "ea452de4b0a073f1",
            "a0aa8bb0ca4aee9c",
            "266b25a0640fca3b",
            "446f941ddb1b7436",
            "d86f4702f61d29ac",
            "7a3ecaf39eb4ed8d",
            "c094882a33fd3073",
            "fbf3843ae55ad90e",
            "8850373b7f822c9f",
            "3638a82c6b79201e",
            "9157c0ea42014ccb",
            "5b17d8c0e9afd36d",
            "ccf7199a199b07ba",
            "3d81a7153a6c062e",
            "cf86b7aac680b96e",
            "a071c57355697c57",
            "18435e8b07794fc1",
            "af71cba378a24483",
            "44f4a3db2ff26cb7"
        ],
        "x": 314,
        "y": 619,
        "w": 872,
        "h": 482
    },
    {
        "id": "d9a650b4cb418aa3",
        "type": "group",
        "z": "5d26e71db8139b01",
        "g": "0d8169eafd0b0eae",
        "name": "Distribution",
        "style": {
            "label": true,
            "fill": "#ffffff",
            "color": "#3f3f3f"
        },
        "nodes": [
            "cb222b79fb8cf895",
            "64f5ceb216ceef3e"
        ],
        "x": 314,
        "y": 1119,
        "w": 452,
        "h": 82
    },
    {
        "id": "51f32d29cf4a4ed9",
        "type": "group",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "UI helper | set bounds for charge levels",
        "style": {
            "label": true,
            "stroke": "#3f93cf"
        },
        "nodes": [
            "a25eaea50ed4bff8",
            "7e1303a962cc6a08",
            "babf46924dd40b46"
        ],
        "x": 1394,
        "y": 159,
        "w": 672,
        "h": 82
    },
    {
        "id": "08279debefcd5bf3",
        "type": "junction",
        "z": "6d6573264ad03a3a",
        "x": 40,
        "y": 360,
        "wires": [
            [
                "b1815487134bfc84"
            ]
        ]
    },
    {
        "id": "54e6c2e0a319dc80",
        "type": "junction",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "x": 1490,
        "y": 260,
        "wires": [
            [
                "3c50358caec19d73"
            ]
        ]
    },
    {
        "id": "461b419ed807cb64",
        "type": "junction",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "x": 640,
        "y": 340,
        "wires": [
            [
                "2c984fa1a7fb0bba"
            ]
        ]
    },
    {
        "id": "d66ec737d5123e73",
        "type": "junction",
        "z": "5d26e71db8139b01",
        "g": "5ce1864b98cfe6dc",
        "x": 460,
        "y": 100,
        "wires": [
            [
                "3ca23b7ec5964d4b"
            ]
        ]
    },
    {
        "id": "3ca23b7ec5964d4b",
        "type": "junction",
        "z": "5d26e71db8139b01",
        "g": "5ce1864b98cfe6dc",
        "x": 700,
        "y": 100,
        "wires": [
            [
                "9eb92733afdf60da",
                "ea5f3de3df33cd48"
            ]
        ]
    },
    {
        "id": "ea5f3de3df33cd48",
        "type": "junction",
        "z": "5d26e71db8139b01",
        "g": "5ce1864b98cfe6dc",
        "x": 720,
        "y": 120,
        "wires": [
            [
                "d752b766b50c1b46"
            ]
        ]
    },
    {
        "id": "d2878b099f97ea9e",
        "type": "junction",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "x": 1440,
        "y": 260,
        "wires": [
            [
                "1ce1df4e1efae19d"
            ]
        ]
    },
    {
        "id": "176d29a.6f648d6",
        "type": "server",
        "name": "Home Assistant",
        "addon": true,
        "rejectUnauthorizedCerts": true,
        "ha_boolean": "",
        "connectionDelay": false,
        "cacheJson": false,
        "heartbeat": false,
        "heartbeatInterval": "",
        "statusSeparator": "",
        "enableGlobalContextStore": false
    },
    {
        "id": "c5a560e8805a3490",
        "type": "server-state-changed",
        "z": "6d6573264ad03a3a",
        "g": "b233a9c4848f7142",
        "name": "P1 meter",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.p1_meter_power"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": false,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "grid_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "timestamp",
                "propertyType": "msg",
                "value": "",
                "valueType": "date"
            }
        ],
        "x": 120,
        "y": 60,
        "wires": [
            [
                "60b289e22e2faeac"
            ]
        ]
    },
    {
        "id": "60b289e22e2faeac",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "b233a9c4848f7142",
        "name": "Master Control Mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.marstek_master_battery_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "master_mode",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 300,
        "y": 60,
        "wires": [
            [
                "abda411cd23fa61e"
            ]
        ]
    },
    {
        "id": "abda411cd23fa61e",
        "type": "switch",
        "z": "6d6573264ad03a3a",
        "g": "b233a9c4848f7142",
        "name": "when in \"Full Control\" mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 540,
        "y": 60,
        "wires": [
            [
                "4bc60310535b5527"
            ]
        ]
    },
    {
        "id": "e90efd5896b1c62e",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "a97e9944723199fb",
        "name": "Strategy selection",
        "func": "// Logger\nconst logger = global.get(\"logger\");\n\n// INFLOW\nlet strategy = flow.get(\"house_battery_strategy\");\n\n// Configure msg.strategy object\nRED.util.setMessageProperty(msg,\"strategy.selected\",strategy,true); // by user\nRED.util.setMessageProperty(msg,\"strategy.trace\",[],true); // init trace: which flows have been executed\n\n// stop on error\nif(msg.batteries === undefined) {\n    logger(this, \"Battery configuration undefined\", \"error\");\n    return null;\n}\nif(strategy === undefined) {\n    logger(this, \"Battery strategy undefined\", \"error\");\n    return null;\n}\n\n// Default | select target flow based on the input_select `house_battery_strategy`\nmsg.target = `${strategy}`;\n\n// full stop trigger overrules ALL selected strategies\nconst stopTrigger = RED.util.getMessageProperty(msg,\"full_stop_trigger\");\nif(stopTrigger == \"on\" || stopTrigger === true || stopTrigger === 1) {\n    msg.target = 'Full stop';\n    // Explain\n    logger(this, `**Full Stop** strategy selected, due to (EV) stop trigger: '${stopTrigger}'`);\n}\n\n// add execution marker\nRED.util.setMessageProperty(msg,\"strategy.execution_start\",Date.now()); // when do we start executing the selected strategy\n\n// OUTPUT\nnode.status({fill:\"grey\",shape:\"dot\",text:msg.target});\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 980,
        "wires": [
            [
                "1ffd9eb1ed9e17db",
                "809ba00b022b204d"
            ]
        ]
    },
    {
        "id": "809ba00b022b204d",
        "type": "link call",
        "z": "6d6573264ad03a3a",
        "g": "a97e9944723199fb",
        "name": "Call \"Link in\" node",
        "links": [],
        "linkType": "dynamic",
        "timeout": "1.2",
        "x": 510,
        "y": 1020,
        "wires": [
            [
                "54c0823786fcf69e",
                "ec0fe5c5b9f481ec"
            ]
        ]
    },
    {
        "id": "1ffd9eb1ed9e17db",
        "type": "debug",
        "z": "6d6573264ad03a3a",
        "g": "a97e9944723199fb",
        "name": "Input msg",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 980,
        "wires": []
    },
    {
        "id": "54c0823786fcf69e",
        "type": "debug",
        "z": "6d6573264ad03a3a",
        "g": "a97e9944723199fb",
        "name": "Returned msg",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 740,
        "y": 1020,
        "wires": []
    },
    {
        "id": "ec0fe5c5b9f481ec",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "a97e9944723199fb",
        "name": "Strategy evaluation",
        "func": "// add execution marker\nlet execution_end = Date.now();\nRED.util.setMessageProperty(msg, \"strategy.execution_end\", execution_end);\n\n// retrieve execution markers\nlet execution_start = RED.util.getMessageProperty(msg,\"strategy.execution_start\");\n\n// report execution time\nif (execution_start !== undefined && execution_end !== undefined) {\n    // exec time\n    let execution_time = (execution_end - execution_start) / 1000; // seconds\n    // report\n    if (execution_time <= 0) node.status({ fill: \"red\", shape: \"dot\", text: `negative or zero timing` });\n    if (execution_time > 0) node.status({ fill: \"green\", shape: \"dot\", text: `${execution_time} sec`});\n    if (execution_time >= 0.7) node.status({ fill: \"yellow\", shape: \"dot\", text: `${execution_time} sec` });\n    if (execution_time >= 1) node.status({ fill: \"red\", shape: \"dot\", text: `${execution_time} sec` });\n\n} else {\n    node.status({fill:\"grey\",shape:\"dot\",text:\"timing error\"});\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 1060,
        "wires": [
            [
                "5201e7a62283c39e",
                "8eda290fc8979d34",
                "dc9da6c1bd3fc1aa"
            ]
        ]
    },
    {
        "id": "dc01bc5909a705c8",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "2543e6b29ae7693e",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// Init an array for battery status and value information\nmsg.batteries = [];\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 420,
        "wires": [
            [
                "c841bdf7967248d5"
            ]
        ]
    },
    {
        "id": "d749eb0fd520baf4",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "2543e6b29ae7693e",
        "name": "Mapping",
        "func": "// Map to batteries array\nmsg.batteries.push({\n    id: `M${msg.battery_index}`,\n    power: parseInt(msg.battery_power,10),\n    charging_max: parseInt(msg.max_charge_power,10),\n    discharging_max: parseInt(msg.max_discharge_power,10),\n    soc: parseInt(msg.battery_state_of_charge,10),\n    soc_max: parseInt(msg.charging_cutoff_capacity,10),\n    soc_min: parseInt(msg.discharging_cutoff_capacity,10),\n    inverter: String(msg.inverter_state),\n    energy: Number(msg.battery_remaining_capacity),\n    energy_max: Number(msg.battery_total_energy),\n    rs485: String(msg.rs485_control_mode)\n    });\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 580,
        "wires": [
            [
                "27d26635ccde69cf"
            ]
        ]
    },
    {
        "id": "d7dea4b181dc94d5",
        "type": "switch",
        "z": "6d6573264ad03a3a",
        "g": "2543e6b29ae7693e",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "battery_count",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 420,
        "y": 580,
        "wires": [
            [
                "c841bdf7967248d5"
            ],
            [
                "52de7f4fd5117e6e"
            ]
        ]
    },
    {
        "id": "1f8bb926afaf2fcd",
        "type": "debug",
        "z": "6d6573264ad03a3a",
        "g": "2543e6b29ae7693e",
        "name": "Loop result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 770,
        "y": 580,
        "wires": []
    },
    {
        "id": "b1815487134bfc84",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "2543e6b29ae7693e",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 420,
        "wires": [
            [
                "dc01bc5909a705c8"
            ]
        ]
    },
    {
        "id": "c841bdf7967248d5",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "95256b97b46131d4",
        "name": "Control mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "select.marstek_m{{battery_index}}_rs485_control_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "rs485_control_mode",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 180,
        "y": 500,
        "wires": [
            [
                "0e7e591778b146a3"
            ]
        ]
    },
    {
        "id": "9f2998f43b70d1e6",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "95256b97b46131d4",
        "name": "SoC",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_state_of_charge",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_state_of_charge",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 870,
        "y": 500,
        "wires": [
            [
                "013199a4b3ebae10"
            ]
        ]
    },
    {
        "id": "ebfa02d4702cd66f",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "95256b97b46131d4",
        "name": "Inverter state",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_inverter_state",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "inverter_state",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1290,
        "y": 500,
        "wires": [
            [
                "5bb58ee9dd1199a5"
            ]
        ]
    },
    {
        "id": "b4ece3bf218bc36e",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "95256b97b46131d4",
        "name": "Max discharge power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_discharge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_discharge_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 700,
        "y": 500,
        "wires": [
            [
                "9f2998f43b70d1e6"
            ]
        ]
    },
    {
        "id": "5bb58ee9dd1199a5",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "95256b97b46131d4",
        "name": "Energy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_remaining_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_remaining_capacity",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1440,
        "y": 500,
        "wires": [
            [
                "0c37b1cbd78133c3"
            ]
        ]
    },
    {
        "id": "b39b56835b6c0dc8",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "95256b97b46131d4",
        "name": "Max charge power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "number.marstek_m{{battery_index}}_max_charge_power",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "max_charge_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 490,
        "y": 500,
        "wires": [
            [
                "b4ece3bf218bc36e"
            ]
        ]
    },
    {
        "id": "0e7e591778b146a3",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "95256b97b46131d4",
        "name": "Power",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_power",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "battery_power",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 330,
        "y": 500,
        "wires": [
            [
                "b39b56835b6c0dc8"
            ]
        ]
    },
    {
        "id": "0d5e5f7418e6d09a",
        "type": "api-call-service",
        "z": "6d6573264ad03a3a",
        "g": "8267344b22de78fa",
        "name": "Node-RED status: OK",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.house_battery_control_has_node_red"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_boolean",
        "service": "turn_on",
        "x": 1760,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "383f47d55f5f03c7",
        "type": "inject",
        "z": "6d6573264ad03a3a",
        "g": "8267344b22de78fa",
        "name": "On deploy",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "0.1",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1410,
        "y": 60,
        "wires": [
            [
                "dfd59246e01132df",
                "7ed978df24edaebe"
            ]
        ]
    },
    {
        "id": "f4a8e8f452490855",
        "type": "api-call-service",
        "z": "6d6573264ad03a3a",
        "g": "1a882b0a8dc7eb70",
        "name": "Set mode (charge/discharge/stop)",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 660,
        "y": 1200,
        "wires": [
            []
        ]
    },
    {
        "id": "aff5f058787e14a5",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "1a882b0a8dc7eb70",
        "name": "Set Batteries",
        "func": "// Logger\nconst log = global.get(\"logger\");\n\n// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n// Output format and target\nlet outputArray = [];\nlet solution = msg.solutions[msg.battery_index-1]; // Base-0, thus -1\nif (solution === undefined) {\n    log(this,`Can't find solution for index ${msg.battery_index - 1} in ${msg.solutions}, aborting...`,\"error\");\n    return null;\n}\nlet target = `marstek_${solution.id.toLowerCase()}`;\n\n// Safety | Id exists\nlet battery = msg.batteries.find(battery => battery.id === solution.id);\nif (battery === undefined) {\n    log(`Can't set battery ${solution.id}, aborting...`,\"error\");\n    return null;\n}\n// Safety | Power limit\nsolution.power = Math.min(solution.power, solution.mode == CMODE.CHARGE ? battery.charging_max: battery.discharging_max);\n\n// Set | Mode\nconst serviceCallMode = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_forcible_charge_discharge`]\n    },\n    \"data\": {\n         \"option\": String(solution.mode) // forced charge mode (stop, charge, discharge)\n    }\n};\n// Add topic to allow correct 'on change' filtering\noutputArray.push({payload: serviceCallMode, topic:solution.id});\n\n// Set | Power\nconst serviceCallPower = {\n    \"action\": \"number.set_value\",\n    \"target\": {\n        \"entity_id\": [\n            `number.${target}_forcible_charge_power`,\n            `number.${target}_forcible_discharge_power`\n            ]\n    },\n    \"data\": {\n        \"value\": Number(solution.power)\n    } \n};\n// Add topic to allow correct 'on change' filtering\noutputArray.push({payload: serviceCallPower, topic:solution.id});\n\n// Store service calls in msg to allow checking of loop results\nmsg.loop_result = { target, serviceCallMode, serviceCallPower };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Explain\nlog(this,`${target} ${String(solution.mode)} @ ${Number(solution.power)} Watt`);\n\n// Output\nreturn outputArray;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 1240,
        "wires": [
            [
                "f4a8e8f452490855"
            ],
            [
                "a0ebbc6a0196f8e6"
            ],
            [
                "fe23a7212d28ca93"
            ]
        ],
        "inputLabels": [
            "Msg with a battery_index"
        ],
        "outputLabels": [
            "Select MODE",
            "Set POWER",
            "Msg"
        ]
    },
    {
        "id": "d0d1c004d897b2c2",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "0964eecbbf0f7e7a",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = msg.battery_count;\n\n// Debug\nRED.util.setMessageProperty(msg, \"debug\", `## Cohort ${Date.now()} ##`);\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 120,
        "y": 1240,
        "wires": [
            [
                "aff5f058787e14a5"
            ]
        ]
    },
    {
        "id": "92a7d5022e9597f0",
        "type": "switch",
        "z": "6d6573264ad03a3a",
        "g": "1a882b0a8dc7eb70",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 740,
        "y": 1300,
        "wires": [
            [
                "aff5f058787e14a5"
            ],
            [
                "964a53680eb4e096"
            ]
        ]
    },
    {
        "id": "fe23a7212d28ca93",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "1a882b0a8dc7eb70",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index -= 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 1300,
        "wires": [
            [
                "92a7d5022e9597f0",
                "081d66643370cbf4"
            ]
        ]
    },
    {
        "id": "eabee0cfcdd08b96",
        "type": "api-call-service",
        "z": "6d6573264ad03a3a",
        "g": "1a882b0a8dc7eb70",
        "name": "Set power (W)",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 760,
        "y": 1240,
        "wires": [
            []
        ]
    },
    {
        "id": "fd8d01afd97db3f1",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "0964eecbbf0f7e7a",
        "name": "Timing start",
        "func": "RED.util.setMessageProperty(msg,\"setbatteries.execution_start\",Date.now());\nRED.util.setMessageProperty(msg,\"setbatteries.marker\", `M1_${Date.now()}`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 1200,
        "wires": [
            [
                "d0d1c004d897b2c2"
            ]
        ]
    },
    {
        "id": "5201e7a62283c39e",
        "type": "switch",
        "z": "6d6573264ad03a3a",
        "g": "0964eecbbf0f7e7a",
        "name": "solutions present",
        "property": "solutions",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "undefined",
                "vt": "jsonata"
            },
            {
                "t": "neq",
                "v": "undefined",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 150,
        "y": 1160,
        "wires": [
            [
                "890fc9c1620e7264"
            ],
            [
                "fd8d01afd97db3f1"
            ]
        ]
    },
    {
        "id": "964a53680eb4e096",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "0964eecbbf0f7e7a",
        "name": "Timing end",
        "func": "let start = RED.util.getMessageProperty(msg,\"setbatteries.execution_start\");\nlet end = Date.now();\nlet delta = end - start;\nlet timingString = `${delta/1000} sec`;\n\nnode.status({fill:\"green\",shape:\"dot\",text: timingString});\nmsg.delta = delta;\nmsg.timing = timingString;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 130,
        "y": 1420,
        "wires": [
            [
                "3b3ce39b596bb8aa",
                "6eb943fb97982e10"
            ]
        ]
    },
    {
        "id": "081d66643370cbf4",
        "type": "debug",
        "z": "6d6573264ad03a3a",
        "g": "1a882b0a8dc7eb70",
        "name": "Step result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "loop_result",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 750,
        "y": 1340,
        "wires": []
    },
    {
        "id": "a0ebbc6a0196f8e6",
        "type": "rbe",
        "z": "6d6573264ad03a3a",
        "g": "1a882b0a8dc7eb70",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 590,
        "y": 1240,
        "wires": [
            [
                "eabee0cfcdd08b96"
            ]
        ]
    },
    {
        "id": "3b3ce39b596bb8aa",
        "type": "debug",
        "z": "6d6573264ad03a3a",
        "g": "0964eecbbf0f7e7a",
        "name": "Done",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "debug",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 270,
        "y": 1420,
        "wires": []
    },
    {
        "id": "27d26635ccde69cf",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "2543e6b29ae7693e",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 580,
        "wires": [
            [
                "d7dea4b181dc94d5"
            ]
        ]
    },
    {
        "id": "5630d7df55c386bb",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "d0377d9db7f88ba2",
        "name": "Update battery order",
        "func": "// Cycles battery priority as follows\n// M=1 [1,2,3,4] | M=2 [2,3,4,1] | M=3 [3,4,1,2] | etc.\n// With M the battery to prioritize\n\n// msg.batteries (original order)\nlet currentArray = msg.batteries;\n\n// Prioritize the Mth battery\nconst M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// 1st battery has prio? Skip and continue without change\nif (M==1) return msg;\n\n// N equals the number of items to take from the front to the back of the array, effectivly rotating battery priority\nconst N = M - 1; // base-0 version of M\nnode.status({fill:\"blue\",shape:\"ring\",text:`N = ${N}`});\n\n// 1. Check if the array is valid and long enough\nif (!Array.isArray(currentArray) || currentArray.length < N) {\n    // Send an error or the original array back if the array is invalid/too short\n    node.error(`Array is not valid or shorter than ${N} items.`, msg);\n    return null;\n}\n\n// 2. Get the first N items (these will go to the back)\n// slice(0, N) retrieves elements from the start (index 0) up to index N (exclusive).\nlet firstN = currentArray.slice(0, N);\n\n// 3. Get the remaining items (these will stay at the front)\n// slice(N) retrieves elements from index N to the end of the array.\nlet remaining = currentArray.slice(N);\n\n// 4. Concatenate them: remaining items (front) + first N items (back)\nlet newArray = remaining.concat(firstN);\n\n// 5. Place the new array back into msg.batteries\nmsg.batteries = newArray;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 780,
        "wires": [
            [
                "7663aa8bf97d6dff"
            ]
        ]
    },
    {
        "id": "494ac73459afb551",
        "type": "inject",
        "z": "6d6573264ad03a3a",
        "g": "d0377d9db7f88ba2",
        "name": "Every day 02:00",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 02 * * *",
        "once": false,
        "onceDelay": "5",
        "topic": "cycle_battery_priority",
        "payload": "",
        "payloadType": "date",
        "x": 610,
        "y": 780,
        "wires": [
            [
                "36d7e0f54b414907"
            ]
        ]
    },
    {
        "id": "19095a51a37549b6",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "d0377d9db7f88ba2",
        "name": "Change priority",
        "func": "// Current prioritized battery is the Mth battery\nlet M = RED.util.getMessageProperty(msg,\"prioritize_battery\") || 1;\n\n// Prioritize the next battery\nM += 1;\n\n// If the next battery does not exist, prioritize the first again\nif(M > msg.battery_count) M = 1;\n\n// Pass along as payload\nmsg.payload = M;\n\n// Show which battery has priority\nnode.status({fill:\"green\",shape:\"dot\",text:`Prioritize battery #${M}`});\n\n// Done\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1540,
        "y": 780,
        "wires": [
            [
                "36501aa6b920ad81"
            ]
        ]
    },
    {
        "id": "abc780d1e6ca22b1",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "d0377d9db7f88ba2",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1350,
        "y": 780,
        "wires": [
            [
                "19095a51a37549b6"
            ]
        ]
    },
    {
        "id": "3924bee9d981832b",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "d0377d9db7f88ba2",
        "name": "Prioritize battery M",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_prioritize_battery",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "prioritize_battery",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 780,
        "wires": [
            [
                "5630d7df55c386bb"
            ]
        ]
    },
    {
        "id": "36501aa6b920ad81",
        "type": "api-call-service",
        "z": "6d6573264ad03a3a",
        "g": "d0377d9db7f88ba2",
        "name": "Update prioritized battery",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_prioritize_battery"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1750,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "36d7e0f54b414907",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "d0377d9db7f88ba2",
        "name": "Desired interval",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_control_priority_change_interval",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 800,
        "y": 780,
        "wires": [
            [
                "d35dfc4414bdb947"
            ]
        ]
    },
    {
        "id": "d35dfc4414bdb947",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "d0377d9db7f88ba2",
        "name": "Check interval ",
        "func": "// Manual priority, never pass\nif(msg.payload == \"Never\") {\n    node.status({fill:\"yellow\",shape:\"dot\",text:\"Auto cycle disabled\"});\n    return null;\n}\n\n// Daily interval, always pass\nif(msg.payload == \"Daily\") {\n    node.status({ fill: \"green\", shape: \"dot\", text: `Pass` });\n    return msg;\n}\n\n// Weekly interval\nconst today = new Date();\n// Get the day of the week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)\nconst dayOfWeek = today.getDay();\n\n// Check if the day is Sunday (which is represented by the number 0)\nif (dayOfWeek === 0) {\n    // If it is Sunday, pass\n    node.status({ fill: \"green\", shape: \"dot\", text: `Passed on Sunday` });\n    return msg;\n} else {\n    // If it is not Sunday, stop\n    node.status({ fill: \"yellow\", shape: \"dot\", text: `Halted, not Sunday` });\n    return null;\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 980,
        "y": 780,
        "wires": [
            [
                "ceb9a9a8de8079f3"
            ]
        ]
    },
    {
        "id": "ceb9a9a8de8079f3",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "d0377d9db7f88ba2",
        "name": "Current priority",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_prioritize_battery",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "prioritize_battery",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1160,
        "y": 780,
        "wires": [
            [
                "abc780d1e6ca22b1"
            ]
        ]
    },
    {
        "id": "f24873861a68e30e",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "b6ffa420a5b0ad36",
        "name": "Batteries (totals)",
        "func": "// batteries | calculate total and max. power delivered by batteries\nlet batteries = msg.batteries;\nlet batteries_total_power = 0;\nlet batteries_max_charging_power = 0;\nlet batteries_max_discharging_power = 0;\nlet batteries_available_energy = 0;\nlet batteries_max_energy = 0;\n\nbatteries.forEach(battery => {\n    batteries_total_power += Number(battery.power);\n    batteries_max_charging_power += Number(battery.charging_max);\n    batteries_max_discharging_power += Number(battery.discharging_max);\n    batteries_available_energy += Number(battery.energy - battery.energy_max*battery.soc_min/100);\n    batteries_max_energy += (Number(battery.energy_max*battery.soc_max) - Number(battery.energy_max*battery.soc_min))/100; // kWh\n});\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_total_power\", batteries_total_power, true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_charge_power\", batteries_max_charging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_max_discharge_power\", batteries_max_discharging_power,true); // W\nRED.util.setMessageProperty(msg, \"batteries_available_energy\",batteries_available_energy,true); // kWh usable\nRED.util.setMessageProperty(msg, \"batteries_max_energy\", batteries_max_energy, true); // kWh usable\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 140,
        "y": 680,
        "wires": [
            [
                "3924bee9d981832b",
                "aa85c75b8774df54"
            ]
        ],
        "inputLabels": [
            "Mapping (from Home Battery IO)"
        ]
    },
    {
        "id": "0c37b1cbd78133c3",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "95256b97b46131d4",
        "name": "Energy max",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.marstek_m{{battery_index}}_battery_total_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_total_energy",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1590,
        "y": 500,
        "wires": [
            [
                "d749eb0fd520baf4"
            ]
        ]
    },
    {
        "id": "52de7f4fd5117e6e",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "2543e6b29ae7693e",
        "name": "Loop end",
        "func": "// cleanup \ndelete msg.battery_index;\n\ndelete msg.battery_power;\ndelete msg.max_charge_power;\ndelete msg.max_discharge_power;\ndelete msg.battery_state_of_charge;\ndelete msg.charging_cutoff_capacity;\ndelete msg.discharging_cutoff_capacity;\ndelete msg.inverter_state;\ndelete msg.battery_remaining_capacity;\ndelete msg.battery_total_energy;\ndelete msg.rs485_control_mode;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 580,
        "y": 580,
        "wires": [
            [
                "1f8bb926afaf2fcd",
                "f24873861a68e30e"
            ]
        ]
    },
    {
        "id": "e29a618451ef3414",
        "type": "api-call-service",
        "z": "6d6573264ad03a3a",
        "g": "049c8c835e1ec5bd",
        "name": "Set total usable energy",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_total_available_energy"
        ],
        "labelId": [],
        "data": "{\"value\":$$.batteries_available_energy}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1760,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "aa85c75b8774df54",
        "type": "rbe",
        "z": "6d6573264ad03a3a",
        "g": "049c8c835e1ec5bd",
        "name": "On change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "batteries_available_energy",
        "topi": "topic",
        "x": 1570,
        "y": 680,
        "wires": [
            [
                "e29a618451ef3414"
            ]
        ]
    },
    {
        "id": "fba8ee89ee4b48fc",
        "type": "switch",
        "z": "6d6573264ad03a3a",
        "g": "88fcf7fce2bcee4a",
        "name": "Select rate limit",
        "property": "p1_rate_limit.save_power",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 660,
        "y": 280,
        "wires": [
            [
                "6a8a3772d3097e4f"
            ],
            [
                "68784b26a71554df"
            ]
        ]
    },
    {
        "id": "62462fbde509f093",
        "type": "delay",
        "z": "6d6573264ad03a3a",
        "g": "88fcf7fce2bcee4a",
        "name": "Rate limit",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "3",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "allowrate": true,
        "outputs": 2,
        "x": 980,
        "y": 280,
        "wires": [
            [
                "24d61d6a6d2cd81c"
            ],
            [
                "324924b135aee546"
            ]
        ],
        "outputLabels": [
            "Pass",
            ""
        ]
    },
    {
        "id": "68784b26a71554df",
        "type": "change",
        "z": "6d6573264ad03a3a",
        "g": "88fcf7fce2bcee4a",
        "name": "1 msg/s",
        "rules": [
            {
                "t": "set",
                "p": "rate",
                "pt": "msg",
                "to": "1000",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 820,
        "y": 300,
        "wires": [
            [
                "62462fbde509f093"
            ]
        ]
    },
    {
        "id": "6a8a3772d3097e4f",
        "type": "change",
        "z": "6d6573264ad03a3a",
        "g": "88fcf7fce2bcee4a",
        "name": "0.333 msg/s",
        "rules": [
            {
                "t": "set",
                "p": "rate",
                "pt": "msg",
                "to": "3000",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 830,
        "y": 260,
        "wires": [
            [
                "62462fbde509f093"
            ]
        ]
    },
    {
        "id": "bad0d99aae2e98d9",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "88fcf7fce2bcee4a",
        "name": "P1 change (20W or 2%)",
        "func": "// Switch between low and high rate limiting to decrease load and power consumption\n// --\n// The flow should always be rate limited by atleast the total execution time of strategies\n// The flow should not lock up indefinitly when grid_power is constant.\n// In the latter case, a more relaxed rate limit can help reduce system load.\n// Devs: don't set msg.rate directly. Use nodes, so novice users can easily read the flow.\n\n// Thresholds for change in power, before switching to high rate limit\nconst THRESHOLD_POWER = 20; // Watt change\nconst THRESHOLD_PERCENT = 2; // Percentage\nRED.util.setMessageProperty(msg, \"p1_rate_limit.threshold_power\", THRESHOLD_POWER,true);\nRED.util.setMessageProperty(msg, \"p1_rate_limit.threshold_percent\", THRESHOLD_PERCENT, true);\n\n// Get the previous value from this node's context\n// If it doesn't exist yet, initialize it as null\nlet previousValue = context.get('previousValue') || null;\nlet currentValue = Number(msg.grid_power);\n\n// Save the current value for the next time the node is triggered\ncontext.set('previousValue', currentValue);\n\n// Default rate limiting\nRED.util.setMessageProperty(msg,\"p1_rate_limit.save_power\",true);\n\n// Check if we have a valid history to compare with\nif (previousValue !== null) {\n    let powerChange = Math.abs(currentValue - previousValue);\n    let percentageChange = previousValue !== 0 ? Math.abs((powerChange / previousValue) * 100):0;\n\n    // Condition: Absolute difference > N Watt AND percentage change > M %\n    if (powerChange > THRESHOLD_POWER && percentageChange > THRESHOLD_PERCENT) {\n        // Enable faster refresh rate\n        RED.util.setMessageProperty(msg,\"p1_rate_limit.save_power\",false);\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 280,
        "wires": [
            [
                "fba8ee89ee4b48fc"
            ]
        ]
    },
    {
        "id": "fec3163cf6e896b0",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "88fcf7fce2bcee4a",
        "name": "CPU power saved",
        "func": "// Logger\nconst logger = global.get(\"logger\");\n\n// Passed or blocked\nconst hasPassed = msg.payload; // 0 = blocked, 1 = passed\n\n// 1. Get evaluations (Total attempts)\nlet evaluations = (context.get(\"p1_rate_limit_evaluations\") || 0) + 1;\ncontext.set(\"p1_rate_limit_evaluations\", evaluations);\n\n// 2. Increment and get passes (Filtered/successful events)\nlet passes = (context.get(\"p1_rate_limit_passes\") || 0) + hasPassed;\ncontext.set(\"p1_rate_limit_passes\", passes);\n\n// 3a. Calculate percentage (Rate of passing vs total evaluations)\nlet percentage = evaluations > 0 ? (passes / evaluations) * 100 : 0;\n// 3b. Display the percentage rate of not-passing as a measure of efficiency gained\npercentage = 100 - percentage;\n\n// 4. Update Node Status\nnode.status({\n    fill: \"blue\",\n    shape: \"dot\",\n    text: `Saved: ${percentage.toFixed(2)}% (${evaluations-passes}/${evaluations})`\n});\n\n// 5. Explain\n// On block\nif(hasPassed === 0) {\n    if(msg.p1_rate_limit.save_power === true) {\n        // This is good\n        logger(this, `<font color=\"#009ac7\">Power saved</font> by P1 Rate Limiter, execution stopped.`); \n    } else {\n        // This is not so good. P1 updates are coming in fast.\n        logger(this, `<font color=\"orange\">Blocked</font> by P1 Rate Limiter. ${Number(1000/msg.rate).toFixed(2)} messages per second exceeded.`); \n    }\n    \n    // Send message onward to debug dashboard\n    return msg;\n}\n// No output on pass\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1270,
        "y": 280,
        "wires": [
            [
                "086ab78b88da7870"
            ]
        ]
    },
    {
        "id": "8eda290fc8979d34",
        "type": "debug",
        "z": "6d6573264ad03a3a",
        "g": "a97e9944723199fb",
        "name": "Strategy evaluation",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 750,
        "y": 1060,
        "wires": []
    },
    {
        "id": "56abef824695d21f",
        "type": "api-call-service",
        "z": "6d6573264ad03a3a",
        "g": "e665b7fd4de79095",
        "name": "Show on dashboard",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_text.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_text.house_battery_strategy_active_sub_strategy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.ui_value_new}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_text",
        "service": "set_value",
        "x": 1760,
        "y": 1060,
        "wires": [
            []
        ]
    },
    {
        "id": "dc9da6c1bd3fc1aa",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "e665b7fd4de79095",
        "name": "current UI value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_text.house_battery_strategy_active_sub_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "ui_value_current",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1360,
        "y": 1060,
        "wires": [
            [
                "44fd249c78ab67bd"
            ]
        ]
    },
    {
        "id": "44fd249c78ab67bd",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "e665b7fd4de79095",
        "name": "on new UI value",
        "func": "// Block when undefined (don't update UI)\nif(msg.ui_value_current === undefined) return null;\n\n// We show the 2nd strategy in the trace (if available) on the dashboard as the 'active sub-strategy'\nconst secondTraceEntry = msg.strategy?.trace?.[1];\nif (secondTraceEntry) {\n    // Handle case where 2nd flow is present\n    msg.ui_value_new =  secondTraceEntry.flow;\n} else {\n    // Handle case where the 2nd flow is missing\n    // Get a sensible alternative\n    msg.ui_value_new = msg.strategy?.selected || \"\"; // don't use unknown or unavailable as these are reserved HA keywords\n}\n\n// Improve human readability\nif(msg.ui_value_new == \"Self-consumption\" && secondTraceEntry?.flow_settings?.discharge_disabled === true){\n    msg.ui_value_new = \"Self-consumption (charge only)\";\n}\nif(msg.ui_value_new == \"Self-consumption\" && secondTraceEntry?.flow_settings?.charge_disabled === true){\n    msg.ui_value_new = \"Self-consumption (no charging)\";\n}\nif(msg.strategy?.is_peak_shaving === true){\n    msg.ui_value_new = \"Peak shaving\";\n}\n\n// Node status for devs\nnode.status({fill:\"grey\",shape:\"dot\",text:`new: ${msg.ui_value_new}`});\n\n// Block when equal (don't update UI)\nif(msg.ui_value_current === msg.ui_value_new) return null;\n\n// Pass otherwise\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1560,
        "y": 1060,
        "wires": [
            [
                "56abef824695d21f"
            ]
        ]
    },
    {
        "id": "a0d759138bea0dff",
        "type": "ha-fire-event",
        "z": "6d6573264ad03a3a",
        "g": "9ee535cb3eb4e7de",
        "name": "Show on debug board",
        "server": "176d29a.6f648d6",
        "version": 0,
        "event": "update_trace_sensor",
        "data": "{\t   \"trace\": $$.strategy.trace ? $$.strategy.trace : [],\t   \"start\": $$.strategy.execution_start ? $$.strategy.execution_start : 0,\t   \"end\": $$.strategy.execution_end ? $$.strategy.execution_end : 0,\t   \"log\": $$.log ? $$.log : []\t}",
        "dataType": "jsonata",
        "x": 1740,
        "y": 1420,
        "wires": [
            []
        ]
    },
    {
        "id": "4bc60310535b5527",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "5ec74f315607b21a",
        "name": "Insight mode",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_control_is_debug_mode",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "debug_mode",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 130,
        "y": 160,
        "wires": [
            [
                "87d556b9aa8e2018"
            ]
        ]
    },
    {
        "id": "6eb943fb97982e10",
        "type": "switch",
        "z": "6d6573264ad03a3a",
        "g": "9ee535cb3eb4e7de",
        "name": "Debug mode?",
        "property": "debug_mode",
        "propertyType": "global",
        "rules": [
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1540,
        "y": 1420,
        "wires": [
            [
                "a0d759138bea0dff"
            ]
        ]
    },
    {
        "id": "a223b27d5a82c21f",
        "type": "server-state-changed",
        "z": "6d6573264ad03a3a",
        "g": "5ec74f315607b21a",
        "name": "Turned ON",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 2,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_boolean.house_battery_control_is_debug_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "on",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 420,
        "y": 160,
        "wires": [
            [
                "32b488cab4768a25"
            ],
            []
        ]
    },
    {
        "id": "32b488cab4768a25",
        "type": "trigger",
        "z": "6d6573264ad03a3a",
        "g": "5ec74f315607b21a",
        "name": "disable after 5 minutes",
        "op1": "",
        "op2": "off",
        "op1type": "nul",
        "op2type": "str",
        "duration": "5",
        "extend": false,
        "overrideDelay": false,
        "units": "min",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 600,
        "y": 160,
        "wires": [
            [
                "7e21d1cc2f826d01"
            ]
        ]
    },
    {
        "id": "7e21d1cc2f826d01",
        "type": "api-call-service",
        "z": "6d6573264ad03a3a",
        "g": "5ec74f315607b21a",
        "name": "Turn insight OFF",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_off",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.house_battery_control_is_debug_mode"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_boolean",
        "service": "turn_off",
        "x": 810,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "dfd59246e01132df",
        "type": "delay",
        "z": "6d6573264ad03a3a",
        "g": "8267344b22de78fa",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1580,
        "y": 60,
        "wires": [
            [
                "0d5e5f7418e6d09a"
            ]
        ]
    },
    {
        "id": "7ed978df24edaebe",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "898b7b1dab809dca",
        "name": "Custom logger",
        "func": "/**\n * Custom Logger Function\n * * Provides centralized logging, node-status updates, and message tracing.\n * Specifically designed for Home Battery Control logic within Node-RED.\n * \n * Debug dashboard updating:\n * A msg needs to reach 'Strategy Evaluation' or be passed to the \"Show on debug board\" trigger node.\n * Errors are automatically passed to the \"Show on debug board\" trigger node.\n * \n * * @param {object} callingNode - The context of the calling node (pass 'this').\n * @param {string} text - The log message/explanation.\n * @param {string} level - Log level: 'log', 'warn', 'error', or 'info' (default: 'info').\n * \n * Note: anything above 'info' will also write to the Node-RED log files \n * \n * * @usage: \n * const log = global.get(\"logger\");\n * log(this, \"Charging cycle started\");\n */\nconst customLogger = (callingNode, text, level = 'info') => {\n    \n    // Log only when debug_mode is ON\n    const debug_mode = global.get(\"debug_mode\") || false;\n    if(debug_mode == false) return null;\n\n    // Max log elements to keep\n    const MAX_ELEMENTS = 100;\n\n    // Create the YYYY-MM-DD HH:MM:SS.mmm format\n    const now = new Date();\n    const timestamp = now.getHours().toString().padStart(2, '0') + \":\" +\n                now.getMinutes().toString().padStart(2, '0') + \":\" +\n                now.getSeconds().toString().padStart(2, '0') + \".\" +\n                now.getMilliseconds().toString().padStart(3, '0');\n\n    const formattedTimeLevel = `${timestamp} [${level.toLowerCase()}]`;\n    \n    // Get the name of the node or fallback to the ID\n    const nodeName = callingNode.__node__ ? callingNode.__node__.name || callingNode.__node__.id : undefined;\n    // Get the name of the Flow/Tab\n    const flowName = callingNode.env.get(\"NR_FLOW_NAME\") || \"Unknown flow\";\n    // Explain to the Home Battery Control user what is going on\n    const formattedExplenation = `[${flowName} >> ${nodeName}]: ${text}`;\n\n    // Level icons\n    let icon = \"⚪\";\n    switch (level) {\n        case \"info\":\n            icon = \"ℹ️\";\n            break;\n        case \"log\":\n            icon = \"🔧\";\n            break;\n        case \"warn\":\n            icon = \"⚠️\";      \n            break;\n        case \"error\":\n            icon = \"❌\";\n            break;\n    }\n\n    // Enrich msg with log info\n    const msg = callingNode.msg;\n    (msg.log = msg.log || []).push({ timestamp: timestamp, level:level, flow:flowName, node:nodeName, payload: text, icon: icon});\n\n    if (msg.log.length > MAX_ELEMENTS) {\n        // Slice keeps the last X elements\n        msg.log = msg.log.slice(-MAX_ELEMENTS);\n    }\n\n    // Log to the Node-RED system log\n    switch (level) {\n        case \"log\":\n            node.log(`${formattedExplenation}`);\n            break;\n        case \"warn\":\n            node.warn(`${formattedExplenation}`);       \n            break;\n        case \"error\":\n            node.error(`${formattedExplenation}`, callingNode.msg);\n            break;\n        default:\n            // don't log to logfiles by default\n    }\n\n};\n\nglobal.set('logger', customLogger);\nglobal.set('unhandledException', \"\");\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1740,
        "y": 160,
        "wires": [
            [
                "c6d63f7293decd42"
            ]
        ]
    },
    {
        "id": "24d61d6a6d2cd81c",
        "type": "change",
        "z": "6d6573264ad03a3a",
        "g": "88fcf7fce2bcee4a",
        "name": "Pass",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "1",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1110,
        "y": 300,
        "wires": [
            [
                "fec3163cf6e896b0",
                "08279debefcd5bf3"
            ]
        ]
    },
    {
        "id": "324924b135aee546",
        "type": "change",
        "z": "6d6573264ad03a3a",
        "g": "88fcf7fce2bcee4a",
        "name": "Block",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1110,
        "y": 260,
        "wires": [
            [
                "fec3163cf6e896b0"
            ]
        ]
    },
    {
        "id": "c13af3530f6f620f",
        "type": "link in",
        "z": "6d6573264ad03a3a",
        "g": "9ee535cb3eb4e7de",
        "name": "Update debug dashboard",
        "links": [
            "086ab78b88da7870",
            "890fc9c1620e7264",
            "bfde4771b0ea78bf"
        ],
        "x": 1395,
        "y": 1360,
        "wires": [
            [
                "6eb943fb97982e10",
                "bd98c464479e7091"
            ]
        ]
    },
    {
        "id": "086ab78b88da7870",
        "type": "link out",
        "z": "6d6573264ad03a3a",
        "g": "88fcf7fce2bcee4a",
        "name": "goto Debug Dashboard update",
        "mode": "link",
        "links": [
            "c13af3530f6f620f"
        ],
        "x": 1395,
        "y": 280,
        "wires": []
    },
    {
        "id": "ea1ec88bd07ed287",
        "type": "catch",
        "z": "6d6573264ad03a3a",
        "g": "9ee535cb3eb4e7de",
        "name": "Custom logger",
        "scope": [
            "7ed978df24edaebe"
        ],
        "uncaught": false,
        "x": 1340,
        "y": 1480,
        "wires": [
            [
                "6eb943fb97982e10",
                "11c3f338273ae27c"
            ]
        ]
    },
    {
        "id": "11c3f338273ae27c",
        "type": "debug",
        "z": "6d6573264ad03a3a",
        "g": "9ee535cb3eb4e7de",
        "name": "Via Catch",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "counter",
        "x": 1520,
        "y": 1480,
        "wires": []
    },
    {
        "id": "bd98c464479e7091",
        "type": "debug",
        "z": "6d6573264ad03a3a",
        "g": "9ee535cb3eb4e7de",
        "name": "Via link",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "counter",
        "x": 1520,
        "y": 1360,
        "wires": []
    },
    {
        "id": "890fc9c1620e7264",
        "type": "link out",
        "z": "6d6573264ad03a3a",
        "g": "0964eecbbf0f7e7a",
        "name": "link out 1",
        "mode": "link",
        "links": [
            "c13af3530f6f620f"
        ],
        "x": 285,
        "y": 1160,
        "wires": []
    },
    {
        "id": "ab8c8ba194b61d31",
        "type": "switch",
        "z": "6d6573264ad03a3a",
        "g": "88fcf7fce2bcee4a",
        "name": "Skip rate limiter during debug",
        "property": "debug_mode",
        "propertyType": "global",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 180,
        "y": 280,
        "wires": [
            [
                "bad0d99aae2e98d9"
            ],
            [
                "08279debefcd5bf3"
            ]
        ]
    },
    {
        "id": "87d556b9aa8e2018",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "5ec74f315607b21a",
        "name": "Notice",
        "func": "// enable or disable Insights Mode\nif(msg.debug_mode == \"on\"){\n    // ENABLED - explain to user\n    const log = global.get(\"logger\");\n    log(this, \"P1 Rate limiter is *disabled* during *debug mode*\");\n\n    // Set global (setting this via current state node has proven irriliable)\n    global.set(\"debug_mode\", true);\n} else {\n    // DISABLED - set global\n    global.set(\"debug_mode\", false);\n}\n\n// Clean up - only use the global\ndelete msg.debug_mode;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 235,
        "y": 160,
        "wires": [
            [
                "aba9ea9f8ab8f722"
            ]
        ],
        "l": false
    },
    {
        "id": "013199a4b3ebae10",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "95256b97b46131d4",
        "name": "SoC min",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.marstek_m{{battery_index}}_discharging_cutoff_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "discharging_cutoff_capacity",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1000,
        "y": 500,
        "wires": [
            [
                "9e355ab881d25d6a"
            ]
        ]
    },
    {
        "id": "9e355ab881d25d6a",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "95256b97b46131d4",
        "name": "SoC max",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.marstek_m{{battery_index}}_charging_cutoff_capacity",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charging_cutoff_capacity",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1140,
        "y": 500,
        "wires": [
            [
                "ebfa02d4702cd66f"
            ]
        ]
    },
    {
        "id": "c6d63f7293decd42",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "898b7b1dab809dca",
        "name": "Unhandled Exception",
        "func": "/**\n * Handles exceptions by extracting node details and routing them to a global logger.\n * This is designed to be called from within a Node-RED Function node or sub-flow.\n *\n * @param {Object} callingNode - The Node-RED 'this' context or msg object containing node metadata.\n * @param {Object} [callingNode.msg] - The message object associated with the error.\n * @param {Object} [callingNode.msg.error] - Error details provided by a Node-RED error catch.\n * @param {string} [callingNode.msg.error.message] - The specific error message.\n * @param {Object} [callingNode.msg.error.source] - The node that triggered the error.\n * * @example\n * // Usage in a Function Node:\n * const unhandledException = global.get('unhandledException');\n * unhandledException(this);\n */\nconst unhandledException = (callingNode) => {\n    // 1. Get the custom logger from global context\n    const log = global.get(\"logger\");\n\n    // 2. Extract error details from the msg object\n    const errorData = callingNode.msg?.error || {};\n    const errorMessage = errorData.message || \"Unknown error occurred\";\n    const sourceName = errorData.source ? (errorData.source.name || errorData.source.id) : \"Unknown Node\";\n    const sourceType = errorData.source ? errorData.source.type : \"unknown-type\";\n\n    // 3. Construct a user-friendly message for the logger\n    const friendlyMessage = `**Unhandled exception** (${sourceType} node) ${errorMessage}`;\n    callingNode.__node__ ??= {};\n    callingNode.__node__.name = sourceName;\n\n    // 4. Call the logger with level 'error'\n    // Note: the logger uses 'callingNode', we pass on whatever we have.\n    log(callingNode, friendlyMessage, 'error');\n\n};\n\nglobal.set('unhandledException', unhandledException);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1760,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "750202927e4513df",
        "type": "catch",
        "z": "6d6573264ad03a3a",
        "g": "4dc546f97d680fb2",
        "name": "",
        "scope": null,
        "uncaught": true,
        "x": 1745,
        "y": 320,
        "wires": [
            [
                "25a27f5620d0354b"
            ]
        ],
        "l": false
    },
    {
        "id": "25a27f5620d0354b",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "4dc546f97d680fb2",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1795,
        "y": 320,
        "wires": [
            [
                "bfde4771b0ea78bf"
            ]
        ],
        "l": false
    },
    {
        "id": "bfde4771b0ea78bf",
        "type": "link out",
        "z": "6d6573264ad03a3a",
        "g": "4dc546f97d680fb2",
        "name": "link out 9",
        "mode": "link",
        "links": [
            "c13af3530f6f620f"
        ],
        "x": 1845,
        "y": 320,
        "wires": []
    },
    {
        "id": "81af9004a8886111",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "a97e9944723199fb",
        "name": "Battery Strategy",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy",
                "propertyType": "flow",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 140,
        "y": 980,
        "wires": [
            [
                "1ee5caeed0824366"
            ]
        ]
    },
    {
        "id": "1ee5caeed0824366",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "a97e9944723199fb",
        "name": "Full Stop Trigger",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.ev_is_charging",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "full_stop_trigger",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 320,
        "y": 980,
        "wires": [
            [
                "e90efd5896b1c62e"
            ]
        ]
    },
    {
        "id": "7663aa8bf97d6dff",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "3ebe5e0624e2e1bf",
        "name": "Has import limit?",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_control_has_power_limit_import",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "grid_power_has_limit_import",
                "propertyType": "msg",
                "value": "$entity().state = \"on\"",
                "valueType": "jsonata"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 150,
        "y": 880,
        "wires": [
            [
                "4e88791ddce0c6b1"
            ]
        ]
    },
    {
        "id": "4e88791ddce0c6b1",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "3ebe5e0624e2e1bf",
        "name": "Has export limit?",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_control_has_power_limit_export",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "grid_power_has_limit_export",
                "propertyType": "msg",
                "value": "$entity().state = \"on\"",
                "valueType": "jsonata"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 880,
        "wires": [
            [
                "20b518c724e8297f"
            ]
        ]
    },
    {
        "id": "aba9ea9f8ab8f722",
        "type": "function",
        "z": "6d6573264ad03a3a",
        "g": "5ec74f315607b21a",
        "name": "Grid power",
        "func": "const log = global.get(\"logger\");\n\n// prepare grid power message\nlet state = \"measure\";\nlet ending = \"\";\nif(msg.grid_power>0) {state = \"import\"; ending = \"from grid\";}\nif(msg.grid_power<0) {state = \"export\"; ending = \"to grid\";}\nconst displayPower = Math.abs(Math.round(msg.grid_power));\n\n// explain\nlog(this, `You currently ${state} ${displayPower} W ${ending}`);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 285,
        "y": 160,
        "wires": [
            [
                "ab8c8ba194b61d31"
            ]
        ],
        "l": false
    },
    {
        "id": "20b518c724e8297f",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "3ebe5e0624e2e1bf",
        "name": "Import limit",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_power_limit_import",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "grid_power_limit_import",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 530,
        "y": 880,
        "wires": [
            [
                "c24efbb623d003f5"
            ]
        ]
    },
    {
        "id": "c24efbb623d003f5",
        "type": "api-current-state",
        "z": "6d6573264ad03a3a",
        "g": "3ebe5e0624e2e1bf",
        "name": "Export limit",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_power_limit_export",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "grid_power_limit_export",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 690,
        "y": 880,
        "wires": [
            [
                "81af9004a8886111"
            ]
        ]
    },
    {
        "id": "b49db4d0a798f164",
        "type": "api-current-state",
        "z": "60b5d8044cd240a3",
        "g": "d608a4a32e0df080",
        "name": "Your battery count",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_count",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "battery_count",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 60,
        "wires": [
            [
                "5321fe5ab7f757a6"
            ]
        ]
    },
    {
        "id": "1457af64557f3041",
        "type": "function",
        "z": "60b5d8044cd240a3",
        "g": "880b4bd707f6cd0b",
        "name": "Set RS485 and Work Modes",
        "func": "// array for output \nlet outputArray = [];\n\n// battery to target\nconst target = `marstek_m${msg.battery_index}`;\n\n// Set | work mode\nconst workModeAction = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_user_work_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.work_mode)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.work_mode ? { payload: workModeAction, topic:\"user_work_mode\"}: null);\n\n// Set | rs485\nconst rs485Action = {\n    \"action\": \"select.select_option\",\n    \"target\": {\n        \"entity_id\": [`select.${target}_rs485_control_mode`]\n    },\n    \"data\": {\n         \"option\": String(msg.rs485)\n    }\n};\n// Add to output array. Set null for no action.\noutputArray.push(msg.rs485 ? { payload: rs485Action, topic: \"rs485_control_mode\" } : null);\n\n// Store calls in msg to allow checking of loop results\nmsg.loop_result = { target, workModeAction, rs485Action };\n\n// Return msg as third output\noutputArray.push(msg);\n\n// Outputs\nreturn outputArray;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 180,
        "wires": [
            [
                "b3a11a0e32755bcc"
            ],
            [
                "0d5735b73237bcd7"
            ],
            [
                "bc51a1a250c21426"
            ]
        ]
    },
    {
        "id": "5321fe5ab7f757a6",
        "type": "function",
        "z": "60b5d8044cd240a3",
        "g": "d608a4a32e0df080",
        "name": "Loop start",
        "func": "// loop through the number of batteries set by the user\nmsg.battery_index = 1; // base-1\n\n// configurables\nlet workMode = null; // manual, anti-feed, ai, null = don't set or alter this setting\nlet rs485 = null;  // enable, disable, null = don't set or alter this setting\n\n// mode select\nswitch (msg.marstek_master_battery_mode) {\n    case \"Manual control\":\n        workMode = \"manual\";\n        rs485 = \"disable\";\n        break;\n    case \"Marstek control\":\n        // the user should select a work mode via the Marstek App or via select.marstek_mX_user_work_mode\n        rs485 = \"disable\";\n        break;\n    case \"Full control\":\n        rs485 = \"enable\";\n        break;\n    default:\n        node.status({fill:\"red\",shape:\"ring\",text:`Unhandled mode: ${msg.marstek_master_battery_mode}`});\n        return null; // stop flow\n}\n\n// Continue\nmsg.work_mode = workMode;\nmsg.rs485 = rs485;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 180,
        "wires": [
            [
                "1457af64557f3041"
            ]
        ]
    },
    {
        "id": "bc51a1a250c21426",
        "type": "function",
        "z": "60b5d8044cd240a3",
        "g": "880b4bd707f6cd0b",
        "name": "Loop step",
        "func": "// Step index down\nmsg.battery_index += 1;\n\n// Continue\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 240,
        "wires": [
            [
                "dacfd8968c7ae3a0",
                "9d1fca88cd539df4"
            ]
        ]
    },
    {
        "id": "dacfd8968c7ae3a0",
        "type": "switch",
        "z": "60b5d8044cd240a3",
        "g": "880b4bd707f6cd0b",
        "name": "Loop until",
        "property": "battery_index",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lte",
                "v": "battery_count",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 640,
        "y": 240,
        "wires": [
            [
                "1457af64557f3041"
            ],
            [
                "3cc99e704b42536a"
            ]
        ]
    },
    {
        "id": "b3a11a0e32755bcc",
        "type": "api-call-service",
        "z": "60b5d8044cd240a3",
        "g": "880b4bd707f6cd0b",
        "name": "Set work mode",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 800,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "0d5735b73237bcd7",
        "type": "api-call-service",
        "z": "60b5d8044cd240a3",
        "g": "880b4bd707f6cd0b",
        "name": "Set RS485",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "input_text",
        "service": "set_value",
        "x": 790,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "9d1fca88cd539df4",
        "type": "debug",
        "z": "60b5d8044cd240a3",
        "g": "880b4bd707f6cd0b",
        "name": "Loop result",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "loop_result",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 510,
        "y": 280,
        "wires": []
    },
    {
        "id": "3cc99e704b42536a",
        "type": "debug",
        "z": "60b5d8044cd240a3",
        "g": "d608a4a32e0df080",
        "name": "Done",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 360,
        "wires": []
    },
    {
        "id": "052a65658a9d42a7",
        "type": "server-state-changed",
        "z": "60b5d8044cd240a3",
        "g": "d608a4a32e0df080",
        "name": "Master control mode",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.marstek_master_battery_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            },
            {
                "property": "marstek_master_battery_mode",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 150,
        "y": 60,
        "wires": [
            [
                "b49db4d0a798f164"
            ]
        ]
    },
    {
        "id": "81f3b4928caf43d3",
        "type": "server-state-changed",
        "z": "f13f7130a1bda6e5",
        "g": "7079a558e93bec2b",
        "name": "PID preset selected",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.house_battery_control_pid_presets"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 150,
        "y": 100,
        "wires": [
            [
                "995a5b9d3081cc07"
            ]
        ]
    },
    {
        "id": "5c4059cc4c601488",
        "type": "api-call-service",
        "z": "f13f7130a1bda6e5",
        "g": "7079a558e93bec2b",
        "name": "Kp",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_kp"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "e8f07307252629ab",
        "type": "api-call-service",
        "z": "f13f7130a1bda6e5",
        "g": "7079a558e93bec2b",
        "name": "Ki",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_ki"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "8b2d473346c90dd3",
        "type": "api-call-service",
        "z": "f13f7130a1bda6e5",
        "g": "7079a558e93bec2b",
        "name": "Kd",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_kd"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 510,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "995a5b9d3081cc07",
        "type": "function",
        "z": "f13f7130a1bda6e5",
        "g": "7079a558e93bec2b",
        "name": "Presets",
        "func": "// See: house_battery_control.yaml > input_select: > house_battery_control_pid_presets\nconst preset = RED.util.getMessageProperty(msg,\"payload\");\nnode.status({fill:\"green\",shape:\"dot\",text:`${preset}`});\n\n\n// Default values\nlet Kp = 0; // Proportional gain\nlet Ki = 0; // Integral gain\nlet Kd = 0; // Differentiating gain\nlet Si = 0; // % Input smoothing (a Low pass moving average filter)\nlet So = 0; // % Output smoothing (a Low pass moving average filter)\n\nswitch (preset) {\n    // For people who have unstable systems with every other preset\n    case \"Very safe\":\n        Kp = 0.1;\n        Ki = 0.1;\n        Si = 0; // without Kd, this is preferred to be zero.\n        So = 10; // %\n        break;\n    // Good starting point for most\n    case \"Safe\":\n        Kp = 0.3;\n        Ki = 0.3;\n        Kd = 0.1;\n        Si = 20; // %\n        So = 0; // %\n        break;\n    // Gitcodebob's October 2025 settings for 3.2kWp PV and 5kW battery transformer power\n    case \"Regular\":\n        Kp = 0.3;\n        Ki = 0.4;\n        Kd = 0.8;\n        Si = 50; // % This high amount of filtering allows the stronger Kd\n        So = 10; // %\n        break;\n    default:\n        // Don't change values\n        return null;\n}\n\n// Prepare for three outputs\nreturn [\n    { \"payload\": Kp },\n    { \"payload\": Ki },\n    { \"payload\": Kd },\n    { \"payload\": Si },\n    { \"payload\": So }\n];",
        "outputs": 5,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 100,
        "wires": [
            [
                "5c4059cc4c601488"
            ],
            [
                "e8f07307252629ab"
            ],
            [
                "8b2d473346c90dd3"
            ],
            [
                "212a37e25ff47b65"
            ],
            [
                "e7afca1d4d663337"
            ]
        ]
    },
    {
        "id": "212a37e25ff47b65",
        "type": "api-call-service",
        "z": "f13f7130a1bda6e5",
        "g": "7079a558e93bec2b",
        "name": "Input Smooth",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_signal_dampening"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 530,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "e7afca1d4d663337",
        "type": "api-call-service",
        "z": "f13f7130a1bda6e5",
        "g": "7079a558e93bec2b",
        "name": "Output Smoothing",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output_dampening"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 550,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "89f0171af7bed142",
        "type": "link in",
        "z": "f83cd63ed7d0d814",
        "g": "cb177c6ca1393bd2",
        "name": "Charge PV",
        "links": [],
        "x": 100,
        "y": 160,
        "wires": [
            [
                "ad62321a4add6f68"
            ]
        ],
        "l": true
    },
    {
        "id": "940d99acae4db257",
        "type": "comment",
        "z": "f83cd63ed7d0d814",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "92f6e88e554e16a2",
        "type": "comment",
        "z": "f83cd63ed7d0d814",
        "g": "cb177c6ca1393bd2",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "18d05bd09ef21e2e",
        "type": "link out",
        "z": "f83cd63ed7d0d814",
        "g": "73f736190ffadcc1",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 1225,
        "y": 160,
        "wires": []
    },
    {
        "id": "57e5da87485c45f0",
        "type": "comment",
        "z": "f83cd63ed7d0d814",
        "g": "73f736190ffadcc1",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 1280,
        "y": 100,
        "wires": []
    },
    {
        "id": "3758738fbf3722bb",
        "type": "function",
        "z": "f83cd63ed7d0d814",
        "g": "e414eaa3b7355fb0",
        "name": "Charge PV",
        "func": "// explain\nconst log = global.get(\"logger\");\nlog(this,\"Using `Self-consumption` to charge with surplus PV\")\n\n// use the self consumption strategy to charge when there is PV surplus\nmsg.target = \"Self-consumption\";\n\n// tell that strategy to disallow discharging\nconst DISCHARGE_DISABLED = true;\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\",DISCHARGE_DISABLED,true);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 160,
        "wires": [
            [
                "1239f4f256efec3b"
            ]
        ]
    },
    {
        "id": "1239f4f256efec3b",
        "type": "link call",
        "z": "f83cd63ed7d0d814",
        "g": "e414eaa3b7355fb0",
        "name": "Self-consumption",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 890,
        "y": 160,
        "wires": [
            [
                "18d05bd09ef21e2e"
            ]
        ]
    },
    {
        "id": "ad62321a4add6f68",
        "type": "change",
        "z": "f83cd63ed7d0d814",
        "g": "cb177c6ca1393bd2",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 90,
        "y": 200,
        "wires": [
            [
                "ce7695fcaa95225d"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "00f441452996487b",
        "type": "catch",
        "z": "f83cd63ed7d0d814",
        "g": "019e3238abe7b610",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 55,
        "y": 300,
        "wires": [
            [
                "c469b3340295cf43"
            ]
        ],
        "l": false
    },
    {
        "id": "c469b3340295cf43",
        "type": "function",
        "z": "f83cd63ed7d0d814",
        "g": "019e3238abe7b610",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 105,
        "y": 300,
        "wires": [
            [
                "87fbf5acfad8259f"
            ]
        ],
        "l": false
    },
    {
        "id": "87fbf5acfad8259f",
        "type": "link out",
        "z": "f83cd63ed7d0d814",
        "g": "019e3238abe7b610",
        "name": "link out 4",
        "mode": "return",
        "links": [],
        "x": 155,
        "y": 300,
        "wires": []
    },
    {
        "id": "ce7695fcaa95225d",
        "type": "function",
        "z": "f83cd63ed7d0d814",
        "name": "Mode selection",
        "func": "/* Mode selection \n * \n * Peak shaving can be triggered by:\n * - Grid power exceeds the import/export limit set by the user\n * \n * Peak shaving will persist while:\n * - Grid power exceeds the import/export limit set by the user\n * - Batteries are applied to keep system below the limit set by the user\n * \n * The first is checked in this node.\n * The latter is checked in the last function node of the Peak Shaving flow.\n * Both set the `last_power_limit_violation` flow variable to Date.now() to persist peak shaving.\n * \n * PEAK_SHAVING_TIMEOUT_SEC is advised to be kept above atleast 3-5 seconds, to account for rate limiters and other power saving options.\n*/\n\n// Timestamp\nconst now = Date.now();\n\n// Logger\nconst log = global.get(\"logger\");\n\n// Configuration & State recovery\nconst PEAK_SHAVING_TIMEOUT_SEC = 10;\nlet isPeakShaving = flow.get(\"is_peak_shaving\") ?? false;\nlet lastPowerLimitViolation = flow.get(\"last_power_limit_violation\") ?? now;\nlet isPowerLimitViolation = false;\n\n// Input Data\nconst hasImportLimit = RED.util.getMessageProperty(msg, \"grid_power_has_limit_import\") || false;\nconst importLimit = parseInt(RED.util.getMessageProperty(msg, \"grid_power_limit_import\") || 0);\nconst P1_power = parseInt(RED.util.getMessageProperty(msg, \"grid_power\") || 0);\n\n// ACTIVATE shaving\nif (hasImportLimit && (P1_power > importLimit)) {\n    isPeakShaving = true;\n    isPowerLimitViolation = true;\n}\n\n// UPDATE timer or continue\nif (isPowerLimitViolation) lastPowerLimitViolation = now;\n\n// CALCULATE release logic\n// Seconds since the last time the power limit was exceeded\nlet secondsSinceLastViolation = Math.floor((now - lastPowerLimitViolation) / 1000);\n\n// RELEASE shaving logic\n// Only release if we are currently shaving AND the timeout has passed\nif (isPeakShaving && (secondsSinceLastViolation >= PEAK_SHAVING_TIMEOUT_SEC)) {\n    isPeakShaving = false;\n    log(this,\"Peak Shaving released, resume normal operation\");\n}\n\n// UI & OUTPUT Logic\nif (isPeakShaving) {\n    // Timeout progress\n    const secondsRemaining = PEAK_SHAVING_TIMEOUT_SEC - secondsSinceLastViolation;\n    // Set grid power limit\n    msg.payload = importLimit;\n    // UI\n    node.status({\n        fill: \"yellow\",\n        shape: \"dot\",\n        text: isPowerLimitViolation ? `Peak Shaving` :`Peak Shaving: release in ${secondsRemaining}s`\n    });\n} else {\n    // UI\n    node.status({\n        fill: \"green\",\n        shape: \"dot\",\n        text: \"Grid OK - Charging PV\"\n    });\n}\n\n// Persist state for next run\nflow.set(\"is_peak_shaving\", isPeakShaving); \nif (isPowerLimitViolation) flow.set(\"last_power_limit_violation\", now); // Power limit exceeded. Update the lastPowerLimitViolation timestamp to current time\n\n// Finalize msg\nRED.util.setMessageProperty(msg, \"strategy.is_peak_shaving\", isPeakShaving, true);\n\n// OUTPUT\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 200,
        "wires": [
            [
                "5ef5502801e31193"
            ]
        ]
    },
    {
        "id": "5ef5502801e31193",
        "type": "switch",
        "z": "f83cd63ed7d0d814",
        "name": "Operating mode",
        "property": "strategy.is_peak_shaving",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 500,
        "y": 200,
        "wires": [
            [
                "3758738fbf3722bb"
            ],
            [
                "583ad663ebdd9403"
            ]
        ]
    },
    {
        "id": "583ad663ebdd9403",
        "type": "function",
        "z": "f83cd63ed7d0d814",
        "g": "19f34bd52acbc97f",
        "name": "Peak shaving",
        "func": "// Logger\nconst log = global.get(\"logger\");\n\n// Explain\nlog(this,`**Peak shaving mode** postponing '${msg.target}' strategy`);\n\n// Use the PID controller strategy\nmsg.target = \"Self-consumption\";\n// Set the grid power limit\nmsg.house_target_grid_consumption_in_w = msg.payload;\n// Tell the strategy to discharging only\nconst CHARGE_DISABLED = true;\nRED.util.setMessageProperty(msg, \"advanced_settings.charge_disabled\", CHARGE_DISABLED, true);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 260,
        "wires": [
            [
                "2d6c590194d3f46f"
            ]
        ]
    },
    {
        "id": "2d6c590194d3f46f",
        "type": "link call",
        "z": "f83cd63ed7d0d814",
        "g": "19f34bd52acbc97f",
        "name": "Self-consumption",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 890,
        "y": 260,
        "wires": [
            [
                "717bc3ddc3258751"
            ]
        ]
    },
    {
        "id": "717bc3ddc3258751",
        "type": "function",
        "z": "f83cd63ed7d0d814",
        "g": "19f34bd52acbc97f",
        "name": "Peak check",
        "func": "// Logger\nconst log = global.get(\"logger\");\n\n// INPUT\nconst PID_assigned = msg.pid?.load_assigned ?? 0; // calculated battery power delivery, see footnote_1 why this is 0 by default\nconst isCharging = msg.batteries_charging || false;\n\n// HOLD peak shave when:\nif(PID_assigned > 0 && !isCharging) {\n    // The batteries are still required to reduce the power peak\n    log(this,`**Peak shaving continues**, batteries still required for peak reduction`);\n    // Reset timeout timer\n    flow.set(\"last_power_limit_violation\", Date.now()); \n    // UI\n    node.status({fill:\"yellow\",shape:\"dot\",text:`Holding peak shave, batteries still required for ${PID_assigned} W`});\n} else {\n    // No solution or batteries not required - let timer run out\n    node.status({fill:\"green\",shape:\"dot\",text:`Relax`});\n}\n\nreturn msg;\n\n// FOOTNOTE_1: \n// Self-consumption won't return `msg.solutions` nor `msg.pid.load_assigned` when:\n// - P1 is near or at it's target grid consumption (aka inside deadband)\n// - when a non-blocking error occurs\n// \n// This code does not specifically account for these cases, but applies a TIMEOUT mechanism instead.\n// As PID_assigned is kept 0, the timer won't be updated and runs out.",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1070,
        "y": 260,
        "wires": [
            [
                "18d05bd09ef21e2e"
            ]
        ]
    },
    {
        "id": "859da30536fc67d9",
        "type": "comment",
        "z": "7a1a1938a7272ee4",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 140,
        "y": 60,
        "wires": []
    },
    {
        "id": "cff34d487e9fe782",
        "type": "link in",
        "z": "7a1a1938a7272ee4",
        "g": "1d41f1b8c8125a48",
        "name": "Charge",
        "links": [],
        "x": 110,
        "y": 220,
        "wires": [
            [
                "a5dee27111f62715"
            ]
        ],
        "l": true
    },
    {
        "id": "9240d35b22fb4933",
        "type": "comment",
        "z": "7a1a1938a7272ee4",
        "g": "1d41f1b8c8125a48",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 130,
        "y": 140,
        "wires": []
    },
    {
        "id": "a5dee27111f62715",
        "type": "change",
        "z": "7a1a1938a7272ee4",
        "g": "1d41f1b8c8125a48",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 180,
        "wires": [
            [
                "257eda8177fdb918"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "bd82e6cbe8602c38",
        "type": "link out",
        "z": "7a1a1938a7272ee4",
        "g": "f493540a3e01ab6b",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 185,
        "y": 580,
        "wires": []
    },
    {
        "id": "a33a57ca66bac30a",
        "type": "comment",
        "z": "7a1a1938a7272ee4",
        "g": "f493540a3e01ab6b",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 130,
        "y": 520,
        "wires": []
    },
    {
        "id": "4bee0f0d753af223",
        "type": "link in",
        "z": "7a1a1938a7272ee4",
        "g": "f493540a3e01ab6b",
        "name": "link to End",
        "links": [
            "f2d466a35d3b0542",
            "cd63bec7f67e6596",
            "dd86938ff41d8270"
        ],
        "x": 75,
        "y": 580,
        "wires": [
            [
                "bd82e6cbe8602c38"
            ]
        ]
    },
    {
        "id": "7802fd2202143586",
        "type": "function",
        "z": "7a1a1938a7272ee4",
        "g": "dbdcc7dd00fb5b22",
        "name": "Max power solution",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\nlog(this, \"Charge at **max. power**\");\n\n// INPUT\nlet batteries = msg.batteries;\nlet solution_array = [];\n\n// build solution\nmsg.batteries.forEach(battery => {\n    const calculatedPower = Number(battery.charging_max);\n\n    solution_array.push({\n        id: battery.id,\n        mode: \"charge\",\n        power: calculatedPower\n    });\n\n});\n\n// return solution\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 360,
        "wires": [
            [
                "8762eb0650b270a1"
            ]
        ]
    },
    {
        "id": "4a15266d687b705c",
        "type": "link call",
        "z": "7a1a1938a7272ee4",
        "g": "dbdcc7dd00fb5b22",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 780,
        "y": 400,
        "wires": [
            [
                "f10d3cde242833ec",
                "dd86938ff41d8270"
            ]
        ]
    },
    {
        "id": "3c50358caec19d73",
        "type": "switch",
        "z": "7a1a1938a7272ee4",
        "g": "dbdcc7dd00fb5b22",
        "name": "Import at max power",
        "property": "grid_power_has_limit_import",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 380,
        "y": 380,
        "wires": [
            [
                "7802fd2202143586"
            ],
            [
                "626d2b37e3672aa1"
            ]
        ]
    },
    {
        "id": "f10d3cde242833ec",
        "type": "debug",
        "z": "7a1a1938a7272ee4",
        "g": "dbdcc7dd00fb5b22",
        "name": "Regulated",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 970,
        "y": 400,
        "wires": []
    },
    {
        "id": "0ee464983f081a56",
        "type": "debug",
        "z": "7a1a1938a7272ee4",
        "g": "dbdcc7dd00fb5b22",
        "name": "Maximum",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 960,
        "y": 360,
        "wires": []
    },
    {
        "id": "626d2b37e3672aa1",
        "type": "function",
        "z": "7a1a1938a7272ee4",
        "g": "dbdcc7dd00fb5b22",
        "name": "Regulated power",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// Which sub-strategy to use\nmsg.target = \"Self-consumption\";\n\n// Grid power limit\nconst targetGridPower = parseInt(msg.grid_power_limit_import);\n\n// Set target grid consumption for the PID controller\nmsg.house_target_grid_consumption_in_w = targetGridPower;\n// tell PID to avoid discharge solutions during charging.\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\",true,true);\n\n// Finally\nlog(this, `**Regulated** charging. Target grid power: ${Math.floor(targetGridPower)} W`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 400,
        "wires": [
            [
                "4a15266d687b705c"
            ]
        ]
    },
    {
        "id": "8762eb0650b270a1",
        "type": "change",
        "z": "7a1a1938a7272ee4",
        "g": "dbdcc7dd00fb5b22",
        "name": "Continue",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Charge",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 360,
        "wires": [
            [
                "0ee464983f081a56",
                "dd86938ff41d8270"
            ]
        ]
    },
    {
        "id": "dd86938ff41d8270",
        "type": "link out",
        "z": "7a1a1938a7272ee4",
        "g": "dbdcc7dd00fb5b22",
        "name": "go to End",
        "mode": "link",
        "links": [
            "4bee0f0d753af223"
        ],
        "x": 960,
        "y": 460,
        "wires": [],
        "l": true
    },
    {
        "id": "15d075941a211f78",
        "type": "function",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Unknown -> Full stop",
        "func": "const log = global.get(\"logger\");\n\n// Unkown export goal\nlog(this, `**${msg.charge.goal}**; Charge goal not recognized. Fallback to **Full Stop**`,\"warn\");\n\n// Full stop\nmsg.target = \"Full stop\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 240,
        "wires": [
            [
                "d56e485414a28c20"
            ]
        ]
    },
    {
        "id": "d56e485414a28c20",
        "type": "link call",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 990,
        "y": 240,
        "wires": [
            [
                "f2d466a35d3b0542"
            ]
        ]
    },
    {
        "id": "11da4c9a45e56e71",
        "type": "api-current-state",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Energy reserve hi",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_charge_target_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charge.threshold_energy",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 800,
        "y": 200,
        "wires": [
            [
                "8748983352f25f36"
            ]
        ]
    },
    {
        "id": "f2d466a35d3b0542",
        "type": "link out",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "go to End",
        "mode": "link",
        "links": [
            "4bee0f0d753af223"
        ],
        "x": 1190,
        "y": 240,
        "wires": [],
        "l": true
    },
    {
        "id": "2a0e4af7f408d366",
        "type": "api-current-state",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "SoC reached",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_charge_target_soc",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charge.threshold_soc",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 780,
        "y": 160,
        "wires": [
            [
                "0c485a3ad5b63526"
            ]
        ]
    },
    {
        "id": "8748983352f25f36",
        "type": "function",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Check if hi",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Charge until: ${msg.charge.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nvar energy_threshold = Number(RED.util.getMessageProperty(msg,\"charge.threshold_energy\"));\nif (energy_threshold === undefined || energy_threshold <= 0){\n    log(this,`Desired energy reserve invalid '${energy_threshold}' kWh. I've set it to ${Number(msg.batteries_max_energy).toFixed(1)} kWh`,\"warn\");\n    energy_threshold = Math.floor(Number(msg.batteries_max_energy)*10)/10;\n}\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining >= energy_threshold) {\n    msg.charge.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh`, 'info');\n} else {\n    msg.charge.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.charge.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.charge.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 200,
        "wires": [
            [
                "2534c18873a94a6d",
                "f332754c8d4af20f"
            ]
        ]
    },
    {
        "id": "0c485a3ad5b63526",
        "type": "function",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Check if SoC",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this, `Charge until: ${msg.charge.goal}`);\n\n// 2. Extract average SoC and desired SoC level\nlet batteries = msg.batteries;\nlet soc_avg = 0;\nlet count = 0; // could use msg.battery_count\nbatteries.forEach(battery => {\n    soc_avg += battery.soc;\n    count++;\n});\n// 2.1 Current avg. SoC\nsoc_avg = Math.round(soc_avg / count * 100) / 100;\n// 2.2 Charge until SoC (100% as fallback)\nvar soc_threshold = Number(RED.util.getMessageProperty(msg,\"charge.threshold_soc\"));\nif (soc_threshold === undefined || soc_threshold < 12){\n    log(this, `Desired SoC not set correctly '${soc_threshold}' %. I've set it to 100%.`,\"warn\");\n    soc_threshold = 100;\n}\n\n// 3. Logic: Determine if SoC level is at or above desired level\nif (soc_avg >= soc_threshold) {\n    msg.charge.threshold_reached = true;\n\n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n} else {\n    msg.charge.threshold_reached = false;\n\n    // User friendly feedback via the custom logger\n    log(this, `[OK] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({\n    fill: msg.charge.threshold_reached ? \"red\" : \"green\",\n    shape: \"dot\",\n    text: `Threshold reached: ${msg.charge.threshold_reached}`\n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 160,
        "wires": [
            [
                "2534c18873a94a6d"
            ]
        ]
    },
    {
        "id": "065433f8c426cee7",
        "type": "change",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Batteries are full",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 790,
        "y": 120,
        "wires": [
            [
                "263c49ecfd998d03"
            ]
        ]
    },
    {
        "id": "263c49ecfd998d03",
        "type": "function",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Check if full",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Charge until: ${msg.charge.goal}`);\n\n// 2. Extract energy level from msg (and handle missing properties)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nconst energy_max = Number(RED.util.getMessageProperty(msg, \"batteries_max_energy\")) || 0;\nif(energy_max == 0) log(this,`Batteries max energy missing! ${msg.batteries_max_energy}`);\n// 2.1 Check if every battery's SoC is at or over the max\nconst isAtMax = msg.batteries.every(battery => battery.soc >= battery.soc_max);\n\n// 3. Logic: Determine if energy level is over or near 99.9% of max eneregy\nif (isAtMax) {\n    msg.charge.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] All batteries are full or at SoC_max_ (${energy_remaining} kWh).`, 'info');\n} else {\n    msg.charge.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Battery level ${energy_remaining.toFixed(2)} kWh below ${energy_max.toFixed(2)} kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.charge.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.charge.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1000,
        "y": 120,
        "wires": [
            [
                "2534c18873a94a6d"
            ]
        ]
    },
    {
        "id": "383346a2cd4746cf",
        "type": "switch",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Until reached",
        "property": "charge.threshold_reached",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1340,
        "y": 160,
        "wires": [
            [
                "56c2809e608d67be"
            ],
            [
                "54e6c2e0a319dc80"
            ]
        ]
    },
    {
        "id": "56c2809e608d67be",
        "type": "function",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Yes -> Charge PV",
        "func": "// If any solar surplus remains, soak it up instead of waiting in Full stop.\nmsg.target = \"Charge PV\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1580,
        "y": 120,
        "wires": [
            [
                "d6ae22820618f34d"
            ]
        ]
    },
    {
        "id": "d6ae22820618f34d",
        "type": "link call",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 1760,
        "y": 120,
        "wires": [
            [
                "cd63bec7f67e6596"
            ]
        ]
    },
    {
        "id": "cd63bec7f67e6596",
        "type": "link out",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "go to End",
        "mode": "link",
        "links": [
            "4bee0f0d753af223"
        ],
        "x": 1900,
        "y": 120,
        "wires": [],
        "l": true
    },
    {
        "id": "2534c18873a94a6d",
        "type": "function",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Decided",
        "func": "const log = global.get(\"logger\");\n\nif(msg.charge.threshold_reached){\n    log(this,`Stop charging, Charge until ${msg.charge.goal} reached.`);\n} else {\n    log(this,`Continue charging.`);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1190,
        "y": 160,
        "wires": [
            [
                "383346a2cd4746cf"
            ]
        ]
    },
    {
        "id": "015df65690f6fc00",
        "type": "switch",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Charge until",
        "property": "charge.goal",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "batteries are full",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "state of charge",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "energy reserve",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 4,
        "x": 590,
        "y": 180,
        "wires": [
            [
                "065433f8c426cee7"
            ],
            [
                "2a0e4af7f408d366"
            ],
            [
                "11da4c9a45e56e71"
            ],
            [
                "15d075941a211f78"
            ]
        ]
    },
    {
        "id": "419fb91ada6f71ae",
        "type": "api-current-state",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Goal",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_charge_goal",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "charge.goal",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 180,
        "wires": [
            [
                "015df65690f6fc00"
            ]
        ]
    },
    {
        "id": "257eda8177fdb918",
        "type": "function",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "Init",
        "func": "msg.charge = {};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "419fb91ada6f71ae",
                "336f4ce0f4038ece"
            ]
        ]
    },
    {
        "id": "da930475c54f2689",
        "type": "function",
        "z": "7a1a1938a7272ee4",
        "g": "8e6b34661efd9262",
        "name": "Min/max",
        "func": "\n// Lower bound\nlet output = msg.charge.threshold_energy || 0; // kWh\noutput = Math.max(output, 0);\n\n// Upper bound\noutput = Math.min(output, msg.batteries_max_energy);\n\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\n\n// Output\nmsg.payload = output;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1800,
        "y": 200,
        "wires": [
            [
                "9ed3f45980814d94"
            ]
        ]
    },
    {
        "id": "9ed3f45980814d94",
        "type": "api-call-service",
        "z": "7a1a1938a7272ee4",
        "g": "8e6b34661efd9262",
        "name": "Set desired energy reserve",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_charge_target_energy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.payload}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2010,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "f332754c8d4af20f",
        "type": "rbe",
        "z": "7a1a1938a7272ee4",
        "g": "8e6b34661efd9262",
        "name": "Desired energy changed",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 1600,
        "y": 200,
        "wires": [
            [
                "da930475c54f2689"
            ]
        ]
    },
    {
        "id": "336f4ce0f4038ece",
        "type": "debug",
        "z": "7a1a1938a7272ee4",
        "g": "b8a0115a6143b072",
        "name": "debug 2",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 410,
        "y": 120,
        "wires": []
    },
    {
        "id": "41be0cb53e32b85a",
        "type": "catch",
        "z": "7a1a1938a7272ee4",
        "g": "c62c6cd273376d12",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 75,
        "y": 420,
        "wires": [
            [
                "f9f77fb0a958dc29"
            ]
        ],
        "l": false
    },
    {
        "id": "f9f77fb0a958dc29",
        "type": "function",
        "z": "7a1a1938a7272ee4",
        "g": "c62c6cd273376d12",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 125,
        "y": 420,
        "wires": [
            [
                "27d49c54a65ffb3b"
            ]
        ],
        "l": false
    },
    {
        "id": "27d49c54a65ffb3b",
        "type": "link out",
        "z": "7a1a1938a7272ee4",
        "g": "c62c6cd273376d12",
        "name": "link out 3",
        "mode": "return",
        "links": [],
        "x": 175,
        "y": 420,
        "wires": []
    },
    {
        "id": "0e1a4159f8a2aaf5",
        "type": "link in",
        "z": "40f4cc790d5ae165",
        "g": "f648ac13a12aa8bd",
        "name": "Dynamic",
        "links": [],
        "x": 100,
        "y": 160,
        "wires": [
            [
                "a589ffa67188c0f1"
            ]
        ],
        "l": true
    },
    {
        "id": "14b8cd44593d704c",
        "type": "comment",
        "z": "40f4cc790d5ae165",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "7e9d5a59d3bf3a6c",
        "type": "comment",
        "z": "40f4cc790d5ae165",
        "g": "f648ac13a12aa8bd",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "8734284dcaec3633",
        "type": "link out",
        "z": "40f4cc790d5ae165",
        "g": "739e0a83cc033ca6",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 975,
        "y": 180,
        "wires": []
    },
    {
        "id": "ba46a7ddf5e010eb",
        "type": "comment",
        "z": "40f4cc790d5ae165",
        "g": "739e0a83cc033ca6",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 1030,
        "y": 120,
        "wires": []
    },
    {
        "id": "b877a0ae39a17081",
        "type": "api-render-template",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Cheapest",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{}",
        "resultsLocation": "dynamic.data_cheapest",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 460,
        "y": 660,
        "wires": [
            [
                "699cf4c940801a57"
            ]
        ]
    },
    {
        "id": "bed3f816b5ce55dc",
        "type": "api-render-template",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Expensive",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "",
        "resultsLocation": "dynamic.data_expensive",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 470,
        "y": 720,
        "wires": [
            [
                "10e5a81ab5d03b54"
            ]
        ]
    },
    {
        "id": "efb7738725196719",
        "type": "debug",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Complete message",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 910,
        "y": 1220,
        "wires": []
    },
    {
        "id": "699cf4c940801a57",
        "type": "json",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "",
        "property": "dynamic.data_cheapest",
        "action": "obj",
        "pretty": false,
        "x": 555,
        "y": 660,
        "wires": [
            [
                "c665afbc6917c954"
            ]
        ],
        "l": false
    },
    {
        "id": "10e5a81ab5d03b54",
        "type": "json",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "",
        "property": "dynamic.data_expensive",
        "action": "obj",
        "pretty": false,
        "x": 575,
        "y": 720,
        "wires": [
            [
                "bf14bb1756b9f976"
            ]
        ],
        "l": false
    },
    {
        "id": "ba869747549461c4",
        "type": "function",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Determine dynamic strategy",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// 1.   Input\n// Conversion\nconst CONVERSION_RATE = parseFloat(RED.util.getMessageProperty(msg, \"dynamic.value_conversion\")) || 1;\n\n// extract start/end date objects\nconst start_cheapest = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.start\"));\nconst start_expensive = new Date(RED.util.getMessageProperty(msg,\"dynamic.data_expensive.start\"));\nconst end_cheapest = new Date(RED.util.getMessageProperty(msg, \"dynamic.data_cheapest.end\"));\nconst end_expensive = new Date(RED.util.getMessageProperty(msg, \"dynamic.data_expensive.end\"));\nlet isCheapestNext = true;\n// stored price cheapest period\nlet lastCheapestPrice = context.last_cheapest_price || 0; // unit: cents/kWh\nconst nextCheapestPrice = parseInt(RED.util.getMessageProperty(msg, \"dynamic.data_cheapest.average\") / CONVERSION_RATE * 100); // unit: cents/kWh \n// average price expensive period\nconst lastExpensivePrice = parseInt(RED.util.getMessageProperty(msg, \"dynamic.data_expensive.average\") / CONVERSION_RATE * 100); // unit: cents/kWh\n// threshold rate for cheapest period\nconst cheapestThresholdCents = parseInt(RED.util.getMessageProperty(msg, \"dynamic.threshold_cheapest_cents\")) || 0; // unit: cents\n// threshold delta for expensive period\nconst deltaThresholdCents = parseInt(RED.util.getMessageProperty(msg, \"dynamic.min_delta_cents\")) || 0; // unit: cents\n\n// 1.1  Enums\nconst STRATEGY = {\n    CHEAPEST: RED.util.getMessageProperty(msg,\"dynamic.strategy_cheapest\") || \"Charge\", \n    NEUTRAL: RED.util.getMessageProperty(msg,\"dynamic.strategy_default\") || \"Charge PV\",\n    EXPENSIVE: RED.util.getMessageProperty(msg,\"dynamic.strategy_expensive\") || \"Self-consumption\"\n}\n\n// 1.2  Defaults   \nmsg.dynamic.avg_cheapest_tariff = 0;\nmsg.dynamic.avg_expensive_tariff = 0;\nmsg.dynamic.avg_delta = 0;\n\n// 2.   Tariffs\n// Check if the Date objects are valid. If 'Invalid Date', stop and warn the user.\nif (isNaN(start_cheapest.getTime()) || isNaN(start_expensive.getTime())) {\n    // warn user\n    log(this, `One or both dates are invalid. Cheap = ${start_cheapest}, Expensive = ${start_expensive}`,\"warn\");\n    node.status({fill:\"red\",shape:\"ring\",text:`One or both dates are invalid: ${start_cheapest}, ${start_expensive}`});\n    // fallback strategy\n    flow.set(\"dynamic_strategy\", STRATEGY.NEUTRAL);\n    // proceed to UI\n    return msg;\n}\n\n// Check if cheapest lies before expensive\nif (start_cheapest < start_expensive) {\n    log(this, `Cheapest moment lies before expensive moment. Cheapest moment: ${start_cheapest}, Expensive = ${start_expensive}`);\n    // store the cheapest price to compare it with future expensive rates, to determine if it's economical to discharge.\n    context.last_cheapest_price = nextCheapestPrice; // store for next iteration\n    lastCheapestPrice = nextCheapestPrice; // used for this iteration\n    log(this, `Cheapest price set to ${lastCheapestPrice} cents`);\n}\n\nif (lastCheapestPrice == 0) {\n    log(this, `I can't recall the tariff used for charging. Cheapest price set to '${lastCheapestPrice}' cents`);\n}\n\n// delta > N cents ? -> charging is economical\nconst delta = (lastExpensivePrice - lastCheapestPrice); // unit: cents\n\n// UI values\nmsg.dynamic.avg_cheapest_tariff = lastCheapestPrice;\nmsg.dynamic.avg_expensive_tariff = lastExpensivePrice;\nmsg.dynamic.avg_delta = delta;\n\n// 3.   Strategy selection logic\n// for string time\nfunction isTimeInPeriod(startStr, endStr) {\n    const now = new Date();\n    const start = new Date(startStr);\n    const end = new Date(endStr);\n    return (now >= start && now < end);\n}\n// 3.1  is_now - which period have we entered?\nconst now = new Date();\n/** @type {boolean} */\nconst cheapestIsNow = now >= start_cheapest && now <= end_cheapest;\n// const cheapestIsNow = RED.util.getMessageProperty(msg,\"dynamic.data_cheapest.is_now\");\n/** @type {boolean} */\nconst expensiveIsNow = now >= start_expensive && now <= end_expensive;\n// const expensiveIsNow = RED.util.getMessageProperty(msg, \"dynamic.data_expensive.is_now\");\n\n// 3.2  Set strategy\n// Default strategy\nmsg.dynamic.strategy = STRATEGY.NEUTRAL;\n\n// Cheapest period?\nif (cheapestIsNow && lastCheapestPrice <= cheapestThresholdCents) {\n    msg.dynamic.strategy = STRATEGY.CHEAPEST;\n    // Explain\n    log(this, `**Cheapest period is NOW**, price limit: ${lastCheapestPrice}/${cheapestThresholdCents} cents OK`);\n} else if(cheapestIsNow) {\n    // Explain why skipped\n    log(this, `**Cheapest period SKIPPED**, the cheapest period is too expensive today. Price limit: ${lastCheapestPrice}/${cheapestThresholdCents} cents.`);\n}\n\n// Expensive period?\nif (expensiveIsNow && delta >= deltaThresholdCents) {\n    msg.dynamic.strategy = STRATEGY.EXPENSIVE;\n    // Explain\n    log(this, `**Expensive period is NOW**, price delta: ${delta}>=${deltaThresholdCents} cents OK`);\n} else if(expensiveIsNow) {\n    // Explain why skipped\n    log(this, `**Expensive period SKIPPED**, price delta too small: ${lastExpensivePrice}-${lastCheapestPrice}=${delta} cents <= ${deltaThresholdCents} cents`); \n}\n\n// 3.3  Store the strategy in flow-context. The 'Execution' area will read from the flow-context.\nflow.set(\"dynamic_strategy\",msg.dynamic.strategy);\n\n// 4.   User feedback\n// Node status\nnode.status({ fill: \"blue\", shape: \"dot\", text: `${msg.dynamic.strategy}; ${cheapestIsNow} + ${expensiveIsNow} @ ${delta} cents` });\n// Explain\nlog(this, `Strategy set to **${msg.dynamic.strategy}**`);\n\n// Proceed to UI update\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 1140,
        "wires": [
            [
                "efb7738725196719",
                "85a84c7778e69325",
                "fbd8b3ab08efebf1",
                "64b9050a85cb2ccd",
                "56fd0270a5d412a6",
                "a844f8be8731d922",
                "1de512f7648062ef",
                "c5d8e356117897a6",
                "7d222d5ea7466dff"
            ]
        ]
    },
    {
        "id": "bf198d59abd385ce",
        "type": "change",
        "z": "40f4cc790d5ae165",
        "g": "8d3318685130ea4b",
        "name": "Set strategy",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "dynamic_strategy",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 200,
        "wires": [
            [
                "4ffef8c0736f74bd"
            ]
        ]
    },
    {
        "id": "49eaed08c9842d11",
        "type": "link call",
        "z": "40f4cc790d5ae165",
        "g": "8d3318685130ea4b",
        "name": "Sub-strategy",
        "links": [],
        "linkType": "dynamic",
        "timeout": "3",
        "x": 810,
        "y": 180,
        "wires": [
            [
                "8734284dcaec3633"
            ]
        ]
    },
    {
        "id": "85a84c7778e69325",
        "type": "api-call-service",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Cheapest Start",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_cheapest_start"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.start).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 900,
        "y": 940,
        "wires": [
            []
        ]
    },
    {
        "id": "fbd8b3ab08efebf1",
        "type": "api-call-service",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Cheapest End",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_cheapest_end"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_cheapest.end).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 900,
        "y": 980,
        "wires": [
            []
        ]
    },
    {
        "id": "64b9050a85cb2ccd",
        "type": "api-call-service",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Expensive Start",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_expensive_start"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_expensive.start).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 900,
        "y": 1020,
        "wires": [
            []
        ]
    },
    {
        "id": "56fd0270a5d412a6",
        "type": "api-call-service",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Expensive End",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_datetime.set_datetime",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_datetime.house_battery_strategy_dynamic_expensive_end"
        ],
        "labelId": [],
        "data": "{\t    \"datetime\": $moment($$.dynamic.data_expensive.end).format('YYYY-MM-DD HH:mm:ss')\t}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_datetime",
        "service": "set_datetime",
        "x": 900,
        "y": 1060,
        "wires": [
            []
        ]
    },
    {
        "id": "0e6f0b3dacd99164",
        "type": "inject",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "Every 60 min",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "0 0-23 * * *",
        "once": false,
        "onceDelay": "3",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 380,
        "y": 420,
        "wires": [
            [
                "c7fa8e716372bd1b"
            ]
        ]
    },
    {
        "id": "427268516dda1dd2",
        "type": "switch",
        "z": "40f4cc790d5ae165",
        "g": "8d3318685130ea4b",
        "name": "Has strategy",
        "property": "dynamic_strategy",
        "propertyType": "flow",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 330,
        "y": 180,
        "wires": [
            [
                "27e90d87802b4a2d"
            ],
            [
                "bf198d59abd385ce"
            ]
        ]
    },
    {
        "id": "27e90d87802b4a2d",
        "type": "change",
        "z": "40f4cc790d5ae165",
        "g": "8d3318685130ea4b",
        "name": "Set Full stop",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Full stop",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 160,
        "wires": [
            [
                "4ffef8c0736f74bd"
            ]
        ]
    },
    {
        "id": "dc4b49abd35451ec",
        "type": "inject",
        "z": "40f4cc790d5ae165",
        "g": "3bfb42c4fef6d9da",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 1520,
        "wires": [
            [
                "512bc0fd76ca819c"
            ]
        ]
    },
    {
        "id": "512bc0fd76ca819c",
        "type": "api-render-template",
        "z": "40f4cc790d5ae165",
        "g": "3bfb42c4fef6d9da",
        "name": "Cheapest",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "cheapest",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 500,
        "y": 1520,
        "wires": [
            [
                "637d239be07c14c3"
            ]
        ]
    },
    {
        "id": "637d239be07c14c3",
        "type": "json",
        "z": "40f4cc790d5ae165",
        "g": "3bfb42c4fef6d9da",
        "name": "",
        "property": "cheapest",
        "action": "obj",
        "pretty": false,
        "x": 595,
        "y": 1520,
        "wires": [
            [
                "1df9f930fe738309"
            ]
        ],
        "l": false
    },
    {
        "id": "1df9f930fe738309",
        "type": "api-render-template",
        "z": "40f4cc790d5ae165",
        "g": "3bfb42c4fef6d9da",
        "name": "Expensive",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    lowest=false,\n    hours=1,\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "expensive",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 750,
        "y": 1520,
        "wires": [
            [
                "5668e664243f9263"
            ]
        ]
    },
    {
        "id": "5668e664243f9263",
        "type": "json",
        "z": "40f4cc790d5ae165",
        "g": "3bfb42c4fef6d9da",
        "name": "",
        "property": "expensive",
        "action": "obj",
        "pretty": false,
        "x": 855,
        "y": 1520,
        "wires": [
            [
                "8e8cbd768fc9765a",
                "4e229d17ba2aa9e7",
                "01e08006ea396623"
            ]
        ],
        "l": false
    },
    {
        "id": "8e8cbd768fc9765a",
        "type": "debug",
        "z": "40f4cc790d5ae165",
        "g": "3bfb42c4fef6d9da",
        "name": "Cheap",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "cheapest.start",
        "targetType": "msg",
        "statusVal": "cheapest.start",
        "statusType": "auto",
        "x": 990,
        "y": 1560,
        "wires": []
    },
    {
        "id": "4e229d17ba2aa9e7",
        "type": "debug",
        "z": "40f4cc790d5ae165",
        "g": "3bfb42c4fef6d9da",
        "name": "Expensive",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "expensive.start",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 1010,
        "y": 1600,
        "wires": []
    },
    {
        "id": "5344a99cd2c3c98a",
        "type": "api-render-template",
        "z": "40f4cc790d5ae165",
        "g": "79b4bc9416fb8873",
        "name": "All Zonneplan",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n    sensor=\"sensor.zonneplan_current_electricity_tariff\",\n    source_settings=\"zonneplan\",\n    include_tomorrow=true,\n    hours=\"all\",\n    mode=\"all\"\n) | to_json }}",
        "resultsLocation": "all_data",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 480,
        "y": 1700,
        "wires": [
            [
                "32a117c1c1fc2ddc"
            ]
        ]
    },
    {
        "id": "99be3b3592acf608",
        "type": "inject",
        "z": "40f4cc790d5ae165",
        "g": "79b4bc9416fb8873",
        "name": "Fetch",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 1700,
        "wires": [
            [
                "5344a99cd2c3c98a"
            ]
        ]
    },
    {
        "id": "32a117c1c1fc2ddc",
        "type": "json",
        "z": "40f4cc790d5ae165",
        "g": "79b4bc9416fb8873",
        "name": "",
        "property": "all_data",
        "action": "obj",
        "pretty": false,
        "x": 595,
        "y": 1700,
        "wires": [
            [
                "fc688a7459f13678",
                "a37c7456045aa7c0"
            ]
        ],
        "l": false
    },
    {
        "id": "c7fa8e716372bd1b",
        "type": "delay",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "minutes",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 540,
        "y": 420,
        "wires": [
            [
                "e23ef0f572f54a81"
            ]
        ]
    },
    {
        "id": "d1c0a3c464ae07a3",
        "type": "api-current-state",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "Source",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_data_source",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.data_source",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 860,
        "y": 380,
        "wires": [
            [
                "99fca0348d07440d"
            ]
        ]
    },
    {
        "id": "ba1be87033cd7c29",
        "type": "function",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Data source settings",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n/*    From cheapes-energy-hours macro\n      See: https://github.com/TheFes/cheapest-energy-hours/blob/main/documentation/1-source_data.md#data-provider-settings\n\n      - None (default selection)\n      - Zonneplan\n      - Amber Electric\n      - EasyEnergy, EnergyZero (core)\n      - ENTSO-E\n      - Frank Energie\n      - GE-Spot\n      - Tibber, Nordpool (core)\n      - Tibber (custom)\n      - Nordpool (custom)\n      - PVPC (Spain)\n      - Octopus Energy\n      - Omie\n*/\n\nswitch (msg.dynamic.data_source) {\n      case \"None\":\n            // Handle the 'None' case (e.g., no supplier selected or data is unavailable)\n            log(this,\"No data source selected.\");\n            // Add config here...\n            break;\n\n      case \"Zonneplan\":\n            // Code for Zonneplan (a Dutch energy supplier)\n            log(this,\"Processing Zonneplan data.\");\n            // Add config here...\n            msg.dynamic.sensor='sensor.zonneplan_current_electricity_tariff'; // when using: https://github.com/fsaris/home-assistant-zonneplan-one\n            msg.dynamic.attr_all='forecast';\n            msg.dynamic.value_key='electricity_price';\n            msg.dynamic.value_conversion = 10000000; // whole currency / kWh\n            break;\n\n      case \"Zonneplan (one)\":\n            // deprecated workaround for fsaris' v2026.1 update\n            log(this,\"Processing Zonneplan (one) data.\");\n            // Add config here...\n            msg.dynamic.sensor='sensor.zonneplan_current_tariff'; // when using: https://github.com/fsaris/home-assistant-zonneplan-one\n            msg.dynamic.attr_all='forecast';\n            msg.dynamic.value_key='electricity_price';\n            msg.dynamic.value_conversion = 10000000; // whole currency / kWh\n            break;\n\n      case \"Amber Electric\":\n            // Code for Amber Electric (Australian energy retailer)\n            log(this,\"Processing Amber Electric data.\");\n            // Add config here...\n            msg.dynamic.attr_all='forecasts'; \n            msg.dynamic.time_key='start_time'; \n            msg.dynamic.value_key='per_kwh';\n            break;\n\n      case \"EasyEnergy, EnergyZero (core)\":\n            // Code for EasyEnergy and EnergyZero (core/default implementation)\n            log(this,\"Processing EasyEnergy/EnergyZero core data.\");\n            // Add config here...\n            break;\n\n      case \"ENTSO-E\":\n            // Code for ENTSO-E (European Network of Transmission System Operators for Electricity)\n            log(this,\"Processing ENTSO-E data.\");\n            // Add config here...\n            msg.dynamic.attr_today='prices_today'; \n            msg.dynamic.attr_tomorrow='prices_tomorrow'; \n            msg.dynamic.time_key='time';\n            msg.dynamic.value_key='price';\n            break;\n\n      case \"Frank Energie\":\n            // Code for Frank Energie (Dutch energy supplier)\n            log(this,\"Processing Frank Energie data.\");\n            // Add config here...\n            msg.dynamic.sensor = 'sensor.frank_energie_prijzen_gemiddelde_elektriciteitsprijs_alle_uren_all_in'; // when using: https://github.com/HiDiHo01/home-assistant-frank_energie\n            msg.dynamic.attr_all = 'prices'; \n            msg.dynamic.time_key = 'from'; \n            msg.dynamic.value_key = 'price';\n            break;\n\n      case \"GE-Spot\":\n            // Code for GE-Spot (Global Electric Spot price)\n            log(this,\"Processing GE-Spot data.\");\n            // Add config here...\n            msg.dynamic.attr_today = 'today_hourly_prices'; // using the hourly version. today_interval_prices is per 15 mins\n            msg.dynamic.attr_tomorrow = 'tomorrow_hourly_prices'; // using the hourly version\n            msg.dynamic.time_key = 'time'; \n            msg.dynamic.value_key = 'value';\n            break;\n\n      case \"Tibber, Nordpool (core)\":\n            // Code for Tibber and Nordpool (core/default implementation)\n            log(this,\"Processing Tibber/Nordpool core data.\");\n            // Add config here...\n            msg.dynamic.sensor = 'sensor.tibber_ceh_prices';\n            msg.dynamic.attr_today = 'today';\n            msg.dynamic.attr_tomorrow = 'tomorrow';\n            msg.dynamic.time_key = 'start';\n            msg.dynamic.value_key = 'value';\n            msg.dynamic.datetime_in_data = true; // datetime is in the data\n            break;\n\n      case \"Tibber (custom)\":\n            // Code for a custom Tibber setup/configuration\n            log(this,\"Processing Tibber custom data.\");\n            // Add config here...\n            msg.dynamic.attr_today = 'today';\n            msg.dynamic.attr_tomorrow = 'tomorrow';\n            msg.dynamic.datetime_in_data = false;\n            break;\n\n      case \"Nordpool (custom)\":\n            // Code for a custom Nordpool setup/configuration\n            log(this,\"Processing Nordpool custom data.\");\n            // Add config here...\n            break;\n\n      case \"PVPC (Spain)\":\n            // Code for PVPC (Voluntary Price for Small Consumers in Spain)\n            log(this,\"Processing Spanish PVPC data.\");\n            // Add config here...\n            break;\n\n      case \"Octopus Energy\":\n            // Code for Octopus Energy (UK/international energy supplier)\n            log(this,\"Processing Octopus Energy data.\");\n            // Add config here...\n            msg.dynamic.attr_all = 'rates'; \n            msg.dynamic.value_key = 'value_incl_vat';\n            break;\n\n      case \"Omie\":\n            // Code for Omie (Iberian Energy Market Operator)\n            log(this,\"Processing Omie data.\");\n            // Add config here...\n            break;\n\n      default:\n            // Code to execute if the supplier does not match any of the above cases\n            node.warn(`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            log(this,`Unknown supplier: ${msg.dynamic.data_source}. Using default logic.`);\n            // Add default error handling...\n}\n\nlog(this, \"Performing API calls...\");\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 600,
        "wires": [
            [
                "1efdacf06d27b333"
            ]
        ]
    },
    {
        "id": "c384a00e15da77d8",
        "type": "api-current-state",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "Cheapest N hrs",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_cheapest_hrs",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.cheapest_hrs",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1100,
        "y": 380,
        "wires": [
            [
                "4a26dc4637a2afce"
            ]
        ]
    },
    {
        "id": "4a26dc4637a2afce",
        "type": "api-current-state",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "Expensive N hrs",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_expensive_hrs",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.expensive_hrs",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1100,
        "y": 420,
        "wires": [
            [
                "c57f9f835deb8fe5"
            ]
        ]
    },
    {
        "id": "afb3be193833d31b",
        "type": "inject",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "Check period",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "*/15 0-23 * * *",
        "once": true,
        "onceDelay": "3",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 380,
        "y": 380,
        "wires": [
            [
                "2c984fa1a7fb0bba"
            ]
        ]
    },
    {
        "id": "2c984fa1a7fb0bba",
        "type": "function",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "Init",
        "func": "msg.dynamic = {};\nmsg.log = [];\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 380,
        "wires": [
            [
                "d1c0a3c464ae07a3"
            ]
        ]
    },
    {
        "id": "1efdacf06d27b333",
        "type": "function",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Generate templates",
        "func": "// final template initialization\nmsg.dynamic.template_cheapest = \"\";\nmsg.dynamic.template_expensive = \"\";\n\n// temporary template parts\nlet template_start = \"\";\nlet template_common = [];\nlet template_cheapest = [];\nlet template_expensive = [];\nlet template_all = [];\nlet template_end = \"\";\n\n// 1. IMPROVEMENT: Use radix 10 and Logical OR (||) for cleaner default handling\nconst cheapest_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.cheapest_hrs\"), 10) || 1;\nconst expensive_hrs = parseInt(RED.util.getMessageProperty(msg,\"dynamic.expensive_hrs\"), 10) || 1;\n\n// load the macro\ntemplate_start = `{% from 'cheapest_energy_hours.jinja' import cheapest_energy_hours %}\n{{ cheapest_energy_hours(\n`;\ntemplate_end = `) | to_json }}`;\n\n// collect arguments | strings\nconst stringKeys = [\n    'sensor',\n    'attr_all',\n    'value_key',\n    'attr_today',\n    'attr_tomorrow',\n    'time_key'\n];\n\nstringKeys.forEach(key => {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}='${msg.dynamic[key]}'`);\n    }\n});\n\n// collect arguments | boolean, integer\nconst otherKeys = [\n    'datetime_in_data',\n    'data_minutes',\n];\n\notherKeys.forEach(key => {\n    if (msg.dynamic[key] !== undefined) {\n        template_common.push(`${key}=${msg.dynamic[key]}`);\n    }\n});\n\n// copy common items\ntemplate_cheapest = [...template_common];\ntemplate_expensive = [...template_common];\ntemplate_all = [...template_common];\n\n// collect arguments | cheapest specific\ntemplate_cheapest.push(`hours=${cheapest_hrs}`);\n// template_cheapest.push(`include_tomorrow=true`);\ntemplate_cheapest.push(`mode=\"all\"`);\n\n// collect arguments | expensive specific\ntemplate_expensive.push(`hours=${expensive_hrs}`);\n// template_expensive.push(`include_tomorrow=true`);\ntemplate_expensive.push(`lowest=false`);\ntemplate_expensive.push(`mode=\"all\"`);\n\n// collect all hours | via extra call\ntemplate_all.push(`hours=\"all\"`);\ntemplate_all.push(`include_tomorrow=true`);\ntemplate_all.push(`mode=\"all\"`);\n\n/**\n * Formats an array of strings into a single string:\n * - Each item starts with 4 spaces.\n * - Each item ends with a comma, except the last one.\n * - Items are separated by a newline.\n */\nfunction formatTemplateArray(array) {\n    if (!array || array.length === 0) {\n        return \"\";\n    }\n\n    const indent = \"    \"; \n\n    const formatted_lines = array.map((element, index) => {\n        const suffix = (index < array.length - 1) ? \",\" : \"\";\n        return `${indent}${element}${suffix}`;\n    });\n\n    return formatted_lines.join('\\n');\n}\n\n// generate string templates\nconst template_cheapest_string = formatTemplateArray(template_cheapest);\nconst template_expensive_string = formatTemplateArray(template_expensive);\nconst template_all_string = formatTemplateArray(template_all);\n\n// done\nmsg.dynamic.template_cheapest = `${template_start}${template_cheapest_string}${template_end}`;\nmsg.dynamic.template_expensive = `${template_start}${template_expensive_string}${template_end}`;\nmsg.dynamic.template_all = `${template_start}${template_all_string}${template_end}`;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 600,
        "wires": [
            [
                "108337c587e041ce",
                "d0eff859ae1a59b4",
                "4f31c1b602330ed1",
                "52a67c0485d66ecd"
            ]
        ]
    },
    {
        "id": "108337c587e041ce",
        "type": "debug",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Template cheapest",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_cheapest",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 850,
        "y": 620,
        "wires": []
    },
    {
        "id": "d0eff859ae1a59b4",
        "type": "debug",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Template expensive",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_expensive",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 860,
        "y": 580,
        "wires": []
    },
    {
        "id": "4f31c1b602330ed1",
        "type": "change",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_cheapest",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 660,
        "wires": [
            [
                "b877a0ae39a17081"
            ]
        ]
    },
    {
        "id": "c665afbc6917c954",
        "type": "change",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_expensive",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 720,
        "wires": [
            [
                "bed3f816b5ce55dc"
            ]
        ]
    },
    {
        "id": "5b9b60d1bb446ee0",
        "type": "change",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Cleanup",
        "rules": [
            {
                "t": "delete",
                "p": "template",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 340,
        "y": 840,
        "wires": [
            [
                "6657914b1330a469"
            ]
        ]
    },
    {
        "id": "a844f8be8731d922",
        "type": "debug",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Log: activate 'debug mode' first",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "log",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 950,
        "y": 1260,
        "wires": []
    },
    {
        "id": "49d760d9605827ea",
        "type": "server-state-changed",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "User input",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.house_battery_strategy_dynamic_cheapest_hrs",
                "input_number.house_battery_strategy_dynamic_expensive_hrs",
                "input_select.house_battery_strategy_dynamic_data_source",
                "input_number.house_battery_strategy_dynamic_threshold_delta",
                "input_number.house_battery_strategy_dynamic_threshold_cheapest_period"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 360,
        "y": 340,
        "wires": [
            [
                "461b419ed807cb64"
            ]
        ]
    },
    {
        "id": "99fca0348d07440d",
        "type": "switch",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "Source selected?",
        "property": "dynamic.data_source",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "None",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 965,
        "y": 380,
        "wires": [
            [
                "7c8454fb0e840d17"
            ],
            [
                "c384a00e15da77d8"
            ]
        ],
        "l": false
    },
    {
        "id": "4b9fa5c22399b1eb",
        "type": "debug",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "Not set",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 1340,
        "y": 340,
        "wires": []
    },
    {
        "id": "1de512f7648062ef",
        "type": "api-call-service",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Avg cheap tariff",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_cheapest_avg_tariff"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_cheapest_tariff }",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 900,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "c5d8e356117897a6",
        "type": "api-call-service",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Avg expensive tariff",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_expensive_avg_tariff"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_expensive_tariff}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 910,
        "y": 1140,
        "wires": [
            []
        ]
    },
    {
        "id": "7d222d5ea7466dff",
        "type": "api-call-service",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Avg delta",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_dynamic_expensive_avg_delta"
        ],
        "labelId": [],
        "data": "{\"value\": $$.dynamic.avg_delta}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 880,
        "y": 1180,
        "wires": [
            []
        ]
    },
    {
        "id": "37b7ae3890e11351",
        "type": "api-current-state",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Threshold delta",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_threshold_delta",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.min_delta_cents",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 360,
        "y": 1020,
        "wires": [
            [
                "2b60fa521307b416"
            ]
        ]
    },
    {
        "id": "7c8454fb0e840d17",
        "type": "change",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "Set dynamic strategy to null",
        "rules": [
            {
                "t": "set",
                "p": "dynamic_strategy",
                "pt": "flow",
                "to": "null",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1140,
        "y": 340,
        "wires": [
            [
                "4b9fa5c22399b1eb"
            ]
        ]
    },
    {
        "id": "fc688a7459f13678",
        "type": "debug",
        "z": "40f4cc790d5ae165",
        "g": "79b4bc9416fb8873",
        "name": "All data",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "all_data",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 1700,
        "wires": []
    },
    {
        "id": "01e08006ea396623",
        "type": "debug",
        "z": "40f4cc790d5ae165",
        "g": "3bfb42c4fef6d9da",
        "name": "Complete msg",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 1520,
        "wires": []
    },
    {
        "id": "a589ffa67188c0f1",
        "type": "change",
        "z": "40f4cc790d5ae165",
        "g": "f648ac13a12aa8bd",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 90,
        "y": 200,
        "wires": [
            [
                "427268516dda1dd2"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "4ffef8c0736f74bd",
        "type": "function",
        "z": "40f4cc790d5ae165",
        "g": "8d3318685130ea4b",
        "name": "Selected",
        "func": "// Logger\nconst log = global.get(\"logger\");\nlog(this,`${msg.target} strategy`);\n\n// Status\nnode.status({fill:\"green\",shape:\"dot\",text:`${msg.target}`});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 180,
        "wires": [
            [
                "49eaed08c9842d11"
            ]
        ]
    },
    {
        "id": "77c43ddf65716772",
        "type": "catch",
        "z": "40f4cc790d5ae165",
        "g": "be988495d64a84e2",
        "name": "",
        "scope": null,
        "uncaught": true,
        "x": 65,
        "y": 320,
        "wires": [
            [
                "94c7d29e92a783b7"
            ]
        ],
        "l": false
    },
    {
        "id": "94c7d29e92a783b7",
        "type": "function",
        "z": "40f4cc790d5ae165",
        "g": "be988495d64a84e2",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 115,
        "y": 320,
        "wires": [
            [
                "efc797fa187ebb2f"
            ]
        ],
        "l": false
    },
    {
        "id": "efc797fa187ebb2f",
        "type": "link out",
        "z": "40f4cc790d5ae165",
        "g": "be988495d64a84e2",
        "name": "link out 5",
        "mode": "return",
        "links": [],
        "x": 165,
        "y": 320,
        "wires": []
    },
    {
        "id": "2e4d31794ebd5213",
        "type": "api-current-state",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Threshold cheapest",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_dynamic_threshold_cheapest_period",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.threshold_cheapest_cents",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 980,
        "wires": [
            [
                "37b7ae3890e11351"
            ]
        ]
    },
    {
        "id": "2b60fa521307b416",
        "type": "api-current-state",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Strategy default",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_default",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.strategy_default",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 360,
        "y": 1060,
        "wires": [
            [
                "66e7be796fa21223"
            ]
        ]
    },
    {
        "id": "66e7be796fa21223",
        "type": "api-current-state",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Strategy cheapest",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_cheapest",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.strategy_cheapest",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 1100,
        "wires": [
            [
                "3e7827f753fa44b9"
            ]
        ]
    },
    {
        "id": "3e7827f753fa44b9",
        "type": "api-current-state",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "Strategy expensive",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_dynamic_expensive",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "dynamic.strategy_expensive",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 370,
        "y": 1140,
        "wires": [
            [
                "ba869747549461c4"
            ]
        ]
    },
    {
        "id": "6657914b1330a469",
        "type": "function",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Cache data source",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\nconst dynamicData = msg.dynamic;\n\n// Helper to check for errors in the object\nconst isInvalid = (data) => {\n    if (!data) return true;\n    // Check if the stringified object contains \"error\"\n    return JSON.stringify(data).toLowerCase().includes(\"error\");\n};\n\nif (isInvalid(dynamicData)) {\n    // Explain issue\n    log(this, \"Invalid data received, clearing cache\", \"warn\");\n    // Clear cache\n    flow.set(\"cached_dynamic_data\", undefined);\n} else {\n    // Cache on success\n    log(this, \"Caching `msg.dynamic`\");\n    // Save the entire object to flow context\n    flow.set(\"cached_dynamic_data\", dynamicData);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 840,
        "wires": [
            [
                "33aaf9c2fd99f53c"
            ]
        ]
    },
    {
        "id": "8f691c288c1f6836",
        "type": "catch",
        "z": "40f4cc790d5ae165",
        "g": "555eaac7da85a4b8",
        "name": "Catch group",
        "scope": "group",
        "uncaught": false,
        "x": 1090,
        "y": 580,
        "wires": [
            [
                "183ac8d8ebb68977"
            ]
        ]
    },
    {
        "id": "af33e085b70123b0",
        "type": "debug",
        "z": "40f4cc790d5ae165",
        "g": "555eaac7da85a4b8",
        "name": "Strategy errors",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1320,
        "y": 580,
        "wires": []
    },
    {
        "id": "e311cd0b8d00f0e1",
        "type": "comment",
        "z": "40f4cc790d5ae165",
        "g": "555eaac7da85a4b8",
        "name": "Cheapest Energy Hours - errors",
        "info": "\"No valid sensor found\" if price_data is none and not valid_sensor,\n\"No valid data in {}\".format(sensor) if price_data is none and data == [] and valid_sensor,\n\"No valid data in provided price_data\" if price_data is not none and not valid_price_data,\n\"Time key '{}' not found in data\".format(time_key) if data and time_key not in data[0],\n\"Value key '{}' not found in data\".format(value_key) if data and value_key not in data[0],\n\"Invalid mode '{}' selected\".format(mode) if mode not in modes,\n\"Boolean input expected for include_today, '{}' can not be processed as a boolean\".format(include_today) if include_today | bool(\"\") is not boolean,\n\"Boolean input expected for include_tomorrow, '{}' can not be processed as a boolean\".format(include_tomorrow) if include_tomorrow | bool(\"\") is not boolean,\n\"Boolean input expected for look_ahead, '{}' can not be processed as a boolean\".format(look_ahead) if look_ahead | bool(\"\") is not boolean,\n\"Boolean input expected for lowest, '{}' can not be processed as a boolean\".format(lowest) if lowest | bool(\"\") is not boolean,\n\"Boolean input expected for latest_possible, '{}' can not be processed as a boolean\".format(latest_possible) if latest_possible | bool(\"\") is not boolean,\n\"Numeric input or percentage expected for price_tolerance, '{}' can not be processed as a float or percentage\".format(price_tolerance) if not valid_pt,\n\"Numeric input expected for kwh, '{}' can not be processed as a float\".format(kwh) if kwh is not none and not kwh | is_number,\n\"Selected program '{}' is not available or has no data\".format(program) if program is not none and w is none,\n\"Selected start parameter is after the end parameter\" if start_end and data,\n\"{} hours between start and end, where {} hours are required\".format(end_start, h | round(3)) if not start_end and end_start < h | round(3) and data,\n\"Invalid combination of source data points per hour '{}' and number of weight points '{}'\".format(dp, dph) if all_keys and not wp_check",
        "x": 1150,
        "y": 540,
        "wires": []
    },
    {
        "id": "183ac8d8ebb68977",
        "type": "function",
        "z": "40f4cc790d5ae165",
        "g": "555eaac7da85a4b8",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1195,
        "y": 580,
        "wires": [
            [
                "af33e085b70123b0"
            ]
        ],
        "l": false
    },
    {
        "id": "c57f9f835deb8fe5",
        "type": "function",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "Cache check",
        "func": "// Check if cache can be used or a new call to Data Source is required\nconst log = global.get('logger');\n\n// Retrieve stored data from flow context\nconst previousValues = flow.get(\"previous_sensor_values\") || {};\nconst cachedData = flow.get(\"cached_dynamic_data\");\n\n// Create a string or object to represent current state\nconst currentValues = {\n    src: msg.dynamic.data_source,\n    hc: msg.dynamic.cheapest_hrs,\n    he: msg.dynamic.expensive_hrs\n};\n\n// Compare current with previous (JSON stringify is a quick way to compare objects)\nconst inputsMatch = JSON.stringify(currentValues) === JSON.stringify(previousValues);\n\n// Determine cache hit\nif (inputsMatch && cachedData){\n    // Cache HIT\n    node.status({ fill: \"green\", shape: \"dot\", text: `Cache hit` });\n    log(this,`*CACHE HIT* using stored tariff data`);\n\n    // Attach cached data to the message so following nodes can use it\n    msg.dynamic = cachedData;\n\n    // Output #1\n    return [msg, null];\n\n} else {\n    // Cache MISS\n    node.status({ fill: \"green\", shape: \"ring\", text: `Cache miss: ${JSON.stringify(currentValues) }` });\n\n    // Save current values for the next run\n    flow.set(\"previous_sensor_values\", currentValues);\n    \n    // Output #2\n    return [null, msg];\n}",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1270,
        "y": 420,
        "wires": [
            [
                "c85b67169cd76834"
            ],
            [
                "d3283f3f93d6e646"
            ]
        ],
        "outputLabels": [
            "Cache HIT",
            "Cache MISS"
        ]
    },
    {
        "id": "c85b67169cd76834",
        "type": "link out",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "from Cache Check ok",
        "mode": "link",
        "links": [
            "face4b997b2e16fb"
        ],
        "x": 1375,
        "y": 400,
        "wires": []
    },
    {
        "id": "5a9e5d47a95a595a",
        "type": "link in",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "link Fetch from Data Source",
        "links": [
            "d3283f3f93d6e646"
        ],
        "x": 295,
        "y": 560,
        "wires": [
            [
                "ba1be87033cd7c29"
            ]
        ]
    },
    {
        "id": "d3283f3f93d6e646",
        "type": "link out",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "from Cache Check NoK",
        "mode": "link",
        "links": [
            "5a9e5d47a95a595a"
        ],
        "x": 1375,
        "y": 440,
        "wires": []
    },
    {
        "id": "face4b997b2e16fb",
        "type": "link in",
        "z": "40f4cc790d5ae165",
        "g": "23707522e38a45cc",
        "name": "link Determine Strategy",
        "links": [
            "33aaf9c2fd99f53c",
            "c85b67169cd76834"
        ],
        "x": 295,
        "y": 940,
        "wires": [
            [
                "2e4d31794ebd5213"
            ]
        ]
    },
    {
        "id": "33aaf9c2fd99f53c",
        "type": "link out",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "link out 12",
        "mode": "link",
        "links": [
            "face4b997b2e16fb"
        ],
        "x": 635,
        "y": 840,
        "wires": []
    },
    {
        "id": "e23ef0f572f54a81",
        "type": "function",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "Clear Cache",
        "func": "// Clear cache\nflow.set(\"cached_dynamic_data\", undefined);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 635,
        "y": 420,
        "wires": [
            [
                "2c984fa1a7fb0bba"
            ]
        ],
        "l": false
    },
    {
        "id": "a37c7456045aa7c0",
        "type": "ha-fire-event",
        "z": "40f4cc790d5ae165",
        "g": "79b4bc9416fb8873",
        "name": "",
        "server": "176d29a.6f648d6",
        "version": 0,
        "event": "update_energy_prices",
        "data": "msg.all_data",
        "dataType": "jsonata",
        "x": 760,
        "y": 1760,
        "wires": [
            []
        ]
    },
    {
        "id": "f4d67481aae08a87",
        "type": "api-render-template",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "All",
        "server": "176d29a.6f648d6",
        "version": 0,
        "template": "",
        "resultsLocation": "dynamic.data_all",
        "resultsLocationType": "msg",
        "templateLocation": "",
        "templateLocationType": "none",
        "x": 450,
        "y": 780,
        "wires": [
            [
                "50bc48fab854b122"
            ]
        ]
    },
    {
        "id": "50bc48fab854b122",
        "type": "json",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "",
        "property": "dynamic.data_all",
        "action": "obj",
        "pretty": false,
        "x": 535,
        "y": 780,
        "wires": [
            [
                "5b9b60d1bb446ee0",
                "8472683db498d930"
            ]
        ],
        "l": false
    },
    {
        "id": "bf14bb1756b9f976",
        "type": "change",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Set",
        "rules": [
            {
                "t": "set",
                "p": "template",
                "pt": "msg",
                "to": "dynamic.template_all",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 330,
        "y": 780,
        "wires": [
            [
                "f4d67481aae08a87"
            ]
        ]
    },
    {
        "id": "429b03e356acd25d",
        "type": "ha-fire-event",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Update energy prices",
        "server": "176d29a.6f648d6",
        "version": 0,
        "event": "update_energy_prices",
        "data": "msg.dynamic.data_all",
        "dataType": "jsonata",
        "x": 860,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "52a67c0485d66ecd",
        "type": "debug",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Template all",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "dynamic.template_all",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 830,
        "y": 660,
        "wires": []
    },
    {
        "id": "8472683db498d930",
        "type": "function",
        "z": "40f4cc790d5ae165",
        "g": "b80e9ec722e5a813",
        "name": "Convert price",
        "func": "// logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// Conversion\nconst CONVERSION_RATE = parseFloat(RED.util.getMessageProperty(msg, \"dynamic.value_conversion\")) || 1;\n\n// Check if the list exists and is an array to prevent errors\nif (msg.dynamic && msg.dynamic.data_all && Array.isArray(msg.dynamic.data_all.list)) {\n    \n    // Create a new array where each value is multiplied\n    if (Array.isArray(msg.dynamic.data_all?.list)) {\n        msg.dynamic.data_all.list = msg.dynamic.data_all.list.map(v => v / CONVERSION_RATE * 100); // cents\n    }\n\n    // Update other fields\n    if (msg.dynamic.data_all?.average) {\n        msg.dynamic.data_all.average = parseInt(msg.dynamic.data_all.average / CONVERSION_RATE * 100); // cents\n    }\n} else {\n    // Do not continue\n    log(this,\"*price data not updated* price data missing\");\n    return null;\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 670,
        "y": 780,
        "wires": [
            [
                "429b03e356acd25d"
            ]
        ]
    },
    {
        "id": "dd4400b8aaca8fa8",
        "type": "inject",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 410,
        "y": 460,
        "wires": [
            [
                "584ea9bf3c938a9e"
            ]
        ]
    },
    {
        "id": "584ea9bf3c938a9e",
        "type": "api-call-service",
        "z": "40f4cc790d5ae165",
        "g": "0d613ca6f7bf63bc",
        "name": "Debug ON",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_boolean.turn_on",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_boolean.house_battery_control_is_debug_mode"
        ],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [
            {
                "property": "debug_mode",
                "propertyType": "global",
                "value": "true",
                "valueType": "bool"
            }
        ],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_boolean",
        "service": "turn_on",
        "x": 550,
        "y": 460,
        "wires": [
            [
                "e23ef0f572f54a81"
            ]
        ]
    },
    {
        "id": "bfc5eb5acb828da0",
        "type": "link in",
        "z": "e2e92ce99c1547de",
        "g": "e7df81a552114eba",
        "name": "Full stop",
        "links": [],
        "x": 100,
        "y": 160,
        "wires": [
            [
                "6053cb616c1a5967"
            ]
        ],
        "l": true
    },
    {
        "id": "881141dc555d41fa",
        "type": "link out",
        "z": "e2e92ce99c1547de",
        "g": "220a89fef0bc8865",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 505,
        "y": 180,
        "wires": []
    },
    {
        "id": "49316e1559b2ad4d",
        "type": "function",
        "z": "e2e92ce99c1547de",
        "name": "Stop all batteries",
        "func": "// Logger\nconst log = global.get(\"logger\");\nlog(this,`full stop`);\n\n// Process\nlet solution_array = [];\n\n// Add a solution per battery\nmsg.batteries.forEach(battery => {\n    solution_array.push({ id: battery.id, \n    mode: \"stop\", // disengages Marstek Battery\n    power: 0 }); // set power to 0W\n});\n\n// OUTPUT\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "881141dc555d41fa"
            ]
        ]
    },
    {
        "id": "1a0f0ab87d3fcdf9",
        "type": "comment",
        "z": "e2e92ce99c1547de",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "e4636b01bb8ea48d",
        "type": "comment",
        "z": "e2e92ce99c1547de",
        "g": "220a89fef0bc8865",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 560,
        "y": 120,
        "wires": []
    },
    {
        "id": "ec993d308faca38a",
        "type": "comment",
        "z": "e2e92ce99c1547de",
        "g": "e7df81a552114eba",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 110,
        "y": 120,
        "wires": []
    },
    {
        "id": "6053cb616c1a5967",
        "type": "change",
        "z": "e2e92ce99c1547de",
        "g": "e7df81a552114eba",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 200,
        "wires": [
            [
                "49316e1559b2ad4d"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "fa5ab492d64cf943",
        "type": "catch",
        "z": "e2e92ce99c1547de",
        "g": "83f7374753c3a642",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 55,
        "y": 300,
        "wires": [
            [
                "b130e82d23b45b07"
            ]
        ],
        "l": false
    },
    {
        "id": "b130e82d23b45b07",
        "type": "function",
        "z": "e2e92ce99c1547de",
        "g": "83f7374753c3a642",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 105,
        "y": 300,
        "wires": [
            [
                "f387e1edf070fd19"
            ]
        ],
        "l": false
    },
    {
        "id": "f387e1edf070fd19",
        "type": "link out",
        "z": "e2e92ce99c1547de",
        "g": "83f7374753c3a642",
        "name": "link out 6",
        "mode": "return",
        "links": [],
        "x": 155,
        "y": 300,
        "wires": []
    },
    {
        "id": "c1fafc90dc699683",
        "type": "link in",
        "z": "5d26e71db8139b01",
        "g": "86b007234209c00c",
        "name": "Self-consumption",
        "links": [],
        "x": 160,
        "y": 160,
        "wires": [
            [
                "30a8958fddde3d77"
            ]
        ],
        "l": true
    },
    {
        "id": "3a4abdb0e5be3969",
        "type": "comment",
        "z": "5d26e71db8139b01",
        "g": "86b007234209c00c",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the Link In in this start group exactly after the option configured in your\nselect_input.house_battery_strategy\n\nfound in the file:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nWill point to the flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 150,
        "y": 120,
        "wires": []
    },
    {
        "id": "39e00ee2d2e74c7c",
        "type": "comment",
        "z": "5d26e71db8139b01",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 120,
        "y": 40,
        "wires": []
    },
    {
        "id": "b58fdf55cd321cce",
        "type": "server-state-changed",
        "z": "5d26e71db8139b01",
        "g": "e8bce85a58c2493e",
        "name": "User Ki change",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_number.house_battery_control_ki"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": true,
        "ignorePrevStateUnknown": true,
        "ignorePrevStateUnavailable": true,
        "ignoreCurrentStateUnknown": true,
        "ignoreCurrentStateUnavailable": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 100,
        "wires": [
            [
                "ab0edccc6a19e6d7"
            ]
        ]
    },
    {
        "id": "ab0edccc6a19e6d7",
        "type": "function",
        "z": "5d26e71db8139b01",
        "g": "e8bce85a58c2493e",
        "name": "Integral term adjust",
        "func": "// On change of Ki setting\nlet logdata = \"bumpless \";\nlet I_sum = flow.get(\"I_integral_sum\");\nlet Ki = msg.payload || 0;     // Integral gain\nlet Ki_last = context.get(\"house_battery_control_ki_last\")||0;\n\n// if Ki was or has become zero\nif(Ki == 0 || Ki_last == 0){\n    // passify the integral-sum\n    flow.set(\"I_integral_sum\",0);\n    context.set(\"house_battery_control_ki_last\", Ki);\n    logdata += `to/from 0, Ki=${Ki_last} -> ${Ki} | `;\n    // done\n    return { payload: logdata };\n}\n\n// change in Ki\nlet dKi = parseFloat(Ki/Ki_last);\nif(dKi <= 0) dKi = 1; // ignore erroneous changes\n\n// keep I-term constant by compensating the integral-sum for the change in Ki\n// e.g. if Ki got 10% smaller, then integral-sum should increase 10%, to keep the I-term constant\nlet I_sum_new = I_sum / dKi;\nlogdata += `change of I: from ${Ki_last} to ${Ki} (${dKi * 100}%) | `;\n\n// OUTFLOW\nflow.set(\"I_integral_sum\", I_sum_new);\ncontext.set(\"house_battery_control_ki_last\", Ki);\n\n// OUTPUT\nreturn { payload: logdata };",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\n// init last state\nlet Ki = flow.get(\"house_battery_control_ki\") || 0;\ncontext.set(\"house_battery_control_ki_last\", Ki);",
        "finalize": "",
        "libs": [],
        "x": 1730,
        "y": 160,
        "wires": [
            [
                "7f4c717b834a73ca"
            ]
        ]
    },
    {
        "id": "3b0b82530c8e63c6",
        "type": "comment",
        "z": "5d26e71db8139b01",
        "g": "e8bce85a58c2493e",
        "name": "Bumpless Ki changes",
        "info": "Recalc I-term whenever Ki changes\n\nNote: always be mindful of making changes to control parameters of systems in operation.",
        "x": 1740,
        "y": 60,
        "wires": []
    },
    {
        "id": "7f4c717b834a73ca",
        "type": "debug",
        "z": "5d26e71db8139b01",
        "g": "e8bce85a58c2493e",
        "name": "Logdata",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1700,
        "y": 220,
        "wires": []
    },
    {
        "id": "da7b577393230824",
        "type": "switch",
        "z": "5d26e71db8139b01",
        "g": "b49341a060f7470b",
        "name": "Check for custom/auto mode",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Manual control",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Marstek control",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "Full control",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1855,
        "y": 520,
        "wires": [
            [
                "c438ab1cd716fe37",
                "a7bef83d0b4bcd56"
            ],
            [
                "c438ab1cd716fe37",
                "a7bef83d0b4bcd56"
            ],
            [
                "a7bef83d0b4bcd56"
            ]
        ],
        "l": false
    },
    {
        "id": "a7bef83d0b4bcd56",
        "type": "debug",
        "z": "5d26e71db8139b01",
        "g": "b49341a060f7470b",
        "name": "Master control switch",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 2060,
        "y": 520,
        "wires": []
    },
    {
        "id": "ad2c2c6dce0b2274",
        "type": "server-state-changed",
        "z": "5d26e71db8139b01",
        "g": "b49341a060f7470b",
        "name": "Master control mode",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_select.marstek_master_battery_mode"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1730,
        "y": 520,
        "wires": [
            [
                "da7b577393230824"
            ]
        ]
    },
    {
        "id": "0a2d9604e40d0511",
        "type": "api-call-service",
        "z": "5d26e71db8139b01",
        "g": "b49341a060f7470b",
        "name": "Integral PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_i_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2050,
        "y": 360,
        "wires": [
            [
                "81df299566ce4e2d"
            ]
        ]
    },
    {
        "id": "81df299566ce4e2d",
        "type": "api-call-service",
        "z": "5d26e71db8139b01",
        "g": "b49341a060f7470b",
        "name": "Differential PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_d_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2060,
        "y": 400,
        "wires": [
            [
                "1d6218eb7a12e548"
            ]
        ]
    },
    {
        "id": "c438ab1cd716fe37",
        "type": "api-call-service",
        "z": "5d26e71db8139b01",
        "g": "b49341a060f7470b",
        "name": "Proportinal PID to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_p_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2060,
        "y": 320,
        "wires": [
            [
                "0a2d9604e40d0511"
            ]
        ]
    },
    {
        "id": "1d6218eb7a12e548",
        "type": "api-call-service",
        "z": "5d26e71db8139b01",
        "g": "b49341a060f7470b",
        "name": "PID Output to zero",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output"
        ],
        "labelId": [],
        "data": "{\"value\": \"0\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 2050,
        "y": 440,
        "wires": [
            [
                "5479e9729e5da5ec"
            ]
        ]
    },
    {
        "id": "5479e9729e5da5ec",
        "type": "change",
        "z": "5d26e71db8139b01",
        "g": "b49341a060f7470b",
        "name": "Integral sum to zero",
        "rules": [
            {
                "t": "set",
                "p": "I_integral_sum",
                "pt": "flow",
                "to": "0",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2060,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "c4f9e2721bd6b163",
        "type": "api-current-state",
        "z": "5d26e71db8139b01",
        "g": "5ce1864b98cfe6dc",
        "name": "Target grid consumption",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_target_grid_consumption_in_w",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_target_grid_consumption_in_w",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 570,
        "y": 120,
        "wires": [
            [
                "3ca23b7ec5964d4b"
            ]
        ],
        "info": "Set at 0 to strive for zero consumption"
    },
    {
        "id": "7d1362107ebc0e95",
        "type": "api-current-state",
        "z": "5d26e71db8139b01",
        "g": "4f7844f9b0aa3e88",
        "name": "Hysteresis",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_hysteresis_in_w",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_hysteresis_in_w",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1010,
        "y": 120,
        "wires": [
            [
                "15d4b1ea3664f212"
            ]
        ]
    },
    {
        "id": "d752b766b50c1b46",
        "type": "api-current-state",
        "z": "5d26e71db8139b01",
        "g": "5ce1864b98cfe6dc",
        "name": "PID P-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_kp",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_kp",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 410,
        "y": 180,
        "wires": [
            [
                "95c361bf2bad8003"
            ]
        ]
    },
    {
        "id": "95c361bf2bad8003",
        "type": "api-current-state",
        "z": "5d26e71db8139b01",
        "g": "5ce1864b98cfe6dc",
        "name": "PID I-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_ki",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_ki",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 590,
        "y": 180,
        "wires": [
            [
                "4d3a60e5f7c7da9b"
            ]
        ]
    },
    {
        "id": "4d3a60e5f7c7da9b",
        "type": "api-current-state",
        "z": "5d26e71db8139b01",
        "g": "5ce1864b98cfe6dc",
        "name": "PID D-value",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_kd",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_kd",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 770,
        "y": 180,
        "wires": [
            [
                "a11b6efa02f965ac"
            ]
        ]
    },
    {
        "id": "15d4b1ea3664f212",
        "type": "function",
        "z": "5d26e71db8139b01",
        "g": "4f7844f9b0aa3e88",
        "name": "Advanced settings",
        "func": "// 1. Hard coded advanced settings (flow level)\nflow.set(\"has_soc_charging_limiter\", true);         // slows charging from 90% to 100% to improve battery life\nflow.set(\"has_reverse_priority_discharge\", true);   // Prioritize discharging and charging the same battery when possible\nflow.set(\"master_gain\", 1);                         // Gain scheduling. Not Implemented!\n\n// 2. Configurable advanced settings (msg level)\nmsg.advanced_settings ||= {}; // creates 'advanced_settings' if it does net yet exist\nlet mas = msg.advanced_settings;\n\n// disable charge or dicharge solutions and changes them to stop solutions\nRED.util.setMessageProperty(msg,\"advanced_settings.discharge_disabled\", mas.discharge_disabled ?? false);\nRED.util.setMessageProperty(msg,\"advanced_settings.charge_disabled\", mas.charge_disabled ?? false);\n// The nullish coalescing (??) operator is a logical operator that returns its right-hand side operand when its left-hand side operand is null or undefined\n\n// 3. continue\nreturn msg;\n\n// Notes for home battery tinkerer friends:\n// Using RED.util.getMessageProperty / RED.util.setMessageProperty is more performant and safe.\n// If any part of the path (\"foo.bar\") is missing, it will return 'undefined' without throwing an error.",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1030,
        "y": 180,
        "wires": [
            [
                "63c323ec62ca6ab6"
            ]
        ]
    },
    {
        "id": "a11b6efa02f965ac",
        "type": "api-current-state",
        "z": "5d26e71db8139b01",
        "g": "4f7844f9b0aa3e88",
        "name": "Idle time before Stop",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_idle_time",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "idle_time_minutes",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 1040,
        "y": 80,
        "wires": [
            [
                "7d1362107ebc0e95"
            ]
        ]
    },
    {
        "id": "86fc2555e948e84b",
        "type": "comment",
        "z": "5d26e71db8139b01",
        "g": "a9eba6e7787f98b8",
        "name": "Setpoint ramping / damping",
        "info": "",
        "x": 460,
        "y": 460,
        "wires": []
    },
    {
        "id": "63c323ec62ca6ab6",
        "type": "api-current-state",
        "z": "5d26e71db8139b01",
        "g": "a9eba6e7787f98b8",
        "name": "Error signal dampening",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_error_signal_dampening",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_error_signal_dampening",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 340,
        "wires": [
            [
                "c22226e49ce62190"
            ]
        ]
    },
    {
        "id": "c22226e49ce62190",
        "type": "api-current-state",
        "z": "5d26e71db8139b01",
        "g": "a9eba6e7787f98b8",
        "name": "Output signal dampening",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_control_pid_output_dampening",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_control_pid_output_dampening",
                "propertyType": "flow",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 380,
        "wires": [
            [
                "a20d6518251c39b9"
            ]
        ]
    },
    {
        "id": "a20d6518251c39b9",
        "type": "function",
        "z": "5d26e71db8139b01",
        "g": "a9eba6e7787f98b8",
        "name": "Set: Error signal",
        "func": "// INPUTS\nlet P1_error_last = Number(context.get(\"p1_error_last\"))||0; // last error signal level in W\nlet dampening = Number(flow.get(\"house_battery_control_error_signal_dampening\")) || 0; // 0% - 100%\ndampening = dampening / 100; // to Number\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = Number(RED.util.getMessageProperty(msg,\"house_target_grid_consumption_in_w\")); // SP: target value\n\n// Calc error signal\nlet P1_error_unfiltered = P1_setpoint - P1_power;\n\n// Simple averaging filter\nlet P1_error_filtered = (1 - dampening) * P1_error_unfiltered + (dampening) * P1_error_last;\n\n// OUTFLOW\ncontext.set(\"p1_error_last\", P1_error_filtered);\n\n// OUTPUT\nmsg.grid_error = P1_error_filtered; // W (watt), error signal = SP - PV\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 420,
        "wires": [
            [
                "eebb56edb9223224"
            ]
        ]
    },
    {
        "id": "389047b3ce51eaa2",
        "type": "comment",
        "z": "5d26e71db8139b01",
        "g": "fb15e6655c6ae90a",
        "name": "Bumpless target grid consumption",
        "info": "The error value is used by default to calculate the derivative.\nWhen the target grid consumption (tgc) is changed, the system is takes the derivative of the process variable instead.\nThis prevents irratic behavior during sudden changes of the error or setpoint value.\n\ne.g. you change the setpoint from 0 to 100W \nThe error would make an instantanious jump and cause a huge derivative-term.\nThe pv stays continous and fluent.\n\nAfter 1 control tick the derivative is taken from error again.\nUntil the `tgc` is changed again.",
        "x": 780,
        "y": 440,
        "wires": []
    },
    {
        "id": "584921887c4d5257",
        "type": "function",
        "z": "5d26e71db8139b01",
        "g": "fb15e6655c6ae90a",
        "name": "Derivative PV",
        "func": "var P1_power = msg.grid_power||0;\nvar P1_last_power = Number(context.get(\"p1_last_power\")) ||0;\n\n// PV derivative\nvar p1_derivative = P1_power - P1_last_power; // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_power\", P1_power);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 500,
        "wires": [
            [
                "0210d8049439506c"
            ]
        ]
    },
    {
        "id": "63c64fdd1ceb4bf9",
        "type": "switch",
        "z": "5d26e71db8139b01",
        "g": "fb15e6655c6ae90a",
        "name": "Target grid consumption unchanged",
        "property": "house_target_grid_consumption_in_w",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "",
                "vt": "prev"
            },
            {
                "t": "neq",
                "v": "",
                "vt": "prev"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 780,
        "y": 480,
        "wires": [
            [
                "0f4874b4b801709c"
            ],
            [
                "584921887c4d5257"
            ]
        ]
    },
    {
        "id": "0f4874b4b801709c",
        "type": "function",
        "z": "5d26e71db8139b01",
        "g": "fb15e6655c6ae90a",
        "name": "Derivative Error",
        "func": "var P1_error = msg.grid_error||0;\nvar P1_last_error = Number(context.get(\"p1_last_error\")) ||0;\n\n// Error derivative\n// note: error = -PV\n// note: for simplicity we assume 1 second time steps\nlet p1_derivative = -(P1_error - P1_last_error); // devided by unity seconds\n\n// OUTFLOW\ncontext.set(\"p1_last_error\", P1_error);\n\n// OUTPUT\nmsg.grid_derivative = p1_derivative;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 460,
        "wires": [
            [
                "0210d8049439506c"
            ]
        ]
    },
    {
        "id": "0210d8049439506c",
        "type": "function",
        "z": "5d26e71db8139b01",
        "g": "fb15e6655c6ae90a",
        "name": "Derivative final value",
        "func": "\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1240,
        "y": 480,
        "wires": [
            [
                "448c9f2401339fb2"
            ]
        ]
    },
    {
        "id": "eebb56edb9223224",
        "type": "function",
        "z": "5d26e71db8139b01",
        "g": "38233dae86fec512",
        "name": "Deadband (15W)",
        "func": "// Deadband\n// Stop processing if error is within .. Watt of target grid consumption.\n// This to reduce CPU loads \n\n// Logger\nconst log = global.get(\"logger\");\n\n// P1\nlet P1_error = msg.grid_error; // Watt\nlet P1_deadband = 15; // Watt\n\n// TODO\n// based on last 'assignable power' and current error, if (error > assignable power) the system will never enter the deadband. And keep calculating each interation.\n// however since we don't know if the is the assignable power will change, until we calculate the Control Value / load balancer\n// we could end up in a deadlock if we simply stop execution here, based on assignable power alone.\n\n// Within Deadband\nif(Math.abs(P1_error) < P1_deadband) {\n    // stop processing\n    node.status({fill:\"yellow\",shape:\"dot\",text:`Halt, ${Math.round(Math.abs(P1_error))} W`});\n    log(this, `**Stopped processing**🌿power saving, ${Math.round(Math.abs(P1_error))} W is within deadband of ${P1_deadband} W`);\n    msg.payload = 'halted by deadband';\n    return msg;\n} \n\n// Outside deadband\nnode.status({fill:\"green\",shape:\"dot\",text:`Pass, ${Math.round(Math.abs(P1_error))} W`});\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 340,
        "wires": [
            [
                "7a33eb931047b075"
            ]
        ]
    },
    {
        "id": "448c9f2401339fb2",
        "type": "function",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "Calculate corrections",
        "func": "// Logger\nvar logdata = \"\"; // deprecated\nconst log = global.get(\"logger\");\n\n// Timing\nlet time_last = context.get('time_last') || Date.now(); // Milliseconds\nlet time_current = Date.now(); // Milliseconds\nlet time_delta = (time_current - time_last) / 1000; // Convert to seconds\n// note: due to inherent 1 sec intervals of P1 meter we omit dt terms. This is mostly for bug checking and optimizations.\n\n// Batteries\nvar B_power = msg.batteries_total_power; // charging is positive, discharging negative\nvar anti_windup_threshold = Number(flow.get(\"batteries_total_assignable_power\")) || 0; // max available charge/discharge power.\n\n// Process Variable (PV) currently measured grid power, Setpoint (SP) desired grid power, set 0 for NoM\nvar P1_power = msg.grid_power; // PV: consume is positive, supply to grid is negative\nvar P1_setpoint = flow.get(\"house_target_grid_consumption_in_w\"); // SP: target value\nvar P1_error = msg.grid_error;  // W (watt), error signal = SP - PV\nvar P1_derivative = msg.grid_derivative; // Derivative of PV, not the error\n\n// PID values\nvar Kp = flow.get(\"house_battery_control_kp\") || 0.75;  // Proportional gain\nvar Ki = flow.get(\"house_battery_control_ki\") || 0;     // Integral gain        Ki = Kp/Ti\nvar Kd = flow.get(\"house_battery_control_kd\") || 0;     // Derivative gain      Kd = Kp*Td\n\n// helpers\nvar I_integral_sum = context.get('I_integral_sum') || 0;\nvar Gm = flow.get(\"master_gain\")||1; // gain scheduling\n\n// optimizations\nvar hysteresis = flow.get(\"house_battery_control_hysteresis_in_w\"); // W (watt)\n\n// advanced settings\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\");\nconst isChargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.charge_disabled\");\n\n// -- PID regulator --\n// Proportional term\nlet p_term = Gm * Kp * P1_error;\n\n// Integral term\nlet integral_max = 0;\nif (Ki > 0) {\n    // Integral term | integrate\n    I_integral_sum += P1_error; \n    // Integral term | apply anti-windup\n    integral_max = anti_windup_threshold / Ki; // the anti-windup value is set to the current controlable range of the batteries, given by the previous load balancer calculations\n    I_integral_sum = Math.min(Math.max(I_integral_sum, -integral_max), integral_max);\n} else {\n    // If Ki is 0, keep everything 0\n    I_integral_sum = 0;\n    integral_max = 0;\n}\n\n// Integral term | the term\nlet i_term = Ki * I_integral_sum;\n\n// Integral term | explain\nlogdata += `anti_windup_threshold=${anti_windup_threshold}, integral_max=${integral_max}| `; // deprecated\n\n// Differential term\nlet d_term = Gm * Kd * (-P1_derivative); // omitted '/time_delta'. inherent P1 refresh fequency.\n\n// Total PID output\nvar PID_output = p_term + i_term + d_term; // W (watt), the control input for the battery packs\n\n// Charging or Discharging states\nvar B_was_charging = context.get(\"batteries_charging_last\") || false;\nvar B_is_charging = PID_output > 0 ? true : false;\n\n// Explain\nlogdata += `U(${time_delta}s)[${PID_output}] = P(${Kp})[${p_term}] + I(${Ki})[${i_term}] + D(${Kd})[${d_term}] | `; // deprecated\nlog(this,`**PID Controller**`);\nlog(this,`Step size: ${time_delta} s`);\nif(Kp == 0 && Ki == 0 && Kd == 0) {\n    log(this, `<font color=\"orange\">**Controller disabled**</font> All PID gains are 0. Choose a PID preset or set gains > 0.`,\"warn\");\n} else {\n    // log(this, `P-term: ${Math.floor(p_term)} W @ P-gain ${Kp}`);\n    // log(this, `I-term: ${Math.floor(i_term)} W @ I-gain ${Ki} (max. ${anti_windup_threshold} W)`);\n    // log(this, `D-term: ${Math.floor(d_term)} W @ D-gain ${Kd}`);\n    log(this, `**P** ${Math.floor(p_term)} W @ gain ${Kp}<br>**I** ${Math.floor(i_term)} W @ gain ${Ki} (max. ${anti_windup_threshold} W)<br>**D** ${Math.floor(d_term)} W @ gain ${Kd}`);\n    log(this, `**PID ${B_is_charging ? 'Charge' : 'Discharge'}:** ${Math.floor(p_term)} + ${Math.floor(i_term)} + ${Math.floor(d_term)} = **${Math.round(PID_output)} Watt**`);\n}\n\n// Only one of the advanced settings below can be active at once.\n// Advanced setting | discharge disabled\nif(isDischargeDisabled && !B_is_charging) {\n    // log explain\n    logdata += `Discharging disabled, PID unwound U(${time_delta})[0]=0+0+0 | `;\n    log(this,'**PID capped at 0**. Discharge is disabled in this strategy'); // via `msg.advanced_settings`\n    // Set all PID terms to 0 and unwind integral sum\n    PID_output = 0;\n    p_term = 0;\n    i_term = 0;\n    d_term = 0;\n    I_integral_sum = 0; // unwind\n    // maintain charge scenario\n    B_is_charging = true;\n    \n// Advanced setting | charge disabled\n} else if (isChargeDisabled && B_is_charging) {\n    // log explain\n    logdata += `Charging disabled, PID unwound U(${time_delta})[0]=0+0+0 | `;\n    log(this,'**PID capped at 0**. Charge is disabled in this strategy'); // via `msg.advanced_settings`\n    // Set all PID terms to 0 and unwind integral sum\n    PID_output = 0;\n    p_term = 0;\n    i_term = 0;\n    d_term = 0;\n    I_integral_sum = 0; // unwind\n    // maintain discharge scenario\n    B_is_charging = false;\n\n// Advanced setting | hysteresis\n} else if \n// prevents excessive switching between (dis)charge mode around the zero point.\n// if new PID_output lies within hysteresis, it will not switch charge mode. \n// set hysteresis to 0, to apply no hysteresis\n(B_is_charging !== B_was_charging && Math.abs(PID_output) < hysteresis){\n    // log explain\n    logdata += `Hysteresis prevented charge mode switch from ${B_was_charging ? \"charging\" : \"discharging\"} to ${B_is_charging ? \"charging\" : \"discharging\"} as ${Math.abs(PID_output)}W <= ${hysteresis}(hyst) | `;\n    log(this,`Hysteresis prevented charge mode switch from ${B_was_charging ? \"charging\" : \"discharging\"} to ${B_is_charging ? \"charging\" : \"discharging\"} as ${Math.abs(PID_output)}W <= ${hysteresis}(hyst)`);\n    // prevent negative charging or positive discharging values (not allowed)\n    PID_output = (PID_output < 0 && B_is_charging) || ((PID_output > 0 && !B_is_charging)) ? 0 : PID_output;\n    // maintain previous scenario\n    B_is_charging = B_was_charging;\n} \n\n// save for next iteration\ncontext.set(\"batteries_charging_last\", B_is_charging); //boolean\n\n// OUTFLOW\ncontext.set(\"time_last\", Date.now());\ncontext.set(\"I_integral_sum\", I_integral_sum);\n\n// OUTPUT\nRED.util.setMessageProperty(msg, \"batteries_charging\", B_is_charging, true);\nRED.util.setMessageProperty(msg, \"I_integral_sum\", I_integral_sum,true);\nmsg.payload = Number(PID_output);\n\nreturn [msg, // payload = PID_output\n        { payload: Number(P1_error)},\n        { payload: parseFloat(p_term)},\n        { payload: parseFloat(i_term)},\n        { payload: parseFloat(d_term)},\n        { payload: B_is_charging},\n        { payload: logdata }];",
        "outputs": 7,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 700,
        "wires": [
            [
                "5b17d8c0e9afd36d"
            ],
            [
                "a0aa8bb0ca4aee9c"
            ],
            [
                "18435e8b07794fc1"
            ],
            [
                "3d81a7153a6c062e"
            ],
            [
                "af71cba378a24483"
            ],
            [
                "44f4a3db2ff26cb7"
            ],
            [
                "ea452de4b0a073f1"
            ]
        ],
        "inputLabels": [
            "battery_array"
        ]
    },
    {
        "id": "ea452de4b0a073f1",
        "type": "debug",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "Logdata",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 1060,
        "wires": []
    },
    {
        "id": "a0aa8bb0ca4aee9c",
        "type": "api-call-service",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "Error Signal",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_signal"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 730,
        "y": 760,
        "wires": [
            [
                "3638a82c6b79201e"
            ]
        ]
    },
    {
        "id": "266b25a0640fca3b",
        "type": "api-call-service",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "PID Output",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 730,
        "y": 700,
        "wires": [
            [
                "fbf3843ae55ad90e"
            ]
        ]
    },
    {
        "id": "446f941ddb1b7436",
        "type": "api-call-service",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "Proportinal term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_p_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 920,
        "y": 820,
        "wires": [
            []
        ]
    },
    {
        "id": "d86f4702f61d29ac",
        "type": "api-call-service",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "Integral term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_i_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 910,
        "y": 880,
        "wires": [
            []
        ]
    },
    {
        "id": "7a3ecaf39eb4ed8d",
        "type": "api-call-service",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "Differential term",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_d_term"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 920,
        "y": 940,
        "wires": [
            []
        ]
    },
    {
        "id": "c094882a33fd3073",
        "type": "debug",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "Charging",
        "active": false,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 900,
        "y": 1060,
        "wires": []
    },
    {
        "id": "fbf3843ae55ad90e",
        "type": "smooth",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "",
        "property": "payload",
        "action": "sd",
        "count": "8",
        "round": "",
        "mult": "single",
        "reduce": false,
        "x": 900,
        "y": 700,
        "wires": [
            [
                "8850373b7f822c9f"
            ]
        ]
    },
    {
        "id": "8850373b7f822c9f",
        "type": "api-call-service",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "PID deviation",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_pid_output_deviation"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1070,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "3638a82c6b79201e",
        "type": "smooth",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "",
        "property": "payload",
        "action": "sd",
        "count": "8",
        "round": "",
        "mult": "single",
        "reduce": false,
        "x": 900,
        "y": 760,
        "wires": [
            [
                "9157c0ea42014ccb"
            ]
        ]
    },
    {
        "id": "9157c0ea42014ccb",
        "type": "api-call-service",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "Error deviation",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_control_error_deviation"
        ],
        "labelId": [],
        "data": "{\"value\": \"{{payload}}\"}",
        "dataType": "json",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1080,
        "y": 760,
        "wires": [
            []
        ]
    },
    {
        "id": "5b17d8c0e9afd36d",
        "type": "function",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "Output dampening",
        "func": "// INPUT\nlet PID_unfiltered = msg.payload; // W Watt\nlet PID_last = context.get(\"PID_last\")||0; // W watt\nlet PID_damp = Number(flow.get(\"house_battery_control_pid_output_dampening\"))||0; // 0% - 100%\nPID_damp = PID_damp/100; // to Number\n\n// simple averaging filter\nlet PID_filtered = (1-PID_damp)*PID_unfiltered + (PID_damp)*PID_last;\n\n// OUTFLOW\ncontext.set(\"PID_last\", PID_filtered);\n\n// OUTPUT\nmsg.payload = Number(PID_filtered)\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 660,
        "wires": [
            [
                "ccf7199a199b07ba"
            ]
        ]
    },
    {
        "id": "ccf7199a199b07ba",
        "type": "function",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "Output failsafe",
        "func": "// INFLOW\nlet maxCharge = msg.batteries_max_charge_power||undefined;\nlet maxDischarge = msg.batteries_max_discharge_power||undefined;\nlet isCharging = msg.batteries_charging||undefined;\nlet PID_output = msg.payload; // Watt\n\n// No failsafe\nif (maxCharge === undefined || maxDischarge == undefined) {\n    node.status({ fill: \"red\", shape: \"dot\", text: \"disabled\" });\n    node.warn(`Output Failsafe is INACTIVE. Max charge or discharge limits are undefined`);\n    // continue without safeguard\n    return msg;\n} \n\n// limit\nlet limit = 0;\n\n// charging state unknown\nif(isCharging === undefined) {\n    // limit on lowest of charge / discharge\n    limit = Math.min(maxCharge,maxDischarge);    \n}\n// charging state known\nlimit = isCharging ? maxCharge : maxDischarge;\n\n// Safe output\nif (PID_output <= limit){\n    node.status({ fill: \"green\", shape: \"dot\", text: \"safe\" });\n    return msg;\n} \n\n// Unsafe, limit output\nnode.status({ fill: \"yellow\", shape: \"ring\", text: \"power limiting\" });\nmsg.payload = Number(limit);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1080,
        "y": 660,
        "wires": [
            [
                "cb222b79fb8cf895",
                "266b25a0640fca3b"
            ]
        ]
    },
    {
        "id": "3d81a7153a6c062e",
        "type": "rbe",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 880,
        "wires": [
            [
                "d86f4702f61d29ac"
            ]
        ]
    },
    {
        "id": "cb222b79fb8cf895",
        "type": "function",
        "z": "5d26e71db8139b01",
        "g": "d9a650b4cb418aa3",
        "name": "Load distribution",
        "func": "// Logger\nconst log = global.get(\"logger\");\nlog(this,\"**PID load distribution**\");\n\n// INPUT\nvar batteries = msg.batteries; // Battery configuration as provided by `Home Batteries IO` flow\nvar isCharging = msg.batteries_charging; // Are we in a battery charging scenario?\nvar hasChargingLimiter = flow.get(\"has_soc_charging_limiter\") || false; // Battery life improvement\nvar hasReverseDischargePriority = flow.get(\"has_reverse_priority_discharge\") || false; // Prioritize (dis)charging the same battery\nconst isDischargeDisabled = RED.util.getMessageProperty(msg,\"advanced_settings.discharge_disabled\"); // Disallow discharging?\n\n// how much power do the batteries need to compensate?\nconst unassigned_power_initial = Math.round(Math.abs(msg.payload)); // Power in W to compensate using batteries\nvar unassigned_power = unassigned_power_initial; // Before distribution\nlog(this,`How much power do the batteries need to compensate: ${unassigned_power} W`);\n\n// inits \nvar solution_array = []; // load distribution solutions\nvar batteries_total_assignable_power = 0; // Current max. available total (dis)charge power. Exceeding this max should trigger the anti-windup routine for the Integral terms\n\n// enums\nconst CMODE = {\n    STOP: \"stop\", // Marstek batteries disconnect a relay when this is set or Power is 0W\n    CHARGE: \"charge\",\n    DISCHARGE: \"discharge\"\n}\n\n/**\n** Battery life improvement (slow charge near max SoC)\n* @param {number} soc\n* @param {number} max_power\n*/\nfunction chargingLimiter(soc, max_power) {\n    // Must be greater than zero\n    let limitedPower = Math.max(0, max_power); \n\n    // Limit charge at high SoC\n    if (hasChargingLimiter) {\n        if (soc >= 98)      limitedPower = Math.min(300, limitedPower);\n        else if (soc >= 95) limitedPower = Math.min(500, limitedPower);\n        else if (soc >= 85) limitedPower = Math.min(1500, limitedPower);\n    }\n    return limitedPower;\n}\n\n/**\n* battery life improvement (disconnects battery only if the battery is not used for ... seconds)\n* @param {string | number} batteryID\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getStopSolution(batteryID) {\n    // idle time, before stop is given to inverter relay.\n    let time_idle_minimum = flow.get(\"idle_time_minutes\")*60*1000||0; // Milliseconds\n\n    // retrieve last registered active times for each battery based on their ids\n    let lasttime_active = context.get(\"lasttime_active\");\n    \n    // battery exists in register \n    if(lasttime_active[batteryID] !== undefined){\n        // timing\n        let time_last = lasttime_active[batteryID]; // Milliseconds \n        let time_now = Date.now();                  // Milliseconds \n        let time_idle = (time_now - time_last); // Milliseconds\n        \n        // battery is ready for STOP\n        if (time_idle >= time_idle_minimum) {\n            log(this,`Battery ${batteryID} [STOP]: 0 Watt and disconnect relay.`);\n            return {id: batteryID, mode: CMODE.STOP, power:0}; // STOP or 0 Watt disconnects relay\n        }\n        \n        // battery is kept IDLE, while awaiting minimum inactive time\n        log(this,`Battery ${batteryID} [IDLE]: 1 Watt for ${Math.round((time_idle_minimum-time_idle)/1000)}s. Keep relay engaged.`);\n        return { id: batteryID, mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE, power: 1 }; // 1 Watt keeps battery IDLE, keeping relay engaged\n    }\n\n    // battery missing in register\n    log(this,`Battery ${batteryID} [IDLE]: unknown last active time`);\n    return getActiveSolution(batteryID, 1); // set a last active time and engage idle state\n}\n\n/**\n* Get battery solution and register a last active time.\n* @param {any} batteryID\n* @param {number} assigned_power\n* @returns {{id: string|number, mode: string, power: number}} battery solution\n*/\nfunction getActiveSolution(batteryID, assigned_power){\n    // register battery as active\n    let lasttime_active = context.get(\"lasttime_active\")||[]; // last registered active times for each battery based on their ids\n    lasttime_active[batteryID] = Date.now();\n    context.set(\"lasttime_active\", lasttime_active);\n\n    // solution\n    return {\n        id: batteryID,\n        mode: isCharging ? CMODE.CHARGE : CMODE.DISCHARGE,\n        power: Math.round(assigned_power)\n    };\n}\n\n// -- BATTERY DISCHARGE PRIORITY\nif (!isCharging && hasReverseDischargePriority) {\n   batteries.reverse();\n}\n\n// -- LOAD BALANCER --\nbatteries.forEach((/** @type {{ id: any; soc: number; soc_min: number; soc_max: number; rs485: string; charging_max: number; discharging_max: any; }} */ battery) => {\n    \n    // Explain\n    log(this, `Battery ${battery.id}: ${battery.soc}% (min: ${battery.soc_min}%, max: ${battery.soc_max}%) ; RS485: ${battery.rs485=='enable'?'OK':'Nok'}`);\n\n    // track if the battery should be skipped and why\n    let skipReason = null;\n    if (battery.rs485 !== \"enable\") {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because RS485 is not 'enable'`;\n    } else if (isCharging && battery.soc >= battery.soc_max) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because SoC (${battery.soc}%) >= Max (${battery.soc_max}%) while charging`;\n    } else if (!isCharging && battery.soc <= battery.soc_min) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped because SoC (${battery.soc}%) <= Min (${battery.soc_min}%) while discharging`;\n    } else if (!isCharging && isDischargeDisabled) {\n        skipReason = `Battery ${battery.id} [SKIP]: skipped, discharging was disabled via msg property`;\n    }\n\n    // battery NOT AVAIABLE, skip via soft stop\n    if (skipReason !== null) {\n        log(this, skipReason);                      // communicate reason\n        let solution = getStopSolution(battery.id); // get a soft stop solution for this battery\n        solution_array.push(solution);              // add solution, do not update last active time.\n        // next battery\n        return; \n    }\n\n    // battery is AVAILABLE, assign power\n    let battery_assignable_power = isCharging ? chargingLimiter(battery.soc, battery.charging_max) : battery.discharging_max;\n    let assign = Math.min(unassigned_power, battery_assignable_power);\n    \n    // select solution\n    var solution;\n    if (assign <= 0 ) {\n        // no power solution\n        solution = getStopSolution(battery.id); // a soft stop solution\n        assign = 0;\n    } else {\n        // assigned power solution\n        solution = getActiveSolution(battery.id, Math.round(assign));\n    }\n    solution_array.push(solution);\n    \n    // Explain: charge limiting\n    if(unassigned_power > battery_assignable_power && battery_assignable_power < battery.charging_max) {\n        log(this,`Charging limited to protect battery (${battery.soc}%): ${battery.charging_max}W -> ${battery_assignable_power}W`);\n    }\n    // Explain: solution result\n    log(this, `<font color=\"#009ac7\">Battery ${solution.id}</font>: assigned to ${solution.mode} with ${solution.power}W / ${isCharging ? battery.charging_max : battery.discharging_max }W max.`)\n\n    // remaining power to assign\n    unassigned_power -= assign;\n    batteries_total_assignable_power += Number(battery_assignable_power);\n});\n\n// battery discharge priority - put solutions back in initial order\nif (!isCharging && hasReverseDischargePriority) {\n    solution_array.reverse();\n}\n\n// store solutions in msg\nRED.util.setMessageProperty(msg, \"solutions\", solution_array,true);\n// store remaining load distribution results and PID_OUPUT in msg\nRED.util.setMessageProperty(msg, \"pid.output\", unassigned_power_initial, true); // the dampenend & filtered PID_output equals the load requirement\nRED.util.setMessageProperty(msg, \"pid.load\", unassigned_power_initial, true); \nRED.util.setMessageProperty(msg, \"pid.load_capacity\", batteries_total_assignable_power, true);\nRED.util.setMessageProperty(msg, \"pid.load_assigned\", parseInt(unassigned_power_initial - unassigned_power), true);\nRED.util.setMessageProperty(msg, \"pid.load_unassigned\", unassigned_power,true);\n\n// OUTFLOW\nflow.set(\"batteries_total_assignable_power\", batteries_total_assignable_power); // this is set for the anti-windup calculation in the earlier 'calculate corrections' node, which will pick this up during next iteration.\n\n// OUTPUT\nreturn msg; // to Home Battery flow",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\n\ncontext.set(\"lasttime_active\",[]);",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 1160,
        "wires": [
            [
                "64f5ceb216ceef3e",
                "da3b239e0d4bfc8f"
            ]
        ],
        "inputLabels": [
            "isCharging (boolean)"
        ]
    },
    {
        "id": "64f5ceb216ceef3e",
        "type": "debug",
        "z": "5d26e71db8139b01",
        "g": "d9a650b4cb418aa3",
        "name": "Load distribution",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "solutions",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 640,
        "y": 1160,
        "wires": []
    },
    {
        "id": "7a33eb931047b075",
        "type": "switch",
        "z": "5d26e71db8139b01",
        "g": "38233dae86fec512",
        "name": "Pass or Halt",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "halted by deadband",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "halted by deadband",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 340,
        "wires": [
            [
                "a31368cd3b0883ac"
            ],
            [
                "63c64fdd1ceb4bf9"
            ]
        ]
    },
    {
        "id": "da3b239e0d4bfc8f",
        "type": "link out",
        "z": "5d26e71db8139b01",
        "g": "2a057006f3362b94",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 225,
        "y": 1240,
        "wires": []
    },
    {
        "id": "a93e023935baa08d",
        "type": "comment",
        "z": "5d26e71db8139b01",
        "g": "2a057006f3362b94",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 170,
        "y": 1180,
        "wires": []
    },
    {
        "id": "a31368cd3b0883ac",
        "type": "link out",
        "z": "5d26e71db8139b01",
        "g": "38233dae86fec512",
        "name": "go to End",
        "mode": "link",
        "links": [
            "8cf107fd9cca6b89"
        ],
        "x": 1090,
        "y": 340,
        "wires": [],
        "inputLabels": [
            "Halt"
        ],
        "l": true
    },
    {
        "id": "8cf107fd9cca6b89",
        "type": "link in",
        "z": "5d26e71db8139b01",
        "g": "2a057006f3362b94",
        "name": "link to End",
        "links": [
            "a31368cd3b0883ac"
        ],
        "x": 105,
        "y": 1240,
        "wires": [
            [
                "da3b239e0d4bfc8f"
            ]
        ]
    },
    {
        "id": "cf86b7aac680b96e",
        "type": "api-call-service",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "Is charging",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [],
        "labelId": [],
        "data": "",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": false,
        "domain": "",
        "service": "",
        "x": 1070,
        "y": 1000,
        "wires": [
            []
        ]
    },
    {
        "id": "a071c57355697c57",
        "type": "function",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "Config action",
        "func": "const value = msg.payload;\nconst target = \"input_boolean.house_battery_control_is_charging\";\n\nmsg.payload = {\n    \"action\": value?\"input_boolean.turn_on\":\"input_boolean.turn_off\",\n    \"target\": {\n        \"entity_id\": [target]\n    },\n    \"data\": {}\n}\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 1000,
        "wires": [
            [
                "cf86b7aac680b96e"
            ]
        ]
    },
    {
        "id": "d48e4488790c1bf8",
        "type": "switch",
        "z": "5d26e71db8139b01",
        "g": "5ce1864b98cfe6dc",
        "name": "Target",
        "property": "house_target_grid_consumption_in_w",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 390,
        "y": 120,
        "wires": [
            [
                "d66ec737d5123e73"
            ],
            [
                "c4f9e2721bd6b163"
            ]
        ]
    },
    {
        "id": "9eb92733afdf60da",
        "type": "debug",
        "z": "5d26e71db8139b01",
        "g": "5ce1864b98cfe6dc",
        "name": "Target",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "house_target_grid_consumption_in_w",
        "targetType": "msg",
        "statusVal": "house_target_grid_consumption_in_w",
        "statusType": "auto",
        "x": 790,
        "y": 100,
        "wires": []
    },
    {
        "id": "4baac7fe4baf93d5",
        "type": "server-state-changed",
        "z": "5d26e71db8139b01",
        "g": "b49341a060f7470b",
        "name": "Strategy changes",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "input_text.house_battery_strategy_active_sub_strategy",
                "input_select.house_battery_strategy"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 340,
        "wires": [
            [
                "101a40e78281e075"
            ]
        ]
    },
    {
        "id": "101a40e78281e075",
        "type": "switch",
        "z": "5d26e71db8139b01",
        "g": "b49341a060f7470b",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Full stop",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1855,
        "y": 340,
        "wires": [
            [
                "c438ab1cd716fe37"
            ]
        ],
        "l": false
    },
    {
        "id": "6c1122de5311c32c",
        "type": "server-state-changed",
        "z": "5d26e71db8139b01",
        "g": "b49341a060f7470b",
        "name": "Full stop trigger",
        "server": "176d29a.6f648d6",
        "version": 6,
        "outputs": 1,
        "exposeAsEntityConfig": "",
        "entities": {
            "entity": [
                "sensor.ev_is_charging"
            ],
            "substring": [],
            "regex": []
        },
        "outputInitially": false,
        "stateType": "str",
        "ifState": "",
        "ifStateType": "str",
        "ifStateOperator": "is",
        "outputOnlyOnStateChange": true,
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "eventData"
            },
            {
                "property": "topic",
                "propertyType": "msg",
                "value": "",
                "valueType": "triggerId"
            }
        ],
        "x": 1720,
        "y": 420,
        "wires": [
            [
                "87ce11a06e1c3f1d"
            ]
        ]
    },
    {
        "id": "87ce11a06e1c3f1d",
        "type": "switch",
        "z": "5d26e71db8139b01",
        "g": "b49341a060f7470b",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1855,
        "y": 420,
        "wires": [
            [
                "c438ab1cd716fe37"
            ]
        ],
        "l": false
    },
    {
        "id": "18435e8b07794fc1",
        "type": "rbe",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 820,
        "wires": [
            [
                "446f941ddb1b7436"
            ]
        ]
    },
    {
        "id": "af71cba378a24483",
        "type": "rbe",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 940,
        "wires": [
            [
                "7a3ecaf39eb4ed8d"
            ]
        ]
    },
    {
        "id": "44f4a3db2ff26cb7",
        "type": "rbe",
        "z": "5d26e71db8139b01",
        "g": "b6c3fe784b71241d",
        "name": "on change",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 730,
        "y": 1000,
        "wires": [
            [
                "a071c57355697c57",
                "c094882a33fd3073"
            ]
        ]
    },
    {
        "id": "30a8958fddde3d77",
        "type": "change",
        "z": "5d26e71db8139b01",
        "g": "86b007234209c00c",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 190,
        "y": 200,
        "wires": [
            [
                "d48e4488790c1bf8"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "992c8cb568677839",
        "type": "catch",
        "z": "5d26e71db8139b01",
        "g": "f3948f4466eb4cd9",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 95,
        "y": 320,
        "wires": [
            [
                "8f8521a708095a1a"
            ]
        ],
        "l": false
    },
    {
        "id": "8f8521a708095a1a",
        "type": "function",
        "z": "5d26e71db8139b01",
        "g": "f3948f4466eb4cd9",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 145,
        "y": 320,
        "wires": [
            [
                "f27f65127cbed990"
            ]
        ],
        "l": false
    },
    {
        "id": "f27f65127cbed990",
        "type": "link out",
        "z": "5d26e71db8139b01",
        "g": "f3948f4466eb4cd9",
        "name": "link out 7",
        "mode": "return",
        "links": [],
        "x": 195,
        "y": 320,
        "wires": []
    },
    {
        "id": "e0e13bac6e1b8ac6",
        "type": "comment",
        "z": "e5380aeea0a0d937",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 140,
        "y": 60,
        "wires": []
    },
    {
        "id": "7ac81cf5ed1478f2",
        "type": "link in",
        "z": "e5380aeea0a0d937",
        "g": "80c62629077e8227",
        "name": "Sell",
        "links": [],
        "x": 110,
        "y": 220,
        "wires": [
            [
                "ea29ed7e7647dbce"
            ]
        ],
        "l": true
    },
    {
        "id": "055c7cf6df183b65",
        "type": "comment",
        "z": "e5380aeea0a0d937",
        "g": "80c62629077e8227",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 130,
        "y": 140,
        "wires": []
    },
    {
        "id": "ea29ed7e7647dbce",
        "type": "change",
        "z": "e5380aeea0a0d937",
        "g": "80c62629077e8227",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 180,
        "wires": [
            [
                "f5c8c5d20289dddf"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "3465a104edeb1dde",
        "type": "link out",
        "z": "e5380aeea0a0d937",
        "g": "71d7999d1271aed6",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 185,
        "y": 580,
        "wires": []
    },
    {
        "id": "82f373b063985b1c",
        "type": "comment",
        "z": "e5380aeea0a0d937",
        "g": "71d7999d1271aed6",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 130,
        "y": 520,
        "wires": []
    },
    {
        "id": "b46223a8344215c5",
        "type": "function",
        "z": "e5380aeea0a0d937",
        "g": "03d081761135f651",
        "name": "Max power solution",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\nlog(this, \"Discharge at **max. power**\");\n\n// INPUT\nlet batteries = msg.batteries;\nlet solution_array = [];\n\n// build solution\nmsg.batteries.forEach(battery => {\n    const calculatedPower = Number(battery.discharging_max);\n\n    solution_array.push({\n        id: battery.id,\n        mode: \"discharge\",\n        power: calculatedPower\n    });\n\n});\n\n// return solution\nmsg.solutions = solution_array;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 360,
        "wires": [
            [
                "e67c0ca1b08116d3"
            ]
        ]
    },
    {
        "id": "295ec0e46565356b",
        "type": "link call",
        "z": "e5380aeea0a0d937",
        "g": "03d081761135f651",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 780,
        "y": 400,
        "wires": [
            [
                "28077011a9989235",
                "feaf5768f8fc3881"
            ]
        ]
    },
    {
        "id": "1ce1df4e1efae19d",
        "type": "switch",
        "z": "e5380aeea0a0d937",
        "g": "03d081761135f651",
        "name": "Export at max power",
        "property": "grid_power_has_limit_export",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 380,
        "y": 380,
        "wires": [
            [
                "b46223a8344215c5"
            ],
            [
                "7d834ce42b48c821"
            ]
        ]
    },
    {
        "id": "28077011a9989235",
        "type": "debug",
        "z": "e5380aeea0a0d937",
        "g": "03d081761135f651",
        "name": "Regulated",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload",
        "statusType": "auto",
        "x": 970,
        "y": 400,
        "wires": []
    },
    {
        "id": "eb2bd89f4a0af9e5",
        "type": "debug",
        "z": "e5380aeea0a0d937",
        "g": "03d081761135f651",
        "name": "Maximum",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 960,
        "y": 360,
        "wires": []
    },
    {
        "id": "7d834ce42b48c821",
        "type": "function",
        "z": "e5380aeea0a0d937",
        "g": "03d081761135f651",
        "name": "Regulated power",
        "func": "// Logger, usage: log(this, \"\");\nconst log = global.get('logger');\n\n// Which sub-strategy to use\nmsg.target = \"Self-consumption\";\n\n// Grid power limit\nconst targetGridPower = parseInt(msg.grid_power_limit_export);\n\n// Set target grid consumption for the PID controller\nmsg.house_target_grid_consumption_in_w = -targetGridPower; // negative, we are exporting to grid.\n// tell PID to avoid charge solutions during Selling.\nRED.util.setMessageProperty(msg,\"advanced_settings.charge_disabled\",true,true);\n\n// Finally\nlog(this, `**Regulated** discharging. Target grid power: ${Math.floor(targetGridPower)} W`);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 400,
        "wires": [
            [
                "295ec0e46565356b"
            ]
        ]
    },
    {
        "id": "e67c0ca1b08116d3",
        "type": "change",
        "z": "e5380aeea0a0d937",
        "g": "03d081761135f651",
        "name": "Continue",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "Charge",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 360,
        "wires": [
            [
                "eb2bd89f4a0af9e5",
                "feaf5768f8fc3881"
            ]
        ]
    },
    {
        "id": "a25eaea50ed4bff8",
        "type": "function",
        "z": "e5380aeea0a0d937",
        "g": "51f32d29cf4a4ed9",
        "name": "Min/max",
        "func": "\n// Lower bound\nlet output = msg.sell.threshold_energy | 0; // kWh\noutput = Math.max(output, 0);\n\n// Upper bound\nlet max_reserve = 0; // kWh\nmsg.batteries.forEach(battery => {\n    max_reserve += (Number(battery.energy_max*battery.soc_max) - Number(battery.energy_max*battery.soc_min))/100; // kWh\n});\noutput = Math.min(output, max_reserve);\n\nnode.status({fill:\"blue\",shape:\"dot\",text:`${output}`});\n\n// Output\nmsg.payload = output;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1720,
        "y": 200,
        "wires": [
            [
                "7e1303a962cc6a08"
            ]
        ]
    },
    {
        "id": "7e1303a962cc6a08",
        "type": "api-call-service",
        "z": "e5380aeea0a0d937",
        "g": "51f32d29cf4a4ed9",
        "name": "Set desired energy reserve",
        "server": "176d29a.6f648d6",
        "version": 7,
        "debugenabled": false,
        "action": "input_number.set_value",
        "floorId": [],
        "areaId": [],
        "deviceId": [],
        "entityId": [
            "input_number.house_battery_strategy_sell_target_energy"
        ],
        "labelId": [],
        "data": "{\"value\": $$.payload}",
        "dataType": "jsonata",
        "mergeContext": "",
        "mustacheAltTags": false,
        "outputProperties": [],
        "queue": "none",
        "blockInputOverrides": true,
        "domain": "input_number",
        "service": "set_value",
        "x": 1920,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "babf46924dd40b46",
        "type": "rbe",
        "z": "e5380aeea0a0d937",
        "g": "51f32d29cf4a4ed9",
        "name": "Desired energy changed",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 1530,
        "y": 200,
        "wires": [
            [
                "a25eaea50ed4bff8"
            ]
        ]
    },
    {
        "id": "b58909b73eabd1cc",
        "type": "api-current-state",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Goal",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_sell_goal",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.goal",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 450,
        "y": 180,
        "wires": [
            [
                "0ddf4686091e3749"
            ]
        ]
    },
    {
        "id": "0ddf4686091e3749",
        "type": "switch",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Sell until",
        "property": "sell.goal",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "batteries are empty",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "state of charge",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "energy reserve",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 4,
        "x": 580,
        "y": 180,
        "wires": [
            [
                "d36627e6d401df9a"
            ],
            [
                "38613f697830ae83"
            ],
            [
                "157d31fc5d9b8485"
            ],
            [
                "d3993759de73087e"
            ]
        ]
    },
    {
        "id": "d3993759de73087e",
        "type": "function",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Unknown -> Full stop",
        "func": "const log = global.get(\"logger\");\n\n// Unkown export goal\nlog(this, `**${msg.sell.goal}**; Sell goal not recognized. Fallback to **Full Stop**`,\"warn\");\n\n// Full stop\nmsg.target = \"Full stop\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 240,
        "wires": [
            [
                "7ac5101d1f08c0bf"
            ]
        ]
    },
    {
        "id": "f5c8c5d20289dddf",
        "type": "function",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Init",
        "func": "msg.sell = {};\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 180,
        "wires": [
            [
                "b58909b73eabd1cc"
            ]
        ]
    },
    {
        "id": "7ac5101d1f08c0bf",
        "type": "link call",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 940,
        "y": 240,
        "wires": [
            [
                "63eead100ac6b957"
            ]
        ]
    },
    {
        "id": "157d31fc5d9b8485",
        "type": "api-current-state",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Energy reserve low",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_sell_target_energy",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.threshold_energy",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 750,
        "y": 200,
        "wires": [
            [
                "22a0997a9304ddc3"
            ]
        ]
    },
    {
        "id": "f9332cd8e7997db2",
        "type": "link in",
        "z": "e5380aeea0a0d937",
        "g": "71d7999d1271aed6",
        "name": "link to End",
        "links": [
            "63eead100ac6b957",
            "f94ec7b8fe111d97",
            "feaf5768f8fc3881"
        ],
        "x": 75,
        "y": 580,
        "wires": [
            [
                "3465a104edeb1dde"
            ]
        ]
    },
    {
        "id": "63eead100ac6b957",
        "type": "link out",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "go to End",
        "mode": "link",
        "links": [
            "f9332cd8e7997db2"
        ],
        "x": 1140,
        "y": 240,
        "wires": [],
        "l": true
    },
    {
        "id": "38613f697830ae83",
        "type": "api-current-state",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "SoC low",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_number.house_battery_strategy_sell_target_soc",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "sell.threshold_soc",
                "propertyType": "msg",
                "value": "number",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 720,
        "y": 160,
        "wires": [
            [
                "e41b1cf3112176f5"
            ]
        ]
    },
    {
        "id": "22a0997a9304ddc3",
        "type": "function",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Check if low",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Sell until: ${msg.sell.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\nvar energy_threshold = Number(RED.util.getMessageProperty(msg,\"sell.threshold_energy\"));\nif (energy_threshold === undefined || energy_threshold < 0){\n    log(this,`Desired energy reserve not set correctly '${energy_threshold}' kWh`,\"warn\");\n    energy_threshold = 0;\n}\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining <= energy_threshold) {\n    msg.sell.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Energy reserve at ${energy_remaining.toFixed(1)} / ${energy_threshold.toFixed(1)} kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.sell.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.sell.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 200,
        "wires": [
            [
                "d6c4d8239497df03",
                "babf46924dd40b46"
            ]
        ]
    },
    {
        "id": "e41b1cf3112176f5",
        "type": "function",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Check if low",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this, `Sell until: ${msg.sell.goal}`);\n\n// 2. Extract average SoC and desired SoC level\nlet batteries = msg.batteries;\nlet soc_avg = 0;\nlet count = 0; // could use msg.battery_count\nbatteries.forEach(battery => {\n    soc_avg += battery.soc;\n    count++;\n});\n// 2a.  Current avg. SoC\nsoc_avg = Math.round(soc_avg / count * 100) / 100;\n// 2b.  Sell until SoC (12% as fallback)\nvar soc_threshold = Number(RED.util.getMessageProperty(msg,\"sell.threshold_soc\"));\nif (soc_threshold === undefined || soc_threshold < 12){\n    log(this, `Desired SoC not set correctly '${soc_threshold}' %. I've set it to 12%.`,\"warn\");\n    soc_threshold = 12;\n}\n\n// 3. Logic: Determine if SoC level is at or below desired level\nif (soc_avg <= msg.payload) {\n    msg.sell.threshold_reached = true;\n\n    // User friendly feedback via the custom logger\n    log(this, `[STOP] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n\n    // User friendly feedback via the custom logger\n    log(this, `[OK] Average SoC at ${soc_avg.toFixed(1)}/${soc_threshold.toFixed(1)} %.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({\n    fill: msg.sell.threshold_reached ? \"red\" : \"green\",\n    shape: \"dot\",\n    text: `Threshold reached: ${msg.sell.threshold_reached}`\n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 160,
        "wires": [
            [
                "d6c4d8239497df03"
            ]
        ]
    },
    {
        "id": "d36627e6d401df9a",
        "type": "change",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Batteries are empty",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 120,
        "wires": [
            [
                "7092b2fee88ebec3"
            ]
        ]
    },
    {
        "id": "7092b2fee88ebec3",
        "type": "function",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Check if empty",
        "func": "// 1. Get the custom logger from global context\nconst log = global.get(\"logger\");\nlog(this,`Sell until: ${msg.sell.goal}`);\n\n// 2. Extract energy level from msg (default to 0 if property is missing)\nconst energy_remaining = Number(RED.util.getMessageProperty(msg, \"batteries_available_energy\")) || 0;\n\n// 3. Logic: Determine if energy level is at or below zero\nif (energy_remaining <= 0) {\n    msg.sell.threshold_reached = true;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[STOP] All batteries are empty or at SoC_min_ (${energy_remaining} kWh).`, 'info');\n} else {\n    msg.sell.threshold_reached = false;\n    \n    // User friendly feedback via the custom logger\n    log(this, `[OK] Battery level ${energy_remaining.toFixed(2)} kWh above 0 kWh.`, 'info');\n}\n\n// 4. Update node status for visual feedback in the editor\nnode.status({ \n    fill: msg.sell.threshold_reached ? \"red\" : \"green\", \n    shape: \"dot\", \n    text: `Threshold reached: ${msg.sell.threshold_reached}` \n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 960,
        "y": 120,
        "wires": [
            [
                "d6c4d8239497df03"
            ]
        ]
    },
    {
        "id": "e5a58bff36b2f6d8",
        "type": "switch",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Until reached",
        "property": "sell.threshold_reached",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1290,
        "y": 160,
        "wires": [
            [
                "ded98aaf1bf3beda"
            ],
            [
                "d2878b099f97ea9e"
            ]
        ]
    },
    {
        "id": "ded98aaf1bf3beda",
        "type": "function",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Yes -> Full stop",
        "func": "\nmsg.target = \"Full stop\";\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1520,
        "y": 120,
        "wires": [
            [
                "92f7379770e40bfb"
            ]
        ]
    },
    {
        "id": "92f7379770e40bfb",
        "type": "link call",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Call flow",
        "links": [],
        "linkType": "dynamic",
        "timeout": "5",
        "x": 1680,
        "y": 120,
        "wires": [
            [
                "f94ec7b8fe111d97"
            ]
        ]
    },
    {
        "id": "f94ec7b8fe111d97",
        "type": "link out",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "go to End",
        "mode": "link",
        "links": [
            "f9332cd8e7997db2"
        ],
        "x": 1820,
        "y": 120,
        "wires": [],
        "l": true
    },
    {
        "id": "d6c4d8239497df03",
        "type": "function",
        "z": "e5380aeea0a0d937",
        "g": "531793f4dcaddf17",
        "name": "Decided",
        "func": "const log = global.get(\"logger\");\n\nif(msg.sell.threshold_reached){\n    log(this,`Stop discharging, Sell until ${msg.sell.goal} reached.`);\n} else {\n    log(this,`Continue discharging.`);\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1140,
        "y": 160,
        "wires": [
            [
                "e5a58bff36b2f6d8"
            ]
        ]
    },
    {
        "id": "feaf5768f8fc3881",
        "type": "link out",
        "z": "e5380aeea0a0d937",
        "g": "03d081761135f651",
        "name": "go to End",
        "mode": "link",
        "links": [
            "f9332cd8e7997db2"
        ],
        "x": 960,
        "y": 460,
        "wires": [],
        "l": true
    },
    {
        "id": "b3b54f6f1de3ab2e",
        "type": "catch",
        "z": "e5380aeea0a0d937",
        "g": "65dbab7712bef253",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 75,
        "y": 420,
        "wires": [
            [
                "a00fddd7f71bdb15"
            ]
        ],
        "l": false
    },
    {
        "id": "a00fddd7f71bdb15",
        "type": "function",
        "z": "e5380aeea0a0d937",
        "g": "65dbab7712bef253",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 125,
        "y": 420,
        "wires": [
            [
                "232b6b08cc01ceb2"
            ]
        ],
        "l": false
    },
    {
        "id": "232b6b08cc01ceb2",
        "type": "link out",
        "z": "e5380aeea0a0d937",
        "g": "65dbab7712bef253",
        "name": "link out 2",
        "mode": "return",
        "links": [],
        "x": 175,
        "y": 420,
        "wires": []
    },
    {
        "id": "eb45f65894eca2cd",
        "type": "link in",
        "z": "d94f748bb075b041",
        "g": "e1e54f5e31dcc6a0",
        "name": "Timed",
        "links": [],
        "x": 110,
        "y": 160,
        "wires": [
            [
                "0f4fd6a61567204a"
            ]
        ],
        "l": true
    },
    {
        "id": "42c667ca02221e8d",
        "type": "comment",
        "z": "d94f748bb075b041",
        "name": "Home Battery Strategy",
        "info": "The `Home Battery Start` flow will call this strategy flow\nby matching the strategy name with the Link In name.\n\nConfigure the Link In node in the Start group.\n\nDon't modify other parts of the Start and End groups.\nThey handle the calling and returning for you.",
        "x": 130,
        "y": 40,
        "wires": []
    },
    {
        "id": "fb71e68f41f12029",
        "type": "comment",
        "z": "d94f748bb075b041",
        "g": "e1e54f5e31dcc6a0",
        "name": "Start (readme)",
        "info": "# Setting up your battery strategy flow\n\n## Setup\nName the `Link In node` in this start group exactly after the <select> option configured in your\nselect_input.house_battery_strategy\n\nconfigure select options in:\ninput_select_house_battery_control.yaml\n\n### example\n`house_battery_strategy:\n  name: House Battery Strategy\n  options:\n    - AcmE example`\n\nThe above creates a select option, allowing user to select 'AcmE example'\n\nWhen selected, battery control will search for a flow containing a Link In node\ncalled 'AcmE example' (case sensitive).",
        "x": 120,
        "y": 120,
        "wires": []
    },
    {
        "id": "47f2868bc66c2ca5",
        "type": "link out",
        "z": "d94f748bb075b041",
        "g": "3e9791fa009db08f",
        "name": "Return",
        "mode": "return",
        "links": [],
        "x": 1255,
        "y": 520,
        "wires": []
    },
    {
        "id": "f2a3d144ebe49b18",
        "type": "comment",
        "z": "d94f748bb075b041",
        "g": "3e9791fa009db08f",
        "name": "End (readme)",
        "info": "Should return a solution_array of battery objects\n\n## battery object format\n`{{id: string|number, mode: string, power: number}} battery solution`\n- id is an arbitrary battery ID\n- mode is \"stop\", \"charge\", \"discharge\" for Marstek\n- power in Watts\n\n### example array\nreturn this type of solution_array via msg.solutions\n` \nlet solution_array = [];\nsolution_array.push({id:\"M1\", mode: \"charge\", power: 100}); // per battery\nreturn {solutions: solution_array};\n` ",
        "x": 1310,
        "y": 460,
        "wires": []
    },
    {
        "id": "1151fbed0c1b4a18",
        "type": "api-current-state",
        "z": "d94f748bb075b041",
        "g": "d5206a471af75f06",
        "name": "Period A start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_a1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_a1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 550,
        "y": 120,
        "wires": [
            [
                "3be5df1741acee6e"
            ]
        ]
    },
    {
        "id": "3be5df1741acee6e",
        "type": "api-current-state",
        "z": "d94f748bb075b041",
        "g": "d5206a471af75f06",
        "name": "Period A end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_a2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_a2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 120,
        "wires": [
            [
                "043e37f75a11c538"
            ]
        ]
    },
    {
        "id": "68889289c7f6bca0",
        "type": "api-current-state",
        "z": "d94f748bb075b041",
        "g": "50f2d09f93efb481",
        "name": "Period B start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_b1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_b1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 540,
        "y": 220,
        "wires": [
            [
                "ed312f1501d12e44"
            ]
        ]
    },
    {
        "id": "ed312f1501d12e44",
        "type": "api-current-state",
        "z": "d94f748bb075b041",
        "g": "50f2d09f93efb481",
        "name": "Period B end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_b2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_b2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 220,
        "wires": [
            [
                "b01b94bf13b13ccc"
            ]
        ]
    },
    {
        "id": "043e37f75a11c538",
        "type": "api-current-state",
        "z": "d94f748bb075b041",
        "g": "d5206a471af75f06",
        "name": "Strat during A",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_a",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_a",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 120,
        "wires": [
            [
                "0bf92830e23e120a"
            ]
        ]
    },
    {
        "id": "b01b94bf13b13ccc",
        "type": "api-current-state",
        "z": "d94f748bb075b041",
        "g": "50f2d09f93efb481",
        "name": "Strat during B",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_b",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_b",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 220,
        "wires": [
            [
                "057c08a4c016d542"
            ]
        ]
    },
    {
        "id": "0bf92830e23e120a",
        "type": "api-current-state",
        "z": "d94f748bb075b041",
        "g": "50f2d09f93efb481",
        "name": "Has period B",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_period_b",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_period_b",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 220,
        "wires": [
            [
                "68889289c7f6bca0"
            ]
        ]
    },
    {
        "id": "14b8e6dad219d9dd",
        "type": "inject",
        "z": "d94f748bb075b041",
        "name": "Test",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 330,
        "y": 40,
        "wires": [
            [
                "5ac70433035d79c5"
            ]
        ]
    },
    {
        "id": "7737135fcee1079f",
        "type": "change",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 460,
        "wires": [
            [
                "afcbfee8e8338976"
            ]
        ]
    },
    {
        "id": "33d96c71d5f20cb6",
        "type": "change",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "set Strat A",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_a",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 420,
        "wires": [
            [
                "224613699d210d88",
                "6b2947a47fb3c725"
            ]
        ]
    },
    {
        "id": "afcbfee8e8338976",
        "type": "switch",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "has period B",
        "property": "house_battery_strategy_timed_has_period_b",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 630,
        "y": 500,
        "wires": [
            [
                "224613699d210d88",
                "5b72472c33388326"
            ],
            [
                "ef468a6fea14c528"
            ]
        ]
    },
    {
        "id": "8a6e9561e07c446e",
        "type": "function",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "config A",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_a1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_a2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 440,
        "wires": [
            [
                "43ea5d3254d9a9c4"
            ]
        ]
    },
    {
        "id": "43ea5d3254d9a9c4",
        "type": "time-range-switch",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "Period A",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 440,
        "wires": [
            [
                "33d96c71d5f20cb6"
            ],
            [
                "7737135fcee1079f"
            ]
        ]
    },
    {
        "id": "ef468a6fea14c528",
        "type": "function",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "config B",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_b1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_b2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 580,
        "wires": [
            [
                "a2b7fd1edeeca9cd"
            ]
        ]
    },
    {
        "id": "a2b7fd1edeeca9cd",
        "type": "time-range-switch",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "Period B",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 580,
        "wires": [
            [
                "9aae173aa6fe1242"
            ],
            [
                "6f0286446a3c1bba"
            ]
        ]
    },
    {
        "id": "9aae173aa6fe1242",
        "type": "change",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "set Strat B",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_b",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 560,
        "wires": [
            [
                "224613699d210d88",
                "3b094766967dbf76"
            ]
        ]
    },
    {
        "id": "6f0286446a3c1bba",
        "type": "change",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 600,
        "wires": [
            [
                "f5dfd33cc0612c08"
            ]
        ]
    },
    {
        "id": "5ac70433035d79c5",
        "type": "api-current-state",
        "z": "d94f748bb075b041",
        "g": "a854c2216628bdbd",
        "name": "Default Strat",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_0",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_0",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 120,
        "wires": [
            [
                "1151fbed0c1b4a18"
            ]
        ]
    },
    {
        "id": "1ee83eb51f7ce1d7",
        "type": "link call",
        "z": "d94f748bb075b041",
        "g": "8dbc9a0b315e59e0",
        "name": "Sub strategy",
        "links": [],
        "linkType": "dynamic",
        "timeout": "30",
        "x": 1080,
        "y": 520,
        "wires": [
            [
                "47f2868bc66c2ca5"
            ]
        ]
    },
    {
        "id": "224613699d210d88",
        "type": "change",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "Select flow",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "timed_strategy",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 850,
        "y": 520,
        "wires": [
            [
                "1ee83eb51f7ce1d7",
                "a33a6e5a86948e26"
            ]
        ]
    },
    {
        "id": "6b2947a47fb3c725",
        "type": "debug",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "A",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 420,
        "wires": []
    },
    {
        "id": "5b72472c33388326",
        "type": "debug",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 460,
        "wires": []
    },
    {
        "id": "3b094766967dbf76",
        "type": "debug",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "B",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 560,
        "wires": []
    },
    {
        "id": "9926059727130518",
        "type": "debug",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 600,
        "wires": []
    },
    {
        "id": "a33a6e5a86948e26",
        "type": "debug",
        "z": "d94f748bb075b041",
        "g": "8dbc9a0b315e59e0",
        "name": "Target",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "target",
        "targetType": "msg",
        "statusVal": "target",
        "statusType": "auto",
        "x": 1060,
        "y": 460,
        "wires": []
    },
    {
        "id": "cf9d75fee58f577b",
        "type": "api-current-state",
        "z": "d94f748bb075b041",
        "g": "842a5287fb86754d",
        "name": "Period C start",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_c1",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_c1",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 540,
        "y": 320,
        "wires": [
            [
                "8614d1f09fb7bf59"
            ]
        ]
    },
    {
        "id": "8614d1f09fb7bf59",
        "type": "api-current-state",
        "z": "d94f748bb075b041",
        "g": "842a5287fb86754d",
        "name": "Period C end",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_datetime.house_battery_strategy_timed_period_c2",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_period_c2",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 710,
        "y": 320,
        "wires": [
            [
                "5480f0eac3bd0af4"
            ]
        ]
    },
    {
        "id": "5480f0eac3bd0af4",
        "type": "api-current-state",
        "z": "d94f748bb075b041",
        "g": "842a5287fb86754d",
        "name": "Strat during C",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_select.house_battery_strategy_timed_strat_c",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_strat_c",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 880,
        "y": 320,
        "wires": [
            [
                "8a6e9561e07c446e"
            ]
        ]
    },
    {
        "id": "057c08a4c016d542",
        "type": "api-current-state",
        "z": "d94f748bb075b041",
        "g": "842a5287fb86754d",
        "name": "Has period C",
        "server": "176d29a.6f648d6",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "input_boolean.house_battery_strategy_timed_has_period_c",
        "state_type": "str",
        "blockInputOverrides": true,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            },
            {
                "property": "data",
                "propertyType": "msg",
                "value": "",
                "valueType": "entity"
            },
            {
                "property": "house_battery_strategy_timed_has_period_c",
                "propertyType": "msg",
                "value": "string",
                "valueType": "entityState"
            }
        ],
        "for": "0",
        "forType": "num",
        "forUnits": "minutes",
        "override_topic": false,
        "state_location": "payload",
        "override_payload": "msg",
        "entity_location": "data",
        "override_data": "msg",
        "x": 350,
        "y": 320,
        "wires": [
            [
                "cf9d75fee58f577b"
            ]
        ]
    },
    {
        "id": "f5dfd33cc0612c08",
        "type": "switch",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "has period C",
        "property": "house_battery_strategy_timed_has_period_c",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 630,
        "y": 640,
        "wires": [
            [
                "224613699d210d88",
                "9926059727130518"
            ],
            [
                "874326be07679319"
            ]
        ]
    },
    {
        "id": "0a80c240776e0186",
        "type": "debug",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "C",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 700,
        "wires": []
    },
    {
        "id": "874326be07679319",
        "type": "function",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "config C",
        "func": "msg.__config = {\n    startTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_c1'),\n    endTime: RED.util.getMessageProperty(msg,'house_battery_strategy_timed_period_c2'),\n    startOffset: 0,\n    endOffset: 0\n}\n  \nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 720,
        "wires": [
            [
                "465595e1b1f57fd1"
            ]
        ]
    },
    {
        "id": "465595e1b1f57fd1",
        "type": "time-range-switch",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "Period C",
        "lat": "",
        "lon": "",
        "startTime": "00:00",
        "endTime": "00:00",
        "startOffset": 0,
        "endOffset": 0,
        "x": 480,
        "y": 720,
        "wires": [
            [
                "759d2b775f999de6"
            ],
            [
                "1d38b023309c3923"
            ]
        ]
    },
    {
        "id": "759d2b775f999de6",
        "type": "change",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "set Strat C",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_c",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 700,
        "wires": [
            [
                "0a80c240776e0186",
                "224613699d210d88"
            ]
        ]
    },
    {
        "id": "1d38b023309c3923",
        "type": "change",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "set Strat 0",
        "rules": [
            {
                "t": "set",
                "p": "timed_strategy",
                "pt": "msg",
                "to": "house_battery_strategy_timed_strat_0",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 630,
        "y": 740,
        "wires": [
            [
                "224613699d210d88",
                "90fc2601f13048f5"
            ]
        ]
    },
    {
        "id": "90fc2601f13048f5",
        "type": "debug",
        "z": "d94f748bb075b041",
        "g": "c54b7183164e398c",
        "name": "0",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": true,
        "complete": "strategy",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "counter",
        "x": 830,
        "y": 740,
        "wires": []
    },
    {
        "id": "0f4fd6a61567204a",
        "type": "change",
        "z": "d94f748bb075b041",
        "g": "e1e54f5e31dcc6a0",
        "name": "Trace",
        "rules": [
            {
                "t": "set",
                "p": "strategy.trace",
                "pt": "msg",
                "to": "[\t   strategy.trace,\t   {\t       \"flow\": target,\t       \"flow_settings\": advanced_settings,\t       \"timestamp\": $now()\t   } \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 110,
        "y": 200,
        "wires": [
            [
                "5ac70433035d79c5"
            ]
        ],
        "info": "Attaches a breadcrumb trace to the msg\r\nso the user can reconstruct which route has\r\nbeen traveled"
    },
    {
        "id": "a5574df615b77760",
        "type": "catch",
        "z": "d94f748bb075b041",
        "g": "28bfa5e6aeaacd4f",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 65,
        "y": 320,
        "wires": [
            [
                "7e682df4ecbf618c"
            ]
        ],
        "l": false
    },
    {
        "id": "7e682df4ecbf618c",
        "type": "function",
        "z": "d94f748bb075b041",
        "g": "28bfa5e6aeaacd4f",
        "name": "Unhandled Exception",
        "func": "const handle = global.get('unhandledException');\n\nhandle(this);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 115,
        "y": 320,
        "wires": [
            [
                "fc2e7d2633fd4085"
            ]
        ],
        "l": false
    },
    {
        "id": "fc2e7d2633fd4085",
        "type": "link out",
        "z": "d94f748bb075b041",
        "g": "28bfa5e6aeaacd4f",
        "name": "link out 8",
        "mode": "return",
        "links": [],
        "x": 165,
        "y": 320,
        "wires": []
    },
    {
        "id": "08a71e47078f15f6",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-home-assistant-websocket": "0.80.3",
            "node-red-node-smooth": "0.1.2",
            "node-red-contrib-time-range-switch": "1.2.0"
        }
    }
]